<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beekeeping Simulator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        #app-container {
            background-color: #f8f9fa; /* Bootstrap light gray */
        }

        #game-header {
            background-color: #ffffff;
            flex-shrink: 0; 
            transition: border-bottom-color 0.5s ease-in-out;
        }
        
        #game-title {
            color: #0d6efd; 
        }

        #main-interface-area {
            flex-grow: 1; 
            overflow: hidden; 
        }

        #sidebar-nav {
            overflow-y: auto; 
            height: 100%; 
            background-color: #ffffff; /* Ensure sidebar matches content pane bg */
        }

        #content-pane {
            overflow-y: auto; 
            scroll-behavior: smooth;
            height: 100%; 
            background-color: #ffffff;
        }
        
        #game-footer {
            flex-shrink: 0; 
            background-color: #ffffff;
        }

        #sidebar-nav .nav-link {
            color: #343a40; 
            padding: 0.6rem 1rem;
            font-weight: 500;
            border-radius: 0.3rem;
        }

        #sidebar-nav .nav-link.active {
            background-color: var(--bs-primary);
            color: white;
        }

        #sidebar-nav .nav-link:hover {
            background-color: #e9ecef; /* Bootstrap lighter gray for hover */
            color: #0d6efd;
        }

        #sidebar-nav .nav-link img,
        #sidebar-nav .nav-link .bi { 
            opacity: 0.7; /* Slightly more visible icons */
            transition: opacity 0.2s ease-in-out;
            margin-right: 0.5em;
            width: 1.1em; 
            height: 1.1em; 
            vertical-align: text-bottom;
        }

        #sidebar-nav .nav-link.active img,
        #sidebar-nav .nav-link:hover img,
        #sidebar-nav .nav-link.active .bi,
        #sidebar-nav .nav-link:hover .bi {
            opacity: 1;
        }
        
        #dynamic-hive-nav-list .nav-link {
            font-size: 0.9em;
            padding: 0.4rem 1rem;
        }
        
        .card-header {
            background-color: #f8f9fa; /* Bootstrap light gray */
        }

        .progress {
            height: 1rem;
            font-size: 0.75rem;
        }
        
        .stat-value {
            font-weight: bold;
            color: var(--bs-primary);
        }
        .stat-value-unknown {
            font-weight: normal;
            color: var(--bs-secondary-text); /* Bootstrap secondary text */
            font-style: italic;
        }

        .hive-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .hive-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.10)!important;
        }

        .action-btn-sm {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        .guide-image {
            max-width: 100%;
            height: auto;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .almanac-cover {
            max-height: 250px;
            object-fit: cover;
            width: 100%;
            border-radius: .25rem;
            margin-bottom: 1.5rem;
        }
        .toast-container {
            z-index: 1100; 
        }
        .bi { 
            vertical-align: -0.125em; 
        }
        .btn .bi {
             vertical-align: text-bottom;
        }
        #pause-button .bi-play-fill, #pause-button .bi-pause-fill {
            font-size: 1.1em; 
        }
        .journal-list {
            max-height: 60vh; 
            overflow-y: auto;
        }
        #game-header.header-spring { border-bottom: 3px solid #28a745 !important; }
        #game-header.header-summer { border-bottom: 3px solid #ffc107 !important; }
        #game-header.header-autumn { border-bottom: 3px solid #fd7e14 !important; }
        #game-header.header-winter { border-bottom: 3px solid #0dcaf0 !important; }

        .frame-slot {
            border: 1px solid var(--bs-border-color); /* Bootstrap border color */
            min-height: 90px; /* Slightly taller for better spacing */
            font-size: 0.75rem; /* Smaller text for more info */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.3rem;
            border-radius: 0.25rem;
        }
        .frame-slot .bi { font-size: 1.75rem; margin-bottom: 0.25rem;} /* Larger icons */
        .frame-slot-foundation { background-color: var(--bs-tertiary-bg); } /* Bootstrap tertiary bg */
        .frame-slot-drawn_comb { background-color: var(--bs-warning-bg-subtle); } /* Bootstrap warning subtle */
        .frame-slot-eggs { background-color: #ffffff; border: 1px dashed var(--bs-secondary-border-subtle); }
        .frame-slot-larvae { background-color: var(--bs-info-bg-subtle); } 
        .frame-slot-pupae { background-color: var(--bs-secondary-bg); } /* Bootstrap secondary bg */
        .frame-slot-honey { background-color: var(--bs-warning-bg-subtle); } /* Bootstrap warning subtle */
        .frame-slot-pollen { background-color: var(--bs-primary-bg-subtle); } /* Bootstrap primary subtle */
        .frame-slot-capped .bi-shield-shaded { color: #8B4513; } /* SaddleBrown for capped honey/brood */
        .frame-coverage-bar-container {
            width: 90%;
            height: 8px; /* Slightly thicker bar */
            background-color: var(--bs-gray-300);
            border-radius: 4px;
            margin-top: 4px;
            overflow: hidden; /* Ensure fill stays within bounds */
        }
        .frame-coverage-fill {
            height: 100%;
            background-color: var(--bs-success); /* Bootstrap success color */
            border-radius: 4px 0 0 4px; /* Match container radius */
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body>
    <div id="app-container" class="container-fluid d-flex flex-column min-vh-100 p-0">

        <header id="game-header" class="py-3 px-4 bg-white border-bottom shadow-sm">
            <div class="d-flex justify-content-between align-items-center">
                <h1 id="game-title" class="h2 mb-0">Beekeeping Simulator</h1>
                <div id="game-status-bar" class="text-center mx-3">
                    <div><span id="beekeeper-name-display" class="fw-bold">My Apiary</span></div>
                    <div>Date: <span id="game-date" class="fw-bold">Spring, Year 1, Day 1</span></div>
                    <div>Money: <span id="player-money" class="fw-bold text-success">$250.00</span></div>
                    <div>Apiary Health: <span id="apiary-health-status" class="fw-bold">Good</span></div>
                </div>
                <div class="text-end">
                    <button id="next-day-button" class="btn btn-primary btn-sm me-2" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Advance to the next day"><i class="bi bi-caret-right-fill"></i> Advance Day</button>
                    <button id="pause-button" class="btn btn-secondary btn-sm me-2" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Pause Game"><i class="bi bi-pause-fill"></i> Pause</button>
                    <button id="settings-button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#settingsModal" data-bs-tooltip="tooltip" data-bs-placement="bottom" title="Game Settings">
                        <img src="/generated_images/dalle_3fcb1131-10c.png" alt="Settings Icon" style="width: 1.2em; height: 1.2em; vertical-align: middle;">
                    </button>
                </div>
            </div>
        </header>

        <div id="main-interface-area" class="flex-grow-1 d-flex p-3">
            <nav id="sidebar-nav" class="col-lg-2 col-md-3 p-3 border rounded shadow-sm me-3">
                <ul class="nav nav-pills flex-column">
                    <li class="nav-item mb-2"><a class="nav-link active" id="nav-apiary-overview" href="#"><img src="/generated_images/dalle_1b6fffb3-faa.png" alt="Apiary Icon">Apiary Overview</a></li>
                    <li class="nav-item mb-2"><a class="nav-link" id="nav-market" href="#"><img src="/generated_images/dalle_4fbd6488-32b.png" alt="Market Icon">Market</a></li>
                    <li class="nav-item mb-2"><a class="nav-link" id="nav-research" href="#"><img src="/generated_images/dalle_24279f93-1c0.png" alt="Research Icon">Knowledge</a></li>
                    <li class="nav-item mb-2"><a class="nav-link" id="nav-guide" href="#"><img src="/generated_images/dalle_034e8bdf-261.png" alt="Guide Icon">Beekeeper's Almanac</a></li>
                    <li class="nav-item mb-2"><a class="nav-link" id="nav-journal" href="#"><i class="bi bi-book"></i>Beekeeper's Journal</a></li>
                </ul>
                <hr>
                <div id="hive-list-nav" class="mt-3">
                    <h6 class="text-muted">My Hives:</h6>
                    <ul class="nav nav-pills flex-column" id="dynamic-hive-nav-list">
                    </ul>
                </div>
                 <hr>
                <div id="inventory-display" class="mt-3">
                    <h6 class="text-muted">Inventory:</h6>
                    <small id="inventory-list" class="d-block"></small>
                </div>
            </nav>

            <main id="content-pane" class="col-lg-10 col-md-9 p-4 border rounded shadow-sm">
            </main>
        </div>

        <footer id="game-footer" class="py-2 px-4 border-top text-center">
            <small class="text-muted">Beekeeping Simulator v<span id="game-version-display">0.2.0</span> | Current Season: <span id="footer-season">Spring</span> | Weather: <span id="footer-weather">Sunny</span></small>
        </footer>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="settingsModalLabel">Settings</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body">
            <div class="mb-3">
                <label for="beekeeperNameInputModal" class="form-label">Beekeeper/Apiary Name:</label>
                <input type="text" class="form-control" id="beekeeperNameInputModal" value="My Apiary" maxlength="25">
            </div>
            <button type="button" class="btn btn-danger" id="resetGameButtonModal"><i class="bi bi-exclamation-triangle-fill"></i> Reset Game Data</button>
            <small class="d-block mt-1 text-muted">This will erase all progress and start a new game.</small>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-primary" id="saveSettingsButtonModal"><i class="bi bi-save"></i> Save Settings</button></div>
    </div></div></div>

    <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="eventModalLabel">Event!</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body" id="eventModalBody"></div>
        <div class="modal-footer" id="eventModalFooter"></div>
    </div></div></div>

    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="confirmationModalLabel">Confirm Action</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body" id="confirmationModalBody"></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="confirmationCancelBtn">Cancel</button><button type="button" class="btn btn-primary" id="confirmationConfirmBtn">Confirm</button></div>
    </div></div></div>

    <div class="modal fade" id="guideDetailModal" tabindex="-1" aria-labelledby="guideDetailModalLabel" aria-hidden="true"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="guideDetailModalLabel">Guide Entry</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body" id="guideDetailModalBody"></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
    </div></div></div>
    
    <div class="modal fade" id="installColonyModal" tabindex="-1" aria-labelledby="installColonyModalLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="installColonyModalLabel">Install Colony</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body">
            <p>Select a colony type to install into this empty hive:</p>
            <div id="installColonyOptionsContainer"></div>
            <p id="installColonyNoOptions" class="text-danger d-none">You don't have any bee packages or nucs in your inventory.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="confirmInstallColonyBtn">Confirm Installation</button>
        </div>
    </div></div></div>

    <div class="modal fade" id="hiveSplitModal" tabindex="-1" aria-labelledby="hiveSplitModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="hiveSplitModalLabel">Split Hive - Select Frames</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body">
            <p>Select 3-5 frames from <strong id="splitSourceHiveName"></strong> to move to a new hive body. Ensure you include brood (eggs/larvae) and food (honey/pollen).</p>
            <div id="hiveSplitFrameSelection" class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-2 mb-3"></div>
            <p class="text-muted"><small>The new hive will initially be queenless. If selected frames include eggs or young larvae, they may attempt to raise a new queen. The original queen remains in the source hive.</small></p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="confirmHiveSplitBtn">Confirm Split</button>
        </div>
    </div></div></div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="gameToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto" id="toastTitle">Notification</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastBody">
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    (function() {
        'use strict';

        const GAME_VERSION = "0.2.1"; 
        const SEASONS = { SPRING: "Spring", SUMMER: "Summer", AUTUMN: "Autumn", WINTER: "Winter" };
        const WEATHER_TYPES = ["Sunny", "Cloudy", "Rainy", "Windy", "Cold Snap", "Heatwave"];
        const INITIAL_MONEY = 300; 
        const MAX_HIVE_NAME_LENGTH = 25;
        const VARROA_GROWTH_RATE = 0.05; 
        const VARROA_TREATMENT_EFFECTIVENESS = 0.8; 
        const INSPECTION_VALIDITY_DAYS = 5;
        const NUC_FRAME_COUNT = 4;
        const FRAMES_PER_HIVE = 10;
        const FRAME_DRAW_RATE_PER_BEE_DAY = 0.001; 
        const EGG_TO_LARVA_DAYS = 3;
        const LARVA_TO_PUPA_DAYS = 6;
        const PUPA_TO_ADULT_DAYS = 12;
        const FRAME_CAPACITY_KG = 2.5; 


        let gameState; 
        
        let settingsModalInstance, eventModalInstance, confirmationModalInstance, guideDetailModalInstance, gameToastInstance, installColonyModalInstance, hiveSplitModalInstance;

        const DOM = {
            contentPane: document.getElementById('content-pane'),
            beekeeperNameDisplay: document.getElementById('beekeeper-name-display'),
            gameDateDisplay: document.getElementById('game-date'),
            playerMoneyDisplay: document.getElementById('player-money'),
            apiaryHealthDisplay: document.getElementById('apiary-health-status'),
            footerSeasonDisplay: document.getElementById('footer-season'),
            footerWeatherDisplay: document.getElementById('footer-weather'),
            dynamicHiveNavList: document.getElementById('dynamic-hive-nav-list'),
            inventoryList: document.getElementById('inventory-list'),
            pauseButton: document.getElementById('pause-button'),
            pauseButtonIcon: document.querySelector('#pause-button .bi'),
            nextDayButton: document.getElementById('next-day-button'),
            settingsModal: {
                beekeeperNameInput: document.getElementById('beekeeperNameInputModal'),
                saveButton: document.getElementById('saveSettingsButtonModal'),
                resetButton: document.getElementById('resetGameButtonModal')
            },
            eventModal: {
                title: document.getElementById('eventModalLabel'),
                body: document.getElementById('eventModalBody'),
                footer: document.getElementById('eventModalFooter')
            },
            confirmationModal: {
                title: document.getElementById('confirmationModalLabel'),
                body: document.getElementById('confirmationModalBody'),
                confirmButton: document.getElementById('confirmationConfirmBtn')
            },
            guideDetailModal: {
                title: document.getElementById('guideDetailModalLabel'),
                body: document.getElementById('guideDetailModalBody')
            },
            installColonyModal: {
                optionsContainer: document.getElementById('installColonyOptionsContainer'),
                noOptionsText: document.getElementById('installColonyNoOptions'),
                confirmButton: document.getElementById('confirmInstallColonyBtn')
            },
            hiveSplitModal: {
                sourceHiveName: document.getElementById('splitSourceHiveName'),
                frameSelectionContainer: document.getElementById('hiveSplitFrameSelection'),
                confirmButton: document.getElementById('confirmHiveSplitBtn')
            },
            toast: {
                title: document.getElementById('toastTitle'),
                body: document.getElementById('toastBody'),
            },
            gameVersionDisplay: document.getElementById('game-version-display')
        };
        
        const GameData = {
            guideContent: [
                { id: "welcome", title: "Welcome to Beekeeping!", shortDesc: "An introduction to your apiary.", 
                  fullContentHTML: `
                    <img src="/generated_images/dalle_9e83b2a9-3d9.png" alt="Apiary in a sunny meadow" class="img-fluid rounded mb-3 almanac-cover">
                    <h4>Welcome, Beekeeper!</h4>
                    <p>This almanac is your guide to the fascinating world of bees and the art of beekeeping. Here, you'll find information on bee biology, hive management, common challenges, and how the simulation mirrors real-life beekeeping practices.</p>
                    <p>Your journey begins with a small apiary. Your goal is to nurture your colonies, help them thrive through the seasons, harvest valuable products, and expand your operation. Pay close attention to your bees' needs, the changing weather, and potential threats like pests and diseases.</p>
                    <p>Use the navigation on the left to explore different aspects of the game. Good luck!</p>` 
                },
                { id: "bee_types", title: "Bee Types & Roles", shortDesc: "Queen, Worker, Drone.", 
                  fullContentHTML: `<h4>Bee Types & Roles</h4>
                    <p>A honey bee colony is a complex society with specialized roles for each type of bee.</p>
                    <h5>Queen Bee</h5>
                    <img src="/generated_images/dalle_4d02bfd9-1a0.png" alt="Queen Bee illustration" class="guide-image" style="max-width:300px;">
                    <p>The queen is the heart of the colony. Her primary role is to lay eggs, ensuring the continuation of the hive. A healthy queen can lay thousands of eggs per day during peak season. She also produces pheromones that regulate colony cohesion and behavior. In this simulation, queen health and age affect her laying rate.</p>
                    <h5>Worker Bee</h5>
                    <img src="/generated_images/dalle_0ae3380b-d92.png" alt="Worker Bee illustration" class="guide-image" style="max-width:300px;">
                    <p>Worker bees are sterile females and make up the vast majority of the colony. They perform all the tasks necessary for hive survival, including: cleaning cells, feeding larvae (nurse bees), building wax comb, guarding the hive entrance, and foraging for nectar, pollen, water, and propolis. Their roles change as they age. Foragers are crucial for resource gathering in the game.</p>
                    <h5>Drone Bee</h5>
                    <img src="/generated_images/dalle_1d178691-0dc.png" alt="Drone Bee illustration" class="guide-image" style="max-width:300px;">
                    <p>Drones are male bees. Their sole purpose is to mate with a virgin queen. They do not forage, build comb, or defend the hive. Drones are produced in spring and summer and are often expelled from the hive in autumn to conserve resources. In the game, drone population has a minor impact on queen mating success (an abstracted concept for now).</p>` 
                },
                { id: "hive_inspections", title: "Hive Inspections", shortDesc: "What to look for.", 
                  fullContentHTML: `<h4>Hive Inspections</h4>
                    <p>Regular hive inspections are crucial for monitoring colony health, population, resources, and identifying problems early. In this simulation, hive data becomes 'stale' after ${INSPECTION_VALIDITY_DAYS} days. Performing an inspection updates the data to real-time values but slightly stresses the colony.</p>
                    <h5>What to Look For:</h5>
                    <ul>
                        <li><strong>Queen Presence:</strong> Spotting the queen, or evidence of her (freshly laid eggs), confirms she is alive and laying.</li>
                        <li><strong>Brood Pattern:</strong> A healthy queen lays eggs in a compact, solid pattern on frames. Scattered brood can indicate problems.
                           <img src="/generated_images/dalle_2a85bba6-439.png" alt="Healthy Brood comb section" class="guide-image" style="max-width:400px;"></li>
                        <li><strong>Population Size:</strong> Estimate the number of bees covering the frames.</li>
                        <li><strong>Food Stores:</strong> Check levels of honey and pollen on frames. Bees need adequate food, especially heading into winter or during nectar dearths.</li>
                        <li><strong>Pests & Diseases:</strong> Look for signs of Varroa mites, Small Hive Beetles, Wax Moths, or symptoms of diseases like American Foulbrood or Chalkbrood.</li>
                        <li><strong>Swarm Cells:</strong> Presence of queen cells (swarm cells or supersedure cells) indicates the colony might be preparing to swarm or replace their queen.</li>
                    </ul>`
                },
                { id: "pests_diseases", title: "Common Pests & Diseases", shortDesc: "Identifying and managing threats.", 
                  fullContentHTML: `<h4>Common Pests & Diseases</h4>
                    <p>Honey bee colonies are susceptible to various pests and diseases that can weaken or destroy them if not managed.</p>
                    <h5>Varroa Mites (<em>Varroa destructor</em>)</h5>
                    <img src="/generated_images/dalle_83639747-1d2.png" alt="Varroa Mite on a bee" class="guide-image" style="max-width:300px;">
                    <p>Varroa mites are external parasites that feed on adult bees and developing brood. They transmit viruses and weaken the colony. High mite levels are a primary cause of colony losses. Regular monitoring and treatment are essential. In the game, Varroa levels increase over time and impact hive health.</p>
                    <h5>American Foulbrood (AFB)</h5>
                    <img src="/generated_images/dalle_04593238-fd5.png" alt="Comb section affected by American Foulbrood" class="guide-image" style="max-width:400px;">
                    <p>AFB is a highly contagious and destructive bacterial disease affecting bee larvae. Symptoms include sunken, perforated cappings and a "ropy" larval remnant. There is no cure; infected colonies and equipment usually must be destroyed by burning to prevent spread. This is a serious threat in the simulation.</p>
                    <h5>Chalkbrood</h5>
                    <img src="/generated_images/dalle_eea9b54c-2a0.png" alt="Chalkbrood mummies in comb cells" class="guide-image" style="max-width:400px;">
                    <p>Chalkbrood is a fungal disease that affects larvae, causing them to become hard, chalk-like mummies. It's often stress-related and typically less devastating than AFB but can weaken colonies. Good ventilation and strong colonies help prevent it.</p>
                    <h5>Small Hive Beetle (SHB)</h5>
                    <img src="/generated_images/dalle_82085711-4ff.png" alt="Small Hive Beetle adult" class="guide-image" style="max-width:300px;">
                    <p>SHB are pests that can damage comb, honey, and pollen. Larvae burrow through comb, and adults can cause honey to ferment. Strong colonies can usually manage small beetle populations, but weak hives are vulnerable. Traps can help control them.</p>
                    <h5>Wax Moths</h5>
                    <img src="/generated_images/dalle_6fdb66d6-83d.png" alt="Wax Moth larvae damage on comb" class="guide-image" style="max-width:400px;">
                    <p>Wax moths infest hives, particularly weak ones or stored comb. Larvae tunnel through comb, consuming wax, pollen, and honey, leaving behind webbing and debris. Strong colonies and proper storage of equipment are key preventatives.</p>`
                },
                 { id: "sim_vs_reality", title: "Simulation vs. Reality", shortDesc: "How the game models beekeeping.", 
                  fullContentHTML: `<h4>Simulation vs. Reality</h4>
                    <p>This Beekeeping Simulator aims to capture many core aspects of real-world beekeeping, but it is, by necessity, a simplification. Here's how some game mechanics relate to reality:</p>
                    <ul>
                        <li><strong>Time & Seasons:</strong> The game progresses day by day, with distinct seasons. Real beekeeping is heavily influenced by seasonal changes in weather, forage availability, and bee behavior. The simulation models this by adjusting parameters like nectar flow, queen laying rates, and pest activity based on the season.</li>
                        <li><strong>Hive Population Dynamics:</strong> Worker bee populations rise and fall based on the queen's egg-laying, brood development time on frames, and bee lifespan. This mirrors the natural colony cycle. Forager numbers directly impact resource collection.</li>
                        <li><strong>Resource Management:</strong> Bees collect nectar (converted to honey) and pollen, storing them on frames. The game requires you to monitor these stores, especially for winter survival, similar to a real beekeeper. Feeding might be necessary.</li>
                        <li><strong>Pest & Disease Management:</strong> Varroa mites, AFB, etc., are simulated threats. The game allows for treatments, which have effectiveness rates and costs, reflecting real-world decisions beekeepers make. Early detection and intervention are key in both the game and reality.</li>
                        <li><strong>Inspections:</strong> Performing inspections in the game gives you vital, up-to-date information, similar to opening a real hive. Without inspections, data becomes 'stale'. Inspections cause minor stress.</li>
                        <li><strong>Market & Economics:</strong> Buying equipment (like empty hive bodies, bee packages, nucs) and selling honey/products reflects the economic side of beekeeping. Prices may fluctuate.</li>
                        <li><strong>Frame Management:</strong> Hives consist of frames. Bees draw foundation, store resources, and raise brood on these frames. This is a core part of hive management.</li>
                        <li><strong>Hive Splitting:</strong> Strong colonies can be split by moving frames to a new hive body, a common beekeeping practice for expansion or swarm prevention.</li>
                        <li><strong>Abstractions:</strong> Many complex biological processes (e.g., bee communication, detailed genetics, precise nutritional values of pollen) are abstracted for gameplay. For example, "forage quality" might be a single variable instead of modeling hundreds of plant types.</li>
                    </ul>
                    <p>The goal is to provide an engaging and educational experience that highlights the challenges and rewards of beekeeping. While not every detail can be perfectly replicated, the core principles of colony health, resource management, and seasonal awareness are central to the simulation.</p>`
                },
            ],
            marketItems: [
                { id: "sugar", name: "Sugar (1kg)", type: "supply", buyPrice: 2, sellPrice: null, description: "For making sugar syrup to feed bees." },
                { id: "pollen_patty", name: "Pollen Patty", type: "supply", buyPrice: 5, sellPrice: null, description: "Provides protein supplement for brood rearing." },
                { id: "varroa_treatment_basic", name: "Basic Varroa Treatment", type: "treatment", buyPrice: 15, sellPrice: null, description: "A standard treatment for Varroa mites." },
                { id: "hive_body", name: "New Hive Body (Empty + Foundation)", type: "equipment", buyPrice: 50, sellPrice: 10, description: "Woodenware and 10 frames with foundation. Bees not included." },
                { id: "bee_package", name: "Bee Package (3lb + Queen)", type: "livestock", buyPrice: 120, sellPrice: null, description: "Approx. 10,000 bees and a mated queen. Needs an empty hive." },
                { id: "nuc_colony", name: "Nuc Colony (4 Frames + Queen)", type: "livestock", buyPrice: 180, sellPrice: null, description: "Established small colony with queen, brood, and food on 4 drawn frames. Needs an empty hive." },
                { id: "raw_honey", name: "Raw Honey (1kg)", type: "product", buyPrice: null, sellPriceBase: 8, description: "Unprocessed honey from your hives." },
                { id: "beeswax", name: "Beeswax (100g)", type: "product", buyPrice: null, sellPriceBase: 3, description: "Rendered beeswax." }
            ],
            researchNodes: [
                { id: "basic_beekeeping", name: "Basic Beekeeping", cost: 0, description: "Fundamental knowledge of bee care.", unlocked: true, effects: {} },
                { id: "varroa_monitoring", name: "Varroa Monitoring", cost: 50, prereq: "basic_beekeeping", description: "Learn to identify and count Varroa mites.", unlocked: false, effects: { varroaDetectionChance: 0.1 } },
                { id: "advanced_feeding", name: "Advanced Feeding Strategies", cost: 75, prereq: "basic_beekeeping", description: "Understand optimal feeding times and ratios.", unlocked: false, effects: { feedingEffectiveness: 0.15 } },
                { id: "integrated_pest_management", name: "Integrated Pest Management", cost: 150, prereq: "varroa_monitoring", description: "Holistic approaches to pest control.", unlocked: false, effects: { treatmentCostReduction: 0.1 } }
            ],
            eventDefinitions: [
                { 
                    id: "good_forage", 
                    title: "Excellent Foraging Conditions!", 
                    text: "The weather has been perfect and local flora is booming. Your bees are bringing in extra nectar!",
                    type: "positive",
                    condition: (gs) => gs.currentSeason !== SEASONS.WINTER && Math.random() < 0.05,
                    effect: (gs) => {
                        gs.hives.forEach(hive => {
                            if (hive.population.foragers > 0 && !hive.isEmptyHiveBody) {
                                const bonusNectarKg = Math.floor(Math.random() * 1 + 0.5); 
                                hive.addResourceToFrames('nectar', bonusNectarKg);
                            }
                        });
                        UIManager.showToast("Bumper Harvest!", "Your bees found abundant nectar today.");
                        JournalManager.addEntry(`Excellent foraging conditions boosted nectar collection.`);
                    },
                    choices: [{ text: "Wonderful!", action: null }]
                },
                {
                    id: "mild_varroa_increase",
                    title: "Varroa Mite Activity",
                    text: "Routine checks suggest a slight increase in Varroa mite populations in some hives. Consider monitoring closely or treating if levels get high.",
                    type: "neutral",
                    condition: (gs) => gs.hives.some(h => !h.isEmptyHiveBody && h.health.varroaMites > 100 && h.health.varroaMites < 500) && Math.random() < 0.1,
                    effect: null,
                    choices: [{ text: "Noted.", action: null }]
                },
                {
                    id: "pesticide_incident_nearby",
                    title: "Pesticide Concern",
                    text: "Reports indicate pesticide spraying occurred in a nearby agricultural area. This might affect your foragers.",
                    type: "negative",
                    condition: (gs) => (gs.currentSeason === SEASONS.SPRING || gs.currentSeason === SEASONS.SUMMER) && Math.random() < 0.03,
                    effect: (gs) => {
                        let affectedHivesCount = 0;
                        gs.hives.forEach(hive => {
                            if (!hive.isEmptyHiveBody && Math.random() < 0.3) { 
                                const loss = Math.floor(hive.population.foragers * (Math.random() * 0.1 + 0.05)); 
                                hive.population.foragers = Math.max(0, hive.population.foragers - loss);
                                hive.updateTotalPopulation();
                                affectedHivesCount++;
                                JournalManager.addEntry(`Hive ${hive.name} lost ${loss} foragers due to pesticide exposure.`);
                            }
                        });
                        if (affectedHivesCount > 0) {
                           UIManager.showToast("Forager Losses!", `${affectedHivesCount} hive(s) experienced forager losses due to pesticides.`, "warning");
                        }
                    },
                    choices: [{ text: "Oh no!", action: null}]
                }
            ]
        };
        
        function initializeNewGameState() {
            gameState = {
                beekeeperName: "My Apiary",
                money: INITIAL_MONEY,
                year: 1,
                currentSeason: SEASONS.SPRING,
                dayInSeason: 1,
                dayTotal: 1,
                currentWeather: WEATHER_TYPES[0],
                hives: [],
                inventory: { 
                    rawHoney: 0, beeswax: 0, sugar: 0, pollenPatty: 0, 
                    emptyHiveBodies: 1, beePackages: 0, nucColonies: 0 
                },
                researchPoints: 0,
                unlockedResearch: ["basic_beekeeping"],
                researchEffects: {},
                journal: [],
                isGameOver: false,
                nextHiveId: 1
            };
            JournalManager.addEntry("Welcome to your new apiary! Your beekeeping journey begins. You have one empty hive body in your inventory.");
        }

        const PersistenceManager = {
            SAVE_KEY_PREFIX: `beekeepingSimulatorSaveData_v_`,
            GAME_MODEL_VERSION: GAME_VERSION,

            getSaveKey() {
                return `${this.SAVE_KEY_PREFIX}${this.GAME_MODEL_VERSION.replace(/\./g, '_')}`;
            },

            saveGame() {
                if (gameState.isGameOver && !confirm("Game is over. Save final state? This might prevent starting a new game automatically if you reload.")) {
                    return; 
                }
                try {
                    const dataToSave = {
                        version: this.GAME_MODEL_VERSION,
                        timestamp: new Date().toISOString(),
                        gameState: gameState
                    };
                    localStorage.setItem(this.getSaveKey(), JSON.stringify(dataToSave));
                } catch (error) {
                    console.error("Error saving game:", error);
                    UIManager.showToast("Save Failed", "Could not save game data. Your browser might be blocking local storage or it's full.", "danger");
                }
            },

            loadGame() {
                try {
                    const savedString = localStorage.getItem(this.getSaveKey());
                    if (!savedString) return false;

                    const savedData = JSON.parse(savedString);
                    if (!savedData || typeof savedData !== 'object') {
                        console.error("Invalid saved data format.");
                        return false;
                    }

                    if (savedData.version !== this.GAME_MODEL_VERSION) {
                        UIManager.showToast("Load Failed", `Save data is from an incompatible version (${savedData.version}). Starting a new game. Current version is ${this.GAME_MODEL_VERSION}.`, "warning");
                        localStorage.removeItem(this.getSaveKey()); 
                        return false;
                    }

                    if (!savedData.gameState) {
                        console.error("Saved data is missing gameState.");
                        return false;
                    }
                    
                    gameState = savedData.gameState;
                    gameState.nextHiveId = gameState.nextHiveId || (gameState.hives.length > 0 ? Math.max(0, ...gameState.hives.map(h => h.id)) + 1 : 1);


                    gameState.inventory = gameState.inventory || { rawHoney: 0, beeswax: 0, sugar: 0, pollenPatty: 0, emptyHiveBodies: 0, beePackages: 0, nucColonies: 0 };
                    if(typeof gameState.inventory.emptyHiveBodies === 'undefined') gameState.inventory.emptyHiveBodies = 0;
                    if(typeof gameState.inventory.beePackages === 'undefined') gameState.inventory.beePackages = 0;
                    if(typeof gameState.inventory.nucColonies === 'undefined') gameState.inventory.nucColonies = 0;

                    gameState.journal = gameState.journal || [];
                    gameState.unlockedResearch = gameState.unlockedResearch || ["basic_beekeeping"];
                    gameState.researchEffects = gameState.researchEffects || {};
                    gameState.isGameOver = gameState.isGameOver || false;
                    gameState.beekeeperName = gameState.beekeeperName || "My Apiary";
                    
                    if (gameState.hives && Array.isArray(gameState.hives)) {
                        gameState.hives = gameState.hives.map(plainHive => {
                            if (!plainHive || typeof plainHive !== 'object') return null;
                            const hiveInstance = new Hive(plainHive.id, plainHive.name, plainHive.isEmptyHiveBody || false);
                            Object.assign(hiveInstance, plainHive);
                            
                            if (plainHive.frames && Array.isArray(plainHive.frames)) {
                                hiveInstance.frames = plainHive.frames.map(f => ({...f})); 
                            } else { 
                                hiveInstance.initializeFrames(); 
                            }

                            if (plainHive.queen && typeof plainHive.queen === 'object') {
                                const queenInstance = new Queen();
                                Object.assign(queenInstance, plainHive.queen);
                                hiveInstance.queen = queenInstance;
                            } else if (!hiveInstance.isEmptyHiveBody) {
                                hiveInstance.queen = new Queen(); 
                            } else {
                                hiveInstance.queen = null;
                            }
                            return hiveInstance;
                        }).filter(h => h !== null);
                    } else {
                        gameState.hives = [];
                    }
                    
                    UIManager.showToast("Game Loaded", `Welcome back, ${gameState.beekeeperName}!`, "success");
                    return true;
                } catch (error) {
                    console.error("Error loading game:", error);
                    UIManager.showToast("Load Error", "Failed to load saved game. Starting a new game.", "danger");
                    localStorage.removeItem(this.getSaveKey()); 
                    return false;
                }
            },
            
            resetGameConfirm(confirmUser = true) {
                if (confirmUser) {
                    UIManager.showConfirmation("Are you sure you want to reset all game data and start over?", () => {
                        this.performReset();
                    });
                } else {
                    this.performReset();
                }
            },

            performReset() {
                try {
                    localStorage.removeItem(this.getSaveKey());
                } catch (error) {
                    console.error("Error clearing saved game data:", error);
                    UIManager.showToast("Reset Error", "Could not clear old save data from local storage.", "warning");
                }
                initializeNewGameState();
                GameLoopManager.isPaused = false; 
                DOM.pauseButtonIcon.className = 'bi bi-pause-fill';
                DOM.pauseButton.setAttribute('data-bs-original-title', 'Pause Game');
                DOM.nextDayButton.disabled = false;
                DOM.pauseButton.disabled = false;

                UIManager.currentView = 'apiary-overview';
                UIManager.activeHiveId = null;
                UIManager.render();
                UIManager.showToast("Game Reset", "A new beekeeping season begins!", "info");
                if (settingsModalInstance) settingsModalInstance.hide();
                if (eventModalInstance) eventModalInstance.hide();
                if (confirmationModalInstance) confirmationModalInstance.hide();
                if (guideDetailModalInstance) guideDetailModalInstance.hide();
                if (installColonyModalInstance) installColonyModalInstance.hide();
                if (hiveSplitModalInstance) hiveSplitModalInstance.hide();
            }
        };

        class Queen {
            constructor(age = 0, health = 100, baseLayingRate = 1000) {
                this.age = age; 
                this.health = health; 
                this.baseLayingRate = baseLayingRate; 
                this.maxLifespan = 3 * 365; 
            }

            dailyUpdate(hiveResources) {
                this.age++;
                if (this.age > this.maxLifespan * 0.75 && Math.random() < 0.005) this.health -= 5; 
                this.health = Math.max(0, Math.min(100, this.health));
            }

            getEffectiveLayingRate(season) {
                if (this.health < 20 || season === SEASONS.WINTER) return 0;
                let currentEffectiveLayingRate = this.baseLayingRate * (this.health / 100.0);
                if (season === SEASONS.SPRING) currentEffectiveLayingRate *= 1.0;
                else if (season === SEASONS.SUMMER) currentEffectiveLayingRate *= 1.2;
                else if (season === SEASONS.AUTUMN) currentEffectiveLayingRate *= 0.5;
                return Math.floor(Math.random() * currentEffectiveLayingRate);
            }
        }

        class Hive {
            constructor(id, name, isEmptyHiveBody = false) {
                this.id = id;
                this.name = name || `Hive ${id}`;
                this.isEmptyHiveBody = isEmptyHiveBody;
                this.frames = [];
                this.initializeFrames();

                if (isEmptyHiveBody) {
                    this.queen = null;
                    this.population = { workers: 0, drones: 0, foragers: 0, total: 0 };
                } else {
                    this.queen = new Queen();
                    this.population = { workers: 10000, drones: 500, foragers: 4000, total: 14500 }; // Recalculated total
                }
                
                this.health = { overall: 90, varroaMites: 50, diseases: {} };
                this.temperament = "Calm"; 
                this.swarmingUrge = 0; 
                this.lastInspectionData = { day: -1, queenPresent: false, broodLevel: 'Unknown', miteCount: 'Unknown', foodStores: 'Unknown' };
            }

            initializeFrames() {
                this.frames = Array(FRAMES_PER_HIVE).fill(null).map((_, idx) => ({ 
                    id: idx, 
                    type: 'foundation', 
                    content: null, 
                    coveragePercent: 0, 
                    isCapped: false,
                    broodAge: 0
                }));
            }
            
            updateTotalPopulation() {
                this.population.total = this.population.workers + this.population.drones;
            }

            getFrameResourceCount(resourceType) {
                return this.frames.reduce((sum, frame) => {
                    if (frame.content === resourceType) {
                        sum += (frame.coveragePercent / 100) * FRAME_CAPACITY_KG; 
                    }
                    return sum;
                }, 0);
            }
            
            getBroodCount(broodType) {
                return this.frames.reduce((count, frame) => {
                    if (frame.content === broodType) {
                        count += Math.floor(1000 * (frame.coveragePercent / 100)); 
                    }
                    return count;
                }, 0);
            }

            dailyUpdate(season, weather) {
                if (this.isEmptyHiveBody || !this.queen || this.population.total <= 0) {
                     this.updateHealth(season); 
                     if (this.population.total <= 0 && !this.isEmptyHiveBody && !gameState.isGameOver) {
                        GameLoopManager.handleHiveCollapse(this.id);
                     }
                     return; 
                }

                this.queen.dailyUpdate(this.getFrameResourceCount('pollen'));

                let foragingResults = this.calculateForaging(season, weather);
                this.addResourceToFrames('nectar', foragingResults.nectar);
                this.addResourceToFrames('pollen', foragingResults.pollen);

                this.processFrames(season);
                this.consumeResources();
                this.updatePopulationDailyLosses(); 
                this.updateHealth(season);
                this.updateSwarmingUrge(season);
                this.updateTotalPopulation();
            }
            
            processFrames(season) {
                let eggsLaidToday = this.queen ? this.queen.getEffectiveLayingRate(season) : 0;
                let totalPollenKg = this.getFrameResourceCount('pollen');
                let availableNurseBees = this.population.workers * 0.2; 

                this.frames.forEach(frame => {
                    if (frame.type === 'foundation' && this.population.workers > 0) {
                        frame.coveragePercent += this.population.workers * FRAME_DRAW_RATE_PER_BEE_DAY; 
                        if (frame.coveragePercent >= 100) {
                            frame.type = 'drawn_comb';
                            frame.coveragePercent = 0; 
                        }
                    }

                    if (frame.type === 'drawn_comb' && frame.content === null && eggsLaidToday > 0 && totalPollenKg > 0.1 && availableNurseBees > 10) {
                        const eggsPerAction = 200; 
                        const coveragePerAction = (eggsPerAction / 1000) * 100; 
                        frame.content = 'eggs';
                        frame.broodAge = 0;
                        frame.coveragePercent = coveragePerAction; 
                        eggsLaidToday -= eggsPerAction; 
                        totalPollenKg -= 0.02; 
                        availableNurseBees -= 2;
                    }
                    
                    if (frame.content === 'eggs') {
                        frame.broodAge++;
                        if (frame.broodAge >= EGG_TO_LARVA_DAYS) {
                            frame.content = 'larvae';
                            frame.broodAge = 0;
                        }
                    } else if (frame.content === 'larvae') {
                        frame.broodAge++;
                        if (frame.broodAge >= LARVA_TO_PUPA_DAYS) {
                            frame.content = 'pupae';
                            frame.broodAge = 0;
                            frame.isCapped = true;
                        }
                    } else if (frame.content === 'pupae') {
                        frame.broodAge++;
                        if (frame.broodAge >= PUPA_TO_ADULT_DAYS) {
                            const emergingBees = Math.floor(1000 * (frame.coveragePercent / 100));
                            const newWorkers = Math.floor(emergingBees * 0.95);
                            const newDrones = emergingBees - newWorkers;
                            this.population.workers += newWorkers;
                            this.population.drones += newDrones;
                            this.population.foragers += Math.floor(newWorkers * 0.2); 
                            this.population.foragers = Math.min(this.population.foragers, Math.floor(this.population.workers * 0.5));
                            
                            frame.content = null;
                            frame.broodAge = 0;
                            frame.isCapped = false;
                            frame.coveragePercent = 0; 
                        }
                    }
                    
                    if (frame.content === 'nectar' && frame.coveragePercent > 0) {
                        const nectarToConvertPercent = frame.coveragePercent * 0.1; 
                        frame.coveragePercent -= nectarToConvertPercent;
                        
                        let addedToHoney = false;
                        for (const targetFrame of this.frames) {
                            if (targetFrame.type === 'drawn_comb' && (targetFrame.content === null || targetFrame.content === 'honey')) {
                                const spaceForHoneyPercent = 100 - targetFrame.coveragePercent;
                                if (spaceForHoneyPercent > 0) {
                                    const addPercent = Math.min(nectarToConvertPercent, spaceForHoneyPercent);
                                    targetFrame.content = 'honey';
                                    targetFrame.coveragePercent += addPercent;
                                    addedToHoney = true;
                                    break; 
                                }
                            }
                        }
                        if (!addedToHoney) frame.coveragePercent += nectarToConvertPercent; 

                        if(frame.coveragePercent <=0) frame.content = null;
                    }
                    if (frame.content === 'honey' && frame.coveragePercent >= 90 && !frame.isCapped) { 
                        frame.isCapped = true;
                    }
                });
                 this.updateTotalPopulation();
            }

            addResourceToFrames(resourceType, amountInKg) {
                let remainingAmountKg = amountInKg;
                for (const frame of this.frames.filter(f => f.type === 'drawn_comb' && (f.content === null || f.content === resourceType))) {
                    if (remainingAmountKg <= 0) break;
                    
                    const currentAmountInFrameKg = (frame.coveragePercent / 100) * FRAME_CAPACITY_KG;
                    const spaceLeftInFrameKg = FRAME_CAPACITY_KG - currentAmountInFrameKg;
                    const toAddKg = Math.min(remainingAmountKg, spaceLeftInFrameKg);
                    
                    if (toAddKg > 0) {
                        if (frame.content === null) frame.content = resourceType;
                        frame.coveragePercent += (toAddKg / FRAME_CAPACITY_KG) * 100;
                        remainingAmountKg -= toAddKg;
                    }
                    
                    if (frame.coveragePercent > 100) frame.coveragePercent = 100;
                }
            }
            
            consumeResources() {
                let honeyNeededKg = this.population.total * 0.0001;
                let pollenNeededKg = this.getBroodCount('larvae') * 0.00005 + this.population.workers * 0.000005; 

                for (const frame of this.frames) {
                    const resourceInFrameKg = (frame.coveragePercent / 100) * FRAME_CAPACITY_KG;
                    if (honeyNeededKg > 0 && frame.content === 'honey' && resourceInFrameKg > 0) {
                        const takeKg = Math.min(honeyNeededKg, resourceInFrameKg);
                        frame.coveragePercent -= (takeKg / FRAME_CAPACITY_KG) * 100;
                        honeyNeededKg -= takeKg;
                        if (frame.coveragePercent <= 0) { frame.content = null; frame.isCapped = false; frame.coveragePercent = 0; }
                    }
                    if (pollenNeededKg > 0 && frame.content === 'pollen' && resourceInFrameKg > 0) {
                        const takeKg = Math.min(pollenNeededKg, resourceInFrameKg);
                        frame.coveragePercent -= (takeKg / FRAME_CAPACITY_KG) * 100;
                        pollenNeededKg -= takeKg;
                        if (frame.coveragePercent <= 0) { frame.content = null; frame.coveragePercent = 0; }
                    }
                }

                if (honeyNeededKg > 0) { 
                    this.health.overall -= 5; 
                    this.population.workers = Math.floor(this.population.workers * 0.95);
                    this.population.drones = Math.floor(this.population.drones * 0.95);
                    this.population.foragers = Math.floor(this.population.foragers * 0.95);
                }
                if (pollenNeededKg > 0) { 
                    this.frames.filter(f => f.content === 'larvae').forEach(f => f.coveragePercent *= 0.8);
                }
                 this.updateTotalPopulation();
            }

            calculateForaging(season, weather) {
                let nectarGainKg = 0;
                let pollenGainKg = 0;
                if (this.isEmptyHiveBody || this.population.foragers <= 0 || season === SEASONS.WINTER) return { nectar: 0, pollen: 0 };

                let baseForagePotential = this.population.foragers * 0.0002 * FRAME_CAPACITY_KG; 
                
                if (season === SEASONS.SPRING) baseForagePotential *= 1.2;
                if (season === SEASONS.SUMMER) baseForagePotential *= 1.5;
                if (season === SEASONS.AUTUMN) baseForagePotential *= 0.8;

                if (weather === "Sunny") baseForagePotential *= 1.2;
                if (weather === "Cloudy") baseForagePotential *= 0.9;
                if (weather === "Rainy") baseForagePotential *= 0.2;
                if (weather === "Windy") baseForagePotential *= 0.6;
                if (weather === "Cold Snap") baseForagePotential *= 0.3;
                if (weather === "Heatwave") baseForagePotential *= 0.7;

                nectarGainKg = baseForagePotential * (Math.random() * 0.5 + 0.75); 
                pollenGainKg = nectarGainKg * (Math.random() * 0.3 + 0.1); 

                return { nectar: parseFloat(nectarGainKg.toFixed(2)), pollen: parseFloat(pollenGainKg.toFixed(2)) };
            }
            
            updatePopulationDailyLosses() {
                if (this.isEmptyHiveBody || this.population.total <= 0) return;
                const workerLifespan = 45; 
                const droneLifespan = 60;
                
                let dailyWorkerLoss = Math.floor(this.population.workers / workerLifespan);
                let dailyDroneLoss = Math.floor(this.population.drones / droneLifespan);

                this.population.workers = Math.max(0, this.population.workers - dailyWorkerLoss);
                this.population.drones = Math.max(0, this.population.drones - dailyDroneLoss);
                
                let foragerLossRate = this.population.workers > 0 ? (this.population.foragers / this.population.workers) : 0;
                let lostForagers = Math.floor(dailyWorkerLoss * foragerLossRate);
                this.population.foragers = Math.max(0, this.population.foragers - lostForagers);
                this.population.foragers = Math.min(this.population.foragers, Math.floor(this.population.workers * 0.5));

                this.updateTotalPopulation();

                if (this.population.total <= 0 && !this.isEmptyHiveBody && !gameState.isGameOver) {
                    GameLoopManager.handleHiveCollapse(this.id);
                }
            }

            updateHealth(season) {
                if (this.isEmptyHiveBody) return;
                this.health.varroaMites *= (1 + VARROA_GROWTH_RATE * (season === SEASONS.WINTER ? 0.1 : 1)); 
                this.health.varroaMites = Math.floor(this.health.varroaMites);

                let healthImpact = 0;
                if (this.health.varroaMites > 1000) healthImpact += (this.health.varroaMites - 1000) / 100; 
                if (this.health.diseases && this.health.diseases.AFB) healthImpact += 20;
                if (this.health.diseases && this.health.diseases.chalkbroodLevel > 0) healthImpact += this.health.diseases.chalkbroodLevel * 2;

                this.health.overall = Math.max(0, 100 - healthImpact);
                if (this.queen && this.health.overall < 30 && Math.random() < 0.1) { 
                    this.queen.health = Math.max(0, this.queen.health - 20);
                     UIManager.showToast("Queen Health Declining!", `The queen in ${this.name} is suffering due to poor hive health.`, "warning");
                }
            }
            
            updateSwarmingUrge(season) {
                if (this.isEmptyHiveBody || !this.queen) return;
                if (season === SEASONS.SPRING || season === SEASONS.SUMMER) {
                    if (this.population.total > 25000) this.swarmingUrge += 5; 
                    if (this.queen.age > 365 * 2) this.swarmingUrge += 3; 
                    const drawnFrames = this.frames.filter(f => f.type === 'drawn_comb').length;
                    const fullFrames = this.frames.filter(f => f.coveragePercent >= 90).length;
                    if (fullFrames / FRAMES_PER_HIVE > 0.8) this.swarmingUrge += 10; 
                    else if (drawnFrames / FRAMES_PER_HIVE > 0.9) this.swarmingUrge += 5; 
                } else {
                    this.swarmingUrge -= 10; 
                }
                this.swarmingUrge = Math.max(0, Math.min(100, this.swarmingUrge));

                if (this.swarmingUrge > 80 && Math.random() < 0.1) {
                    this.triggerSwarm();
                }
            }

            triggerSwarm() {
                if (this.isEmptyHiveBody) return;
                const swarmSize = Math.floor(this.population.total * (Math.random() * 0.3 + 0.4)); 
                const oldQueenLeaves = Math.random() < 0.7; 

                this.population.workers -= Math.floor(swarmSize * (this.population.workers / this.population.total));
                this.population.drones -= Math.floor(swarmSize * (this.population.drones / this.population.total));
                this.population.foragers = Math.floor(this.population.workers * 0.4);
                this.updateTotalPopulation();

                if (oldQueenLeaves || (this.queen && this.queen.health < 30)) {
                    this.queen = null; 
                }
                this.swarmingUrge = 0;
                JournalManager.addEntry(`Hive ${this.name} swarmed! Lost approx ${swarmSize} bees.`);
                UIManager.showToast("Swarm!", `Hive ${this.name} has swarmed! You lost a significant portion of its population.`, "warning");
                EventManager.triggerSpecificEvent({
                    title: "Hive Swarmed!",
                    text: `${this.name} has swarmed. A portion of the bees ${oldQueenLeaves ? 'and the old queen' : ''} have left. The hive will need time to recover${oldQueenLeaves ? ' and may need a new queen' : ''}.`,
                    choices: [{text: "Acknowledge", action: null}]
                });
            }

            applyTreatment(treatmentId) {
                if (treatmentId === "varroa_treatment_basic") {
                    this.health.varroaMites = Math.floor(this.health.varroaMites * (1 - VARROA_TREATMENT_EFFECTIVENESS));
                    JournalManager.addEntry(`Applied Varroa treatment to ${this.name}.`);
                    UIManager.showToast("Treatment Applied", `Varroa treatment applied to ${this.name}.`, "success");
                    return true;
                }
                return false;
            }

            feed(foodType, amountKg) {
                amountKg = parseFloat(amountKg);
                if (isNaN(amountKg) || amountKg <=0) {
                    UIManager.showToast("Invalid Amount", "Please enter a positive number for feeding.", "warning");
                    return false;
                }

                if (foodType === "sugar_syrup") {
                    this.addResourceToFrames('nectar', amountKg); 
                    JournalManager.addEntry(`Fed ${this.name} ${amountKg.toFixed(1)}kg sugar syrup.`);
                    UIManager.showToast("Feeding Success", `${this.name} fed ${amountKg.toFixed(1)}kg sugar syrup.`, "success");
                    return true;
                } else if (foodType === "pollen_patty") {
                    this.addResourceToFrames('pollen', amountKg); 
                    JournalManager.addEntry(`Fed ${this.name} ${amountKg.toFixed(1)} pollen patties (equiv. kg).`);
                    UIManager.showToast("Feeding Success", `${this.name} fed ${amountKg.toFixed(1)} pollen patties.`, "success");
                    return true;
                }
                return false;
            }
            
            harvest(product, amountKg) {
                amountKg = parseFloat(amountKg);
                 if (isNaN(amountKg) || amountKg <=0) {
                    UIManager.showToast("Invalid Amount", "Please enter a positive number for harvesting.", "warning");
                    return false;
                 }

                if (product === "honey") {
                    let harvestedAmountKg = 0;
                    for (const frame of this.frames) {
                        if (harvestedAmountKg >= amountKg) break;
                        if (frame.content === 'honey' && frame.isCapped && frame.coveragePercent > 0) {
                            const honeyInFrameKg = (frame.coveragePercent / 100) * FRAME_CAPACITY_KG;
                            const toHarvestFromFrameKg = Math.min(amountKg - harvestedAmountKg, honeyInFrameKg);
                            
                            frame.coveragePercent -= (toHarvestFromFrameKg / FRAME_CAPACITY_KG) * 100;
                            harvestedAmountKg += toHarvestFromFrameKg;
                            
                            if (frame.coveragePercent <= 0) {
                                frame.content = null;
                                frame.isCapped = false;
                                frame.coveragePercent = 0;
                            }
                        }
                    }

                    if (harvestedAmountKg > 0) {
                        gameState.inventory.rawHoney = (gameState.inventory.rawHoney || 0) + harvestedAmountKg;
                        JournalManager.addEntry(`Harvested ${harvestedAmountKg.toFixed(1)}kg honey from ${this.name}.`);
                        UIManager.showToast("Honey Harvested!", `${harvestedAmountKg.toFixed(1)}kg honey harvested from ${this.name}.`, "success");
                        return true;
                    } else {
                        UIManager.showToast("Not Enough Honey", `Not enough capped honey in ${this.name} to harvest.`, "warning");
                        return false;
                    }
                }
                 return false;
            }

            performInspection() {
                this.lastInspectionData.day = gameState.dayTotal;
                this.lastInspectionData.queenPresent = !!this.queen && this.queen.health > 0;
                const broodFrames = this.frames.filter(f => ['eggs', 'larvae', 'pupae'].includes(f.content) && f.coveragePercent > 10).length;
                if (broodFrames > 6) this.lastInspectionData.broodLevel = 'High';
                else if (broodFrames > 3) this.lastInspectionData.broodLevel = 'Medium';
                else if (broodFrames > 0) this.lastInspectionData.broodLevel = 'Low';
                else this.lastInspectionData.broodLevel = 'None';
                this.lastInspectionData.miteCount = this.health.varroaMites;
                const foodFrames = this.frames.filter(f => (f.content === 'honey' || f.content === 'pollen') && f.coveragePercent > 50).length;
                if (foodFrames > 5) this.lastInspectionData.foodStores = 'High';
                else if (foodFrames > 2) this.lastInspectionData.foodStores = 'Medium';
                else this.lastInspectionData.foodStores = 'Low';
                
                this.health.overall = Math.max(0, this.health.overall - 2); 
                this.temperament = Math.random() < 0.1 ? (this.temperament === "Calm" ? "Testy" : "Calm") : this.temperament;
            }

            getDataForDisplay() {
                if (this.isEmptyHiveBody) {
                    return { name: this.name, isEmpty: true, population: 'N/A', honey: 'N/A', pollen: 'N/A', varroa: 'N/A', swarm: 'N/A', health: 'N/A', lastInspected: 'N/A', queenStatus: 'N/A' };
                }

                const isStale = (gameState.dayTotal - this.lastInspectionData.day) > INSPECTION_VALIDITY_DAYS || this.lastInspectionData.day === -1;
                let queenStatusText = 'Unknown (Inspect)';
                if (!isStale) {
                    if (this.lastInspectionData.queenPresent && this.queen) {
                        queenStatusText = `Present (Age: ${Math.floor(this.queen.age / 30)} mo, Health: ${this.queen.health}%)`;
                    } else {
                        queenStatusText = 'Not Found/Queenless';
                    }
                }


                if (isStale) {
                    return {
                        name: this.name,
                        isEmpty: false,
                        population: 'Unknown (Inspect)',
                        honey: 'Unknown (Inspect)',
                        pollen: 'Unknown (Inspect)',
                        varroa: 'Unknown (Inspect)',
                        swarm: `${this.swarmingUrge}% (Est.)`,
                        health: `${this.health.overall}% (Est.)`,
                        lastInspected: this.lastInspectionData.day === -1 ? 'Never' : `Day ${this.lastInspectionData.day} (Stale)`,
                        queenStatus: queenStatusText
                    };
                }
                return {
                    name: this.name,
                    isEmpty: false,
                    population: this.population.total.toLocaleString(),
                    honey: this.getFrameResourceCount('honey').toFixed(1) + ' kg',
                    pollen: this.getFrameResourceCount('pollen').toFixed(1) + ' kg',
                    varroa: this.lastInspectionData.miteCount.toLocaleString(),
                    swarm: `${this.swarmingUrge}%`,
                    health: `${this.health.overall}%`,
                    lastInspected: `Day ${this.lastInspectionData.day} (Fresh)`,
                    queenStatus: queenStatusText
                };
            }
            
            installColony(type) {
                this.isEmptyHiveBody = false;
                this.queen = new Queen();
                if (type === 'package') {
                    this.population = { workers: 8000, drones: 200, foragers: 2000, total: 0 };
                    this.updateTotalPopulation();
                } else if (type === 'nuc') {
                    this.population = { workers: 5000, drones: 100, foragers: 1000, total: 0 };
                    this.updateTotalPopulation();
                    for (let i = 0; i < NUC_FRAME_COUNT; i++) {
                        this.frames[i].type = 'drawn_comb';
                        if (i < 2) { this.frames[i].content = 'larvae'; this.frames[i].coveragePercent = 70; this.frames[i].broodAge = Math.floor(Math.random() * LARVA_TO_PUPA_DAYS); } 
                        else if (i < 3) { this.frames[i].content = 'honey'; this.frames[i].coveragePercent = 80; this.frames[i].isCapped = true; }
                        else { this.frames[i].content = 'pollen'; this.frames[i].coveragePercent = 60; }
                    }
                }
                this.performInspection(); 
            }

            canSplit() {
                if (this.isEmptyHiveBody || !this.queen || this.population.total < 20000) return false;
                const broodFrames = this.frames.filter(f => ['eggs', 'larvae', 'pupae'].includes(f.content) && f.coveragePercent > 30).length;
                const foodFrames = this.frames.filter(f => (f.content === 'honey' || f.content === 'pollen') && f.coveragePercent > 50).length;
                return broodFrames >= 3 && foodFrames >= 2;
            }

            splitHive(targetHive, selectedFrameIndices) {
                if (!this.canSplit() || !targetHive || !targetHive.isEmptyHiveBody) return false;

                let movedFramesData = [];
                selectedFrameIndices.forEach(idx => {
                    movedFramesData.push(JSON.parse(JSON.stringify(this.frames[idx])));
                    this.frames[idx] = { id: idx, type: 'foundation', content: null, coveragePercent: 0, isCapped: false, broodAge: 0 }; 
                });
                
                targetHive.frames.forEach((frame, idx) => {
                    const movedFrame = movedFramesData.find(mf => mf.id === idx);
                    if (movedFrame) {
                        targetHive.frames[idx] = movedFrame;
                    } else {
                         targetHive.frames[idx] = { id: idx, type: 'foundation', content: null, coveragePercent: 0, isCapped: false, broodAge: 0 };
                    }
                });
                
                const splitPopulationRatio = 0.4; 
                targetHive.population.workers = Math.floor(this.population.workers * splitPopulationRatio);
                targetHive.population.drones = Math.floor(this.population.drones * splitPopulationRatio);
                targetHive.population.foragers = Math.floor(this.population.foragers * splitPopulationRatio);
                targetHive.updateTotalPopulation();
                targetHive.isEmptyHiveBody = false; 
                targetHive.queen = null; 

                this.population.workers -= targetHive.population.workers;
                this.population.drones -= targetHive.population.drones;
                this.population.foragers -= targetHive.population.foragers;
                this.updateTotalPopulation();
                
                this.performInspection();
                targetHive.performInspection();
                return true;
            }
        }

        const UIManager = {
            currentView: 'apiary-overview',
            activeHiveId: null,

            initializeBootstrapComponents() {
                try {
                    settingsModalInstance = new bootstrap.Modal(document.getElementById('settingsModal'));
                    eventModalInstance = new bootstrap.Modal(document.getElementById('eventModal'));
                    confirmationModalInstance = new bootstrap.Modal(document.getElementById('confirmationModal'));
                    guideDetailModalInstance = new bootstrap.Modal(document.getElementById('guideDetailModal'));
                    installColonyModalInstance = new bootstrap.Modal(document.getElementById('installColonyModal'));
                    hiveSplitModalInstance = new bootstrap.Modal(document.getElementById('hiveSplitModal'));
                    
                    const toastEl = document.getElementById('gameToast');
                    if (toastEl) {
                        gameToastInstance = new bootstrap.Toast(toastEl);
                    } else {
                        console.error("Toast element #gameToast not found!");
                    }
                } catch (e) {
                    console.error("Error initializing Bootstrap components:", e);
                }
            },
            
            init() {
                DOM.gameVersionDisplay.textContent = GAME_VERSION;
                this._initializeTooltips(document.body);
            },
            
            _initializeTooltips(parentElement = document) {
                try {
                    const tooltipTriggerList = Array.from(parentElement.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.forEach(tooltipTriggerEl => {
                        const existingTooltip = bootstrap.Tooltip.getInstance(tooltipTriggerEl);
                        if (existingTooltip) {
                            existingTooltip.dispose();
                        }
                        new bootstrap.Tooltip(tooltipTriggerEl);
                    });
                } catch (error) {
                    console.error("Error initializing tooltips:", error);
                }
            },

            setActiveNav(targetId) {
                document.querySelectorAll('#sidebar-nav .nav-link').forEach(link => link.classList.remove('active'));
                const activeLink = document.getElementById(targetId);
                if (activeLink) activeLink.classList.add('active');
                
                document.querySelectorAll('#dynamic-hive-nav-list .nav-link').forEach(link => link.classList.remove('active'));
                if (targetId.startsWith('nav-hive-') || (this.currentView === 'hive-detail' && this.activeHiveId)) {
                    const activeHiveLink = document.querySelector(`#dynamic-hive-nav-list .nav-link[data-hiveid="${this.activeHiveId}"]`);
                    if (activeHiveLink) activeHiveLink.classList.add('active');
                }
            },

            updateHeader() {
                try {
                    DOM.beekeeperNameDisplay.textContent = gameState.beekeeperName;
                    DOM.gameDateDisplay.textContent = `${gameState.currentSeason}, Year ${gameState.year}, Day ${gameState.dayInSeason}`;
                    DOM.playerMoneyDisplay.textContent = `$${gameState.money.toFixed(2)}`;
                    DOM.playerMoneyDisplay.classList.toggle('text-danger', gameState.money < 0);
                    DOM.playerMoneyDisplay.classList.toggle('text-success', gameState.money >= 0);

                    DOM.footerSeasonDisplay.textContent = gameState.currentSeason;
                    DOM.footerWeatherDisplay.textContent = gameState.currentWeather;
                    
                    let totalHealth = 0;
                    const populatedHives = gameState.hives.filter(h => !h.isEmptyHiveBody && h.population.total > 0);
                    if (populatedHives.length > 0) {
                        populatedHives.forEach(h => totalHealth += h.health.overall);
                        const avgHealth = Math.round(totalHealth / populatedHives.length);
                        DOM.apiaryHealthDisplay.textContent = `${avgHealth}% (${this.getHealthStatusText(avgHealth)})`;
                        DOM.apiaryHealthDisplay.className = "fw-bold"; 
                        if (avgHealth > 80) DOM.apiaryHealthDisplay.classList.add("text-success");
                        else if (avgHealth > 50) DOM.apiaryHealthDisplay.classList.add("text-warning");
                        else DOM.apiaryHealthDisplay.classList.add("text-danger");
                    } else {
                         DOM.apiaryHealthDisplay.textContent = "N/A";
                         DOM.apiaryHealthDisplay.className = "fw-bold text-muted";
                    }

                    const gameHeaderEl = document.getElementById('game-header');
                    if (gameHeaderEl) {
                        ['header-spring', 'header-summer', 'header-autumn', 'header-winter'].forEach(c => gameHeaderEl.classList.remove(c));
                        gameHeaderEl.classList.add(`header-${gameState.currentSeason.toLowerCase()}`);
                    }
                    this.updateInventoryDisplay();

                } catch (error) {
                    console.error("Error updating header:", error);
                }
            },
            
            updateInventoryDisplay() {
                let html = '';
                if (gameState.inventory.emptyHiveBodies > 0) html += `Empty Hives: ${gameState.inventory.emptyHiveBodies}<br>`;
                if (gameState.inventory.beePackages > 0) html += `Bee Packages: ${gameState.inventory.beePackages}<br>`;
                if (gameState.inventory.nucColonies > 0) html += `Nuc Colonies: ${gameState.inventory.nucColonies}<br>`;
                if (gameState.inventory.sugar > 0) html += `Sugar: ${gameState.inventory.sugar} kg<br>`;
                if (gameState.inventory.pollenPatty > 0) html += `Pollen Patties: ${gameState.inventory.pollenPatty}<br>`;
                if (gameState.inventory.rawHoney > 0) html += `Raw Honey: ${gameState.inventory.rawHoney.toFixed(1)} kg<br>`;
                if (gameState.inventory.beeswax > 0) html += `Beeswax: ${gameState.inventory.beeswax.toFixed(1)} g<br>`;
                DOM.inventoryList.innerHTML = html || 'No items in inventory.';
            },

            getHealthStatusText(healthValue) {
                if (healthValue > 90) return "Excellent";
                if (healthValue > 75) return "Good";
                if (healthValue > 50) return "Fair";
                if (healthValue > 25) return "Poor";
                return "Critical";
            },

            updateHiveNavList() {
                try {
                    DOM.dynamicHiveNavList.innerHTML = '';
                    if (!gameState.hives) return;
                    gameState.hives.forEach(hive => {
                        if (!hive) return; 
                        const li = document.createElement('li');
                        li.className = 'nav-item mb-1';
                        const a = document.createElement('a');
                        a.className = `nav-link nav-link-hive text-truncate`;
                        if (this.currentView === 'hive-detail' && this.activeHiveId === hive.id) {
                            a.classList.add('active');
                        }
                        a.href = '#';
                        a.dataset.hiveid = hive.id;
                        const statusText = hive.isEmptyHiveBody ? "(Empty)" : `(H:${hive.health.overall}%)`;
                        a.textContent = `${hive.name} ${statusText}`;
                        a.setAttribute('title', `${hive.name} ${statusText}`);
                        a.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.activeHiveId = hive.id;
                            this.currentView = 'hive-detail';
                            this.render();
                        });
                        li.appendChild(a);
                        DOM.dynamicHiveNavList.appendChild(li);
                    });
                    this._initializeTooltips(DOM.dynamicHiveNavList);
                } catch (error) {
                    console.error("Error updating hive nav list:", error);
                }
            },

            render() {
                try {
                    this.updateHeader();
                    this.updateHiveNavList();
                    
                    let targetNavId = `nav-${this.currentView.replace('-','_')}`;
                    if (this.currentView === 'hive-detail' && this.activeHiveId) {
                         targetNavId = `nav-hive-${this.activeHiveId}`; 
                    }
                    this.setActiveNav(targetNavId);

                    switch (this.currentView) {
                        case 'apiary-overview': this.renderApiaryOverview(); break;
                        case 'hive-detail': this.renderHiveDetailView(this.activeHiveId); break;
                        case 'market': this.renderMarket(); break;
                        case 'research': this.renderResearch(); break;
                        case 'guide': this.renderGuide(); break;
                        case 'journal': this.renderJournal(); break;
                        default: DOM.contentPane.innerHTML = '<p>Select an option from the menu.</p>';
                    }
                    this._initializeTooltips(DOM.contentPane);
                } catch (error) {
                    console.error("Error during main render:", error);
                    DOM.contentPane.innerHTML = '<p class="text-danger">A critical error occurred while rendering this view. Please try navigating or resetting the game.</p>';
                    this.showToast("Render Error", "An error occurred displaying content.", "danger");
                }
            },

            renderApiaryOverview() {
                try {
                    let html = `<div class="d-flex justify-content-between align-items-center mb-3">
                                    <h2>Apiary Overview</h2>
                                    <div>
                                        <button class="btn btn-success btn-sm me-2" id="placeEmptyHiveButton" data-bs-toggle="tooltip" title="Place an empty hive from inventory"><i class="bi bi-plus-circle me-1"></i> Place Empty Hive</button>
                                    </div>
                                </div>`;
                    html += `<div class="mb-3 p-3 border rounded bg-light-subtle">
                                <h5 class="mb-2">Apiary Actions</h5>
                                <button class="btn btn-sm btn-outline-secondary me-2" disabled data-bs-toggle="tooltip" title="Coming Soon!"><i class="bi bi-check2-circle"></i> Quick Apiary Check</button>
                                <button class="btn btn-sm btn-outline-secondary me-2" disabled data-bs-toggle="tooltip" title="Coming Soon!"><i class="bi bi-droplet-fill"></i> Bulk Feed</button>
                                <button class="btn btn-sm btn-outline-secondary" disabled data-bs-toggle="tooltip" title="Coming Soon!"><i class="bi bi-shield-plus"></i> Bulk Treat Varroa</button>
                             </div>`;
                    html += '<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">';
                    if (!gameState.hives || gameState.hives.length === 0) {
                        html += `<div class="col-12"><p>You have no hives. Place an empty hive from your inventory (if you have one) or buy one from the market.</p></div>`;
                    } else {
                        gameState.hives.forEach(hive => {
                            if (!hive) return; 
                            const displayData = hive.getDataForDisplay();
                            const healthText = displayData.isEmpty ? 'N/A' : this.getHealthStatusText(hive.health.overall);
                            const healthBadgeColor = displayData.isEmpty ? 'secondary' : (hive.health.overall > 70 ? 'success' : hive.health.overall > 40 ? 'warning' : 'danger');
                            const inspectionIcon = displayData.lastInspected.includes('Stale') || displayData.lastInspected.includes('Never') ? '<i class="bi bi-exclamation-triangle-fill text-warning ms-1"></i>' : '<i class="bi bi-check-circle-fill text-success ms-1"></i>';
                            
                            html += `
                                <div class="col">
                                    <div class="card h-100 hive-card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0 text-truncate" title="${displayData.name}">${displayData.name} ${displayData.isEmpty ? "(Empty)" : ""}</h5>
                                            <span class="badge bg-${healthBadgeColor}">${healthText}</span>
                                        </div>
                                        <div class="card-body">
                                            <p class="card-text mb-1">Population: <span class="${displayData.population.includes('Unknown') ? 'stat-value-unknown' : 'stat-value'}">${displayData.population}</span></p>
                                            <p class="card-text mb-1">Honey Stores: <span class="${displayData.honey.includes('Unknown') ? 'stat-value-unknown' : 'stat-value'}">${displayData.honey}</span></p>
                                            <p class="card-text mb-1">Pollen Stores: <span class="${displayData.pollen.includes('Unknown') ? 'stat-value-unknown' : 'stat-value'}">${displayData.pollen}</span></p>
                                            <p class="card-text mb-1">Varroa Mites: <span class="${displayData.varroa.includes('Unknown') ? 'stat-value-unknown' : 'stat-value'} ${!displayData.isEmpty && hive.health.varroaMites > 500 ? 'text-danger fw-bold' : !displayData.isEmpty && hive.health.varroaMites > 200 ? 'text-warning' : ''}">${displayData.varroa}</span></p>
                                            <p class="card-text mb-1">Swarm Urge: <span class="${displayData.swarm.includes('Unknown') ? 'stat-value-unknown' : 'stat-value'} ${!displayData.isEmpty && hive.swarmingUrge > 70 ? 'text-danger fw-bold' : !displayData.isEmpty && hive.swarmingUrge > 40 ? 'text-warning' : ''}">${displayData.swarm}</span></p>
                                            <p class="card-text mb-1"><small>Last Inspected: ${displayData.lastInspected} ${!displayData.isEmpty ? inspectionIcon : ''}</small></p>
                                        </div>
                                        <div class="card-footer bg-transparent border-top-0 text-end">
                                            <button class="btn btn-primary btn-sm view-hive-details" data-hiveid="${hive.id}"><i class="bi bi-eye"></i> View Details</button>
                                        </div>
                                    </div>
                                </div>`;
                        });
                    }
                    html += '</div>';
                    DOM.contentPane.innerHTML = html;

                    document.querySelectorAll('.view-hive-details').forEach(button => {
                        button.addEventListener('click', (e) => {
                            this.activeHiveId = parseInt(e.currentTarget.dataset.hiveid);
                            this.currentView = 'hive-detail';
                            this.render();
                        });
                    });
                    
                    const placeEmptyHiveButton = document.getElementById('placeEmptyHiveButton');
                    if (placeEmptyHiveButton) {
                        placeEmptyHiveButton.disabled = gameState.inventory.emptyHiveBodies <= 0;
                        placeEmptyHiveButton.addEventListener('click', () => GameLoopManager.placeEmptyHiveFromInventory());
                    }
                } catch (error) {
                    console.error("Error rendering apiary overview:", error);
                    DOM.contentPane.innerHTML = '<p class="text-danger">Error displaying apiary overview.</p>';
                }
            },

            renderHiveDetailView(hiveId) {
                try {
                    const hive = gameState.hives.find(h => h.id === hiveId);
                    if (!hive) {
                        DOM.contentPane.innerHTML = '<p class="text-danger">Hive not found. It may have been removed or collapsed.</p>';
                        this.currentView = 'apiary-overview'; 
                        this.activeHiveId = null;
                        this.render();
                        return;
                    }
                    const displayData = hive.getDataForDisplay();
                    const isStale = displayData.lastInspected.includes('Stale') || displayData.lastInspected.includes('Never');

                    const varroaTreatmentItem = GameData.marketItems.find(i=>i.id==='varroa_treatment_basic');
                    const varroaTreatmentCost = varroaTreatmentItem ? varroaTreatmentItem.buyPrice : 'N/A';
                    const sugarItem = GameData.marketItems.find(i=>i.id==='sugar');
                    const sugarCost = sugarItem ? sugarItem.buyPrice : 'N/A';
                    const pollenPattyItem = GameData.marketItems.find(i=>i.id==='pollen_patty');
                    const pollenPattyCost = pollenPattyItem ? pollenPattyItem.buyPrice : 'N/A';

                    let html = `
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2 class="text-truncate" title="${hive.name}">Hive: ${hive.name} ${hive.isEmptyHiveBody ? "(Empty)" : ""} <button class="btn btn-sm btn-outline-secondary ms-2" id="renameHiveBtn" data-bs-toggle="tooltip" title="Rename Hive"><i class="bi bi-pencil-fill"></i></button></h2>
                            <button class="btn btn-sm btn-outline-danger" id="removeHiveBtn" data-hiveid="${hive.id}" data-bs-toggle="tooltip" title="Remove this hive permanently"><i class="bi bi-trash-fill"></i> Remove Hive</button>
                        </div>
                        ${isStale && !hive.isEmptyHiveBody ? `<div class="alert alert-warning d-flex align-items-center" role="alert"><i class="bi bi-exclamation-triangle-fill me-2"></i>Hive data is stale. Perform an inspection for current details.</div>` : ''}
                        <ul class="nav nav-tabs mb-3" id="hiveDetailTabs" role="tablist">
                            <li class="nav-item" role="presentation"><button class="nav-link active" id="summary-tab-${hive.id}" data-bs-toggle="tab" data-bs-target="#summary-${hive.id}" type="button" role="tab">Summary</button></li>
                            <li class="nav-item" role="presentation"><button class="nav-link" id="brood-tab-${hive.id}" data-bs-toggle="tab" data-bs-target="#brood-${hive.id}" type="button" role="tab">Brood Chamber</button></li>
                            <li class="nav-item" role="presentation"><button class="nav-link" id="health-tab-${hive.id}" data-bs-toggle="tab" data-bs-target="#health-${hive.id}" type="button" role="tab">Health & Pests</button></li>
                            <li class="nav-item" role="presentation"><button class="nav-link" id="actions-tab-${hive.id}" data-bs-toggle="tab" data-bs-target="#actions-${hive.id}" type="button" role="tab">Actions</button></li>
                        </ul>
                        <div class="tab-content" id="hiveDetailTabsContent">
                            <div class="tab-pane fade show active" id="summary-${hive.id}" role="tabpanel" aria-labelledby="summary-tab-${hive.id}">
                                <h4>Summary</h4>`;
                    if (hive.isEmptyHiveBody) {
                        html += `<p>This hive body is empty. Use the Actions tab to install a bee package or nuc colony.</p>`;
                    } else {
                        html += ` <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Queen Status:</strong> <span class="${isStale ? 'stat-value-unknown' : 'stat-value'}">${displayData.queenStatus}</span></p>
                                        <p><strong>Temperament:</strong> ${hive.temperament}</p>
                                        <p><strong>Swarm Urge:</strong> <span class="${isStale ? 'stat-value-unknown' : 'stat-value'} ${!isStale && hive.swarmingUrge > 70 ? 'text-danger fw-bold' : !isStale && hive.swarmingUrge > 40 ? 'text-warning' : ''}">${displayData.swarm}</span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Total Population:</strong> <span class="${isStale ? 'stat-value-unknown' : 'stat-value'}">${displayData.population}</span></p>
                                        ${!isStale ? `<p><small>(Workers: ${hive.population.workers.toLocaleString()}, Drones: ${hive.population.drones.toLocaleString()}, Foragers: ${hive.population.foragers.toLocaleString()})</small></p>` : ''}
                                    </div>
                                </div>
                                <h5>Resources (on frames)</h5>
                                <div class="row">
                                    <div class="col-md-4"><strong>Honey:</strong> <span class="${isStale ? 'stat-value-unknown' : 'stat-value'}">${displayData.honey}</span></div>
                                    <div class="col-md-4"><strong>Pollen:</strong> <span class="${isStale ? 'stat-value-unknown' : 'stat-value'}">${displayData.pollen}</span></div>
                                </div>
                                <p class="mt-2"><small>Last Inspected: ${displayData.lastInspected}</small></p>`;
                    }
                    html += `</div>
                            <div class="tab-pane fade" id="brood-${hive.id}" role="tabpanel" aria-labelledby="brood-tab-${hive.id}">
                                <h4>Brood Chamber Frames</h4>`;
                    if (hive.isEmptyHiveBody) {
                        html += `<p>This hive body is empty. Frames will be shown once a colony is installed.</p>`;
                    } else if (isStale) {
                         html += `<p class="text-warning"><i class="bi bi-eye-slash-fill me-1"></i>Frame details are hidden. Perform an inspection to view current frame status.</p>`;
                    } else {
                        html += `<div class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-3 mb-3">`; // g-3 for more spacing
                        hive.frames.forEach(frame => {
                            let iconClass = 'bi-grid-1x2'; 
                            let contentText = frame.type === 'foundation' ? 'Foundation' : 'Drawn Comb';
                            let frameBgClass = frame.type === 'foundation' ? 'frame-slot-foundation' : 'frame-slot-drawn_comb';

                            if (frame.content) {
                                contentText = frame.content.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                                switch(frame.content) {
                                    case 'eggs': iconClass = 'bi-egg-fill'; frameBgClass = 'frame-slot-eggs'; break;
                                    case 'larvae': iconClass = 'bi-bug-fill'; frameBgClass = 'frame-slot-larvae'; break;
                                    case 'pupae': iconClass = 'bi-shield-fill-check'; frameBgClass = 'frame-slot-pupae'; break; // Changed icon
                                    case 'honey': iconClass = 'bi-droplet-fill text-warning'; frameBgClass = 'frame-slot-honey'; break;
                                    case 'pollen': iconClass = 'bi-flower1 text-primary'; frameBgClass = 'frame-slot-pollen'; break;
                                }
                            }
                            html += `<div class="col">
                                        <div class="card card-body p-1 text-center frame-slot ${frameBgClass} ${frame.isCapped ? 'frame-slot-capped' : ''}" data-bs-toggle="tooltip" title="Frame ${frame.id + 1}: ${contentText} - ${frame.coveragePercent.toFixed(0)}% full ${frame.isC
<!-- Injectable Console Log Copier Snippet -->
<div id="appgen2025ConsoleCopyUtil" style="position: fixed; top: 5px; right: 5px; z-index: 9999; padding: 5px; background-color: rgba(0,0,0,0.7); border-radius: 5px; cursor: default;" title="Copy Console Logs for this Tab">
    <button type="button" style="background: none; border: 1px solid #fff; color: #fff; padding: 3px 8px; font-size: 10px; border-radius: 3px; cursor: pointer;">Copy Logs</button>
</div>
<script>
    (function() {
        const utilContainer = document.getElementById('appgen2025ConsoleCopyUtil');
        if (utilContainer) {
            const originalConsoleLog = console.log;
            const originalConsoleError = console.error;
            const originalConsoleWarn = console.warn;
            const originalConsoleInfo = console.info;
            const originalConsoleDebug = console.debug;
            const logs = [];
            function formatLog(type, args) {
                const timestamp = new Date().toISOString();
                const message = Array.from(args).map(arg => {
                    try {
                        if (arg instanceof Error) return arg.stack || arg.toString();
                        if (typeof arg === 'object' && arg !== null) {
                            const getCircularReplacer = () => { const seen = new WeakSet(); return (key, value) => { if (typeof value === "object" && value !== null) { if (seen.has(value)) { return "[Circular]"; } seen.add(value); } return value; }; };
                            return JSON.stringify(arg, getCircularReplacer(), 2);
                        }
                        return String(arg);
                    } catch (e) { return '[Unserializable Object]'; }
                }).join(' ');
                return `[${timestamp}] [${type.toUpperCase()}] ${message}`;
            }
            console.log = function(...args) { const formatted = formatLog('log', args); logs.push(formatted); originalConsoleLog.apply(console, args); };
            console.error = function(...args) { const formatted = formatLog('error', args); logs.push(formatted); originalConsoleError.apply(console, args); };
            console.warn = function(...args) { const formatted = formatLog('warn', args); logs.push(formatted); originalConsoleWarn.apply(console, args); };
            console.info = function(...args) { const formatted = formatLog('info', args); logs.push(formatted); originalConsoleInfo.apply(console, args); };
            console.debug = function(...args) { const formatted = formatLog('debug', args); logs.push(formatted); originalConsoleDebug.apply(console, args); };
            window.onerror = function(message, source, lineno, colno, error) { const errorObj = error || {}; const formatted = formatLog('uncaught_error', [message, `at ${source}:${lineno}:${colno}`, errorObj.stack || '(no stack)']); logs.push(formatted); originalConsoleError.call(console, 'Uncaught Error:', message, 'at', source + ':' + lineno + ':' + colno, error); return false; };
            window.onunhandledrejection = function(event) { const reason = event.reason || {}; const formatted = formatLog('unhandled_rejection', [reason.message || reason, reason.stack || '(no stack)']); logs.push(formatted); originalConsoleError.call(console, 'Unhandled Rejection:', event.reason); };
            const copyButton = utilContainer.querySelector('button');
            if (copyButton) {
                copyButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (logs.length === 0) { alert('No console logs captured yet to copy.'); return; }
                    const logText = logs.join('\n');
                    navigator.clipboard.writeText(logText).then(function() {
                        const originalText = copyButton.textContent; copyButton.textContent = 'Copied!'; copyButton.style.background = '#28a745'; copyButton.style.borderColor = '#28a745';
                        setTimeout(function() { copyButton.textContent = originalText; copyButton.style.background = 'none'; copyButton.style.borderColor = '#fff'; }, 2000);
                        originalConsoleInfo.call(console, 'AppGen2025 Util: Console logs copied to clipboard.');
                    }).catch(function(err) {
                        originalConsoleError.call(console, 'AppGen2025 Util: Failed to copy console logs - ', err.name, err.message);
                        alert('Failed to copy logs. See browser console for details. Logs may be too large or permissions denied.');
                        const originalText = copyButton.textContent; copyButton.textContent = 'Failed!'; copyButton.style.background = '#dc3545'; copyButton.style.borderColor = '#dc3545';
                        setTimeout(function() { copyButton.textContent = originalText; copyButton.style.background = 'none'; copyButton.style.borderColor = '#fff'; }, 3000);
                    });
                });
            }
        } else { console.error('AppGen2025 Util: Container element "appgen2025ConsoleCopyUtil" not found. Ensure it is correctly injected or present in the HTML.'); }
    })();
</script>
<!-- End of Injectable Snippet -->
