<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Genius Oracle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        html, body {
            height: 100%;
            overflow: hidden; /* Prevent scrolling */
        }
        main {
             /* Ensure main takes full height and centers content */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding-top: 1rem !important;
            padding-bottom: 1rem !important;
        }

        .card {
            background-color: #2d3748 !important; /* Darker card background */
            border-color: #4a5568 !important; /* Card border color */
        }
        .card-header, .card-footer {
            background-color: #1a202c !important; /* Even darker header/footer */
            border-color: #4a5568 !important; /* Border color */
        }
        .form-control {
            background-color: #4a5568; /* Dark input background */
            border-color: #636b7b; /* Input border color */
            color: #e2e8f0; /* Input text color */
        }
        .form-control::placeholder {
            color: #a0aec0; /* Placeholder text color */
        }
        .form-control:focus {
            background-color: #4a5568;
            border-color: #667eea; /* Highlight color on focus */
            color: #e2e8f0;
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25); /* Glow effect */
        }
        .btn-primary {
            background-color: #667eea !important; /* Primary button color */
            border-color: #667eea !important; /* Primary button border */
        }
         .btn-primary:hover {
            background-color: #5a67d8 !important;
            border-color: #5a67d8 !important;
         }
         .btn-outline-light {
            color: #e2e8f0 !important;
            border-color: #e2e8f0 !important;
         }
         .btn-outline-light:hover {
            background-color: rgba(226, 232, 240, 0.1) !important;
            color: #e2e8f0 !important;
         }
         .btn-outline-danger {
            color: #fc8181 !important;
            border-color: #fc8181 !important;
         }
         .btn-outline-danger:hover {
            background-color: rgba(252, 129, 129, 0.1) !important;
            color: #fc8181 !important;
         }


        .perspective-option-img {
            cursor: pointer;
            border: 3px solid transparent;
            transition: border-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            background-color: #4a5568; /* Placeholder background */
            min-height: 120px; /* Provide minimum size during loading */
            object-fit: cover; /* Ensure image covers the area */
        }
        .perspective-option-img:hover {
            border-color: var(--bs-primary);
            transform: scale(1.03); /* Slightly more pronounced zoom */
        }
        .perspective-option-img.selected {
            border-color: var(--bs-success);
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);
        }
        .perspective-option-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border-radius: .25rem; /* Match image border-radius */
            overflow: hidden; /* Hide overflow from image scale */
        }
        .perspective-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* Darker overlay */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10;
            border-radius: .25rem;
        }
         .answer-image-container {
             position: relative;
             min-height: 250px; /* Taller placeholder */
             background-color: #4a5568; /* Placeholder background */
             display: flex;
             justify-content: center;
             align-items: center;
             border-radius: .25rem;
             overflow: hidden;
         }
        #answer-image-container img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            border-radius: .25rem;
            object-fit: cover;
        }
        #answer-image-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* Darker overlay */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10;
             border-radius: .25rem;
        }
         .alert-warning {
             background-color: #4a5568 !important;
             border-color: #636b7b !important;
             color: #fc8181 !important;
         }
         .alert-danger {
             background-color: #c53030 !important;
             border-color: #e53e3e !important;
             color: #fff !important;
         }


        #log-content .card {
            margin-bottom: 1rem;
            background-color: #1a202c !important; /* Darker log entry background */
            border-color: #4a5568 !important;
        }
         #log-content .card-header {
            background-color: #2d3748 !important;
            border-color: #4a5568 !important;
         }
         #log-content img {
            border: 1px solid #4a5568;
         }


        #report-image-collage img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            border: 1px solid #4a5568;
            border-radius: .25rem;
            object-fit: cover;
            aspect-ratio: 1 / 1; /* Make collage images square */
         }
         #report-image-collage .col {
             /* Ensure columns have height for square images */
             display: flex;
             justify-content: center;
             align-items: center;
         }

        /* Ensure sections are hidden correctly and use flex for centering */
        #input-section:not(.d-flex),
        #journey-section:not(.d-flex),
        #log-section:not(.d-flex),
        #report-section:not(.d-flex) {
            display: none !important;
        }
    </style>
</head>
<body class="bg-dark text-light d-flex flex-column min-vh-100" data-bs-theme="dark">

    <main class="container-fluid flex-grow-1 d-flex flex-column justify-content-center align-items-center py-4">

        <section id="input-section" class="card bg-secondary text-white p-4 shadow-lg" style="max-width: 600px; width: 100%;">
            <div class="card-body">
                <h2 class="card-title text-center mb-4">AI Genius Oracle</h2>
                <p class="card-text text-center mb-4">Embark on an intellectual journey. Enter a complex topic below and explore its facets through AI-guided questions and visual perspectives.</p>
                <div class="mb-3">
                    <label for="topic-input" class="form-label">Enter Topic:</label>
                    <input type="text" class="form-control" id="topic-input" placeholder="e.g., The Future of Work">
                </div>
                <button id="start-journey-btn" class="btn btn-primary w-100">Start Journey</button>
                <div id="input-loading" class="text-center mt-3 d-none">
                    <div class="spinner-border text-light" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Consulting the Oracle...</p>
                </div>
                <div id="input-error" class="alert alert-danger mt-3 d-none" role="alert"></div>
            </div>
        </section>

        <section id="journey-section" class="container d-none">
            <div class="row justify-content-center">
                <div class="col-12 col-lg-10">
                    <div class="card bg-secondary text-white p-4 shadow-lg mb-4">
                         <div class="card-header bg-dark border-secondary text-center">
                            <h5 class="mb-0" id="current-topic-display">Topic: </h5>
                         </div>
                        <div class="card-body">
                            <div class="progress mb-3" role="progressbar" aria-label="Progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                <div id="journey-progress" class="progress-bar bg-primary" style="width: 0%"></div>
                            </div>

                            <div id="question-area" class="mb-4">
                                <h4 class="card-title mb-3" id="question-text"></h4>
                                <div id="perspective-options" class="row row-cols-1 row-cols-md-3 g-3">
                                </div>
                                <div id="question-loading" class="text-center mt-3 d-none">
                                    <div class="spinner-border text-light" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Oracle is pondering...</p>
                                </div>
                                <div id="question-error" class="alert alert-danger mt-3 d-none" role="alert"></div>
                            </div>

                            <div id="answer-area" class="mt-4 d-none">
                                <h4 class="card-title mb-3">Oracle's Insight:</h4>
                                <div id="answer-content">
                                    <p id="answer-text" class="lead"></p>
                                    <div id="answer-image-container" class="text-center mt-3 rounded">
                                        <div id="answer-image-loading" class="text-center d-none">
                                            <div class="spinner-border text-light" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mt-2">Visualizing insight...</p>
                                        </div>
                                         <div id="answer-image-error" class="alert alert-warning mt-3 d-none" role="alert">Could not load image.</div>
                                    </div>
                                </div>
                                <button id="next-step-btn" class="btn btn-primary mt-4 w-100">Next Step</button>
                                <div id="answer-loading" class="text-center mt-3 d-none">
                                    <div class="spinner-border text-light" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Preparing next question...</p>
                                </div>
                                <div id="answer-error" class="alert alert-danger mt-3 d-none" role="alert"></div>
                            </div>
                        </div>
                        <div class="card-footer bg-dark border-secondary text-center">
                            <button id="view-log-btn" class="btn btn-outline-light btn-sm me-2">View Journey Log</button>
                            <button id="end-journey-btn" class="btn btn-outline-danger btn-sm">End Journey</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="log-section" class="container d-none">
             <div class="row justify-content-center">
                <div class="col-12 col-lg-10">
                    <div class="card bg-secondary text-white p-4 shadow-lg mb-4">
                        <div class="card-header bg-dark border-secondary text-center">
                            <h3 class="card-title mb-0">Journey Log</h3>
                        </div>
                        <div class="card-body" id="log-content" style="max-height: 60vh; overflow-y: auto;">
                        </div>
                         <div class="card-footer bg-dark border-secondary text-center">
                            <button id="hide-log-btn" class="btn btn-outline-light btn-sm">Back to Journey</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="report-section" class="container d-none">
             <div class="row justify-content-center">
                <div class="col-12 col-lg-10">
                    <div class="card bg-secondary text-white p-4 shadow-lg mb-4">
                        <div class="card-header bg-dark border-secondary text-center">
                            <h3 class="card-title mb-0">Your Oracle Report</h3>
                        </div>
                        <div class="card-body">
                            <h4 class="mb-3">Summary:</h4>
                            <p id="report-summary-text" class="lead mb-4"></p>

                            <h4 class="mb-3">Visual Journey:</h4>
                            <div id="report-image-collage" class="row row-cols-2 row-cols-md-3 g-3">
                            </div>
                        </div>
                        <div class="card-footer bg-dark border-secondary text-center">
                            <button id="download-report-btn" class="btn btn-outline-light btn-sm me-2" disabled>Download Report</button>
                            <button id="restart-journey-btn" class="btn btn-primary btn-sm">Start New Journey</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function() {
            let journeyState = {
                currentTopic: '',
                steps: [],
                currentStepIndex: -1,
                aiConversationHistory: [],
                maxSteps: 7
            };

            const inputSection = document.getElementById('input-section');
            const topicInput = document.getElementById('topic-input');
            const startJourneyBtn = document.getElementById('start-journey-btn');
            const inputLoading = document.getElementById('input-loading');
            const inputError = document.getElementById('input-error');

            const journeySection = document.getElementById('journey-section');
            const currentTopicDisplay = document.getElementById('current-topic-display');
            const journeyProgress = document.getElementById('journey-progress');
            const questionArea = document.getElementById('question-area');
            const questionText = document.getElementById('question-text');
            const perspectiveOptions = document.getElementById('perspective-options');
            const questionLoading = document.getElementById('question-loading');
            const questionError = document.getElementById('question-error');

            const answerArea = document.getElementById('answer-area');
            const answerText = document.getElementById('answer-text');
            const answerImageContainer = document.getElementById('answer-image-container');
            const answerImageLoading = document.getElementById('answer-image-loading');
            const answerImageError = document.getElementById('answer-image-error');
            const nextStepBtn = document.getElementById('next-step-btn');
            const answerLoading = document.getElementById('answer-loading');
            const answerError = document.getElementById('answer-error');

            const viewLogBtn = document.getElementById('view-log-btn');
            const endJourneyBtn = document.getElementById('end-journey-btn');

            const logSection = document.getElementById('log-section');
            const logContent = document.getElementById('log-content');
            const hideLogBtn = document.getElementById('hide-log-btn');

            const reportSection = document.getElementById('report-section');
            const reportSummaryText = document.getElementById('report-summary-text');
            const reportImageCollage = document.getElementById('report-image-collage');
            const downloadReportBtn = document.getElementById('download-report-btn');
            const restartJourneyBtn = document.getElementById('restart-journey-btn');

            function showSection(section) {
                inputSection.classList.add('d-none');
                journeySection.classList.add('d-none');
                logSection.classList.add('d-none');
                reportSection.classList.add('d-none');

                inputSection.classList.remove('d-flex');
                journeySection.classList.remove('d-flex');
                logSection.classList.remove('d-flex');
                reportSection.classList.remove('d-flex');

                if (section === inputSection || section === journeySection || section === logSection || section === reportSection) {
                     section.classList.add('d-flex');
                } else {
                     section.classList.remove('d-none');
                }
            }

            function showLoading(element) {
                element.classList.remove('d-none');
            }

            function hideLoading(element) {
                element.classList.add('d-none');
            }

            function showError(element, message) {
                element.textContent = message;
                element.classList.remove('d-none');
            }

            function hideError(element) {
                element.classList.add('d-none');
            }

            function updateProgressBar() {
                const progress = (journeyState.currentStepIndex + 1) / journeyState.maxSteps * 100;
                journeyProgress.style.width = progress + '%';
                journeyProgress.setAttribute('aria-valuenow', progress);
            }

            async function callAI(aiguide, msgforai, llmSettings = {}) {
                try {
                    const response = await fetch('/api/ai', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ aiguide, msgforai, llmSettings })
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        return data.response;
                    } else {
                        console.error('AI API Error:', data.error);
                        throw new Error(data.error || 'AI API call failed.');
                    }
                } catch (err) {
                    console.error('AI API Fetch Error:', err);
                    throw new Error('Failed to communicate with the Oracle AI.');
                }
            }

            async function generateImage(prompt, aspectRatio = '1:1', style = 'vivid') {
                try {
                    const response = await fetch('/api/generate-image-on-demand', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, aspectRatio, style })
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        return data.imageUrl;
                    } else {
                         console.error('Image Generation API Error:', data.error);
                        throw new Error(data.error || 'Image generation failed.');
                    }
                } catch (err) {
                    console.error('Image Generation API Fetch Error:', err);
                    throw new Error('Failed to generate image.');
                }
            }

            async function startJourney() {
                const topic = topicInput.value.trim();
                if (!topic) {
                    showError(inputError, 'Please enter a topic to begin your journey.');
                    return;
                }

                journeyState.currentTopic = topic;
                journeyState.steps = [];
                journeyState.currentStepIndex = -1;
                journeyState.aiConversationHistory = [];
                hideError(inputError);
                showLoading(inputLoading);
                startJourneyBtn.disabled = true;

                const initialPrompt = `You are the AI Genius Oracle. The user wants to explore the complex topic: "${topic}". Generate the *first* insightful question about this topic. Also, provide three distinct short phrases (1-3 words each) that represent three different interpretive lenses or perspectives through which this question could be viewed (e.g., "Optimistic View", "Pessimistic Angle", "Neutral Analysis"). Format your response clearly, exactly as follows:
Question: [Your question here]
Perspectives:
- [Phrase 1]
- [Phrase 2]
- [Phrase 3]
Ensure the question is open-ended and encourages deep thought.`;

                journeyState.aiConversationHistory.push({ role: 'user', content: initialPrompt });

                try {
                    const aiResponse = await callAI(
                        `You are the AI Genius Oracle, guiding an intellectual journey. Respond only with the requested question and perspective phrases based on the user's topic. Adhere strictly to the requested format.`,
                        JSON.stringify(journeyState.aiConversationHistory)
                    );

                    journeyState.aiConversationHistory.push({ role: 'assistant', content: aiResponse });

                    const lines = aiResponse.split('\n').filter(line => line.trim() !== '');
                    let question = '';
                    const perspectives = [];
                    let parsingMode = null;

                    for (const line of lines) {
                        if (line.startsWith('Question:')) {
                            question = line.substring('Question:'.length).trim();
                            parsingMode = 'question';
                        } else if (line.startsWith('Perspectives:')) {
                            parsingMode = 'perspectives';
                        } else if (parsingMode === 'perspectives' && line.startsWith('-')) {
                            perspectives.push(line.substring('-'.length).trim());
                        } else if (parsingMode === 'question') {
                             question += ' ' + line.trim();
                        }
                    }

                    if (!question || perspectives.length !== 3) {
                         throw new Error("Failed to parse initial AI response for question and perspectives. Received: " + aiResponse);
                    }

                    journeyState.steps.push({
                        question: question,
                        chosenPerspectiveImageUrl: null,
                        answer: null,
                        answerImageUrl: null,
                        perspectivePrompt: null,
                        perspectiveOptions: perspectives
                    });
                    journeyState.currentStepIndex++;

                    hideLoading(inputLoading);
                    startJourneyBtn.disabled = false;
                    showSection(journeySection);
                    presentQuestion();

                } catch (error) {
                    hideLoading(inputLoading);
                    startJourneyBtn.disabled = false;
                    showError(inputError, `Error starting journey: ${error.message}`);
                }
            }

            async function presentQuestion() {
                const currentStep = journeyState.steps[journeyState.currentStepIndex];
                currentTopicDisplay.textContent = `Topic: ${journeyState.currentTopic}`;
                questionText.textContent = currentStep.question;
                answerArea.classList.add('d-none');
                questionArea.classList.remove('d-none');
                perspectiveOptions.innerHTML = '';
                hideError(questionError);
                hideError(answerError);
                 hideError(answerImageError);
                updateProgressBar();
                nextStepBtn.disabled = true;

                const imagePromises = currentStep.perspectiveOptions.map(async (perspective, index) => {
                    const imagePrompt = `Visualize the concept of "${journeyState.currentTopic}" seen through the lens of a "${perspective}" perspective. The style should be abstract or conceptual, not literal. Avoid text. Keep the image focused on the feeling or idea of this perspective on the topic.`;
                     const container = document.createElement('div');
                     container.className = 'col perspective-option-container';
                     container.innerHTML = `
                        <div class="perspective-loading-overlay">
                             <div class="spinner-border text-light spinner-border-sm" role="status"></div>
                             <small class="mt-1 text-center">Loading ${perspective}...</small>
                        </div>
                        <img src="" class="img-fluid rounded perspective-option-img d-none" alt="Perspective: ${perspective}" data-perspective-index="${index}">
                     `;
                     perspectiveOptions.appendChild(container);

                     const imgElement = container.querySelector('img');
                     const loadingOverlay = container.querySelector('.perspective-loading-overlay');

                    try {
                        const imageUrl = await generateImage(imagePrompt, '1:1', 'vivid');
                        imgElement.src = imageUrl;
                        imgElement.classList.remove('d-none');
                        hideLoading(loadingOverlay);

                         imgElement.addEventListener('click', () => handlePerspectiveChoice(index));

                    } catch (error) {
                        console.error(`Error generating image for perspective "${perspective}":`, error);
                        hideLoading(loadingOverlay);
                        container.innerHTML = `<div class="alert alert-warning text-center m-0"><small>Image failed for "${perspective}".</small></div>`;
                    }
                });

                 Promise.all(imagePromises).then(() => {
                     // All image attempts are done, options are ready (or placeholders are shown)
                 });
            }

            async function handlePerspectiveChoice(chosenIndex) {
                 const currentStep = journeyState.steps[journeyState.currentStepIndex];
                 const chosenPerspective = currentStep.perspectiveOptions[chosenIndex];
                 currentStep.perspectivePrompt = chosenPerspective;

                 const optionImages = perspectiveOptions.querySelectorAll('.perspective-option-img');
                 optionImages.forEach((img, index) => {
                     img.classList.remove('selected');
                     img.style.pointerEvents = 'none';
                     if (index === chosenIndex) {
                         img.classList.add('selected');

                         currentStep.chosenPerspectiveImageUrl = img.src;
                     }
                 });

                showLoading(answerLoading);
                hideError(answerError);
                 hideError(answerImageError);
                questionArea.classList.add('d-none');

                const answerPrompt = `Based on the previous question: "${currentStep.question}" about the topic "${journeyState.currentTopic}", and specifically considering the "${chosenPerspective}" perspective, provide a concise, insightful essay-style answer. Synthesize diverse viewpoints relevant to this perspective. Also, provide a short phrase (3-5 words) that captures the core visual concept of your answer, to be used for image generation. Format your response clearly, exactly as follows:
Answer: [Your essay-style answer here]
Visual Concept: [Short phrase here]
Ensure the answer is insightful and aligns with the chosen perspective.`;

                journeyState.aiConversationHistory.push({ role: 'user', content: answerPrompt });

                try {
                     const aiResponse = await callAI(
                        `You are the AI Genius Oracle. Provide a concise, insightful answer based on the user's chosen perspective and the previous question, and a short visual concept phrase. Adhere strictly to the requested format.`,
                         JSON.stringify(journeyState.aiConversationHistory)
                     );

                     journeyState.aiConversationHistory.push({ role: 'assistant', content: aiResponse });

                    const answerLines = aiResponse.split('\n').filter(line => line.trim() !== '');
                    let answerTextContent = '';
                    let visualConcept = '';
                    let parsingMode = null;

                    for (const line of answerLines) {
                        if (line.startsWith('Answer:')) {
                            answerTextContent = line.substring('Answer:'.length).trim();
                            parsingMode = 'answer';
                        } else if (line.startsWith('Visual Concept:')) {
                            visualConcept = line.substring('Visual Concept:'.length).trim();
                            parsingMode = 'visual';
                        } else if (parsingMode === 'answer') {
                             answerTextContent += '\n' + line.trim();
                        }
                    }

                     if (!answerTextContent || !visualConcept) {
                         throw new Error("Failed to parse AI response for answer or visual concept. Received: " + aiResponse);
                     }

                    currentStep.answer = answerTextContent;
                    answerText.innerHTML = currentStep.answer.replace(/\n/g, '<br>');

                    showLoading(answerImageLoading);
                    answerImageContainer.innerHTML = '';

                     const answerImagePrompt = `Visualize the concept: "${visualConcept}" related to the topic "${journeyState.currentTopic}" and the perspective "${chosenPerspective}". The style should complement the topic and perspective. Avoid text.`;

                    try {
                        const answerImageUrl = await generateImage(answerImagePrompt, '16:9', 'vivid');
                        currentStep.answerImageUrl = answerImageUrl;
                        answerImageContainer.innerHTML = `<img src="${answerImageUrl}" class="img-fluid rounded" alt="Visualization of answer concept">`;
                        hideLoading(answerImageLoading);

                    } catch (imgError) {
                         console.error('Error generating answer image:', imgError);
                         currentStep.answerImageUrl = null;
                         hideLoading(answerImageLoading);
                         showError(answerImageError, 'Failed to generate answer image.');
                    }

                    answerArea.classList.remove('d-none');
                    hideLoading(answerLoading);
                    nextStepBtn.disabled = false;

                } catch (error) {
                    hideLoading(answerLoading);
                    nextStepBtn.disabled = true;
                    showError(answerError, `Error getting Oracle's insight: ${error.message}. Please end your journey.`);
                }
            }

            async function goToNextStep() {
                 if (journeyState.currentStepIndex >= journeyState.maxSteps - 1) {
                     endJourney();
                     return;
                 }

                 nextStepBtn.disabled = true;
                 showLoading(answerLoading);

                 const nextQuestionPrompt = `Based on the previous question ("${journeyState.steps[journeyState.currentStepIndex].question}") and the chosen perspective ("${journeyState.steps[journeyState.currentStepIndex].perspectivePrompt}") about the topic "${journeyState.currentTopic}", generate the *next* insightful question that continues the exploration, potentially branching or going deeper. Also, provide three distinct short phrases (1-3 words each) that represent three different interpretive lenses or perspectives through which this *new* question could be viewed. Format your response clearly, exactly as follows:
Question: [Your next question here]
Perspectives:
- [Phrase 1]
- [Phrase 2]
- [Phrase 3]
Ensure the question is open-ended and encourages deep thought, building on the previous step.`;

                 journeyState.aiConversationHistory.push({ role: 'user', content: nextQuestionPrompt });

                 try {
                    const aiResponse = await callAI(
                        `You are the AI Genius Oracle, guiding an intellectual journey. Provide the next question and perspective phrases based on the conversation history. Adhere strictly to the requested format.`,
                         JSON.stringify(journeyState.aiConversationHistory)
                    );

                    journeyState.aiConversationHistory.push({ role: 'assistant', content: aiResponse });

                    const lines = aiResponse.split('\n').filter(line => line.trim() !== '');
                    let question = '';
                    const perspectives = [];
                    let parsingMode = null;

                    for (const line of lines) {
                        if (line.startsWith('Question:')) {
                            question = line.substring('Question:'.length).trim();
                            parsingMode = 'question';
                        } else if (line.startsWith('Perspectives:')) {
                            parsingMode = 'perspectives';
                        } else if (parsingMode === 'perspectives' && line.startsWith('-')) {
                            perspectives.push(line.substring('-'.length).trim());
                        } else if (parsingMode === 'question') {
                             question += ' ' + line.trim();
                        }
                    }

                    if (!question || perspectives.length !== 3) {
                         throw new Error("Failed to parse AI response for next question and perspectives. Received: " + aiResponse);
                    }

                    journeyState.steps.push({
                        question: question,
                        chosenPerspectiveImageUrl: null,
                        answer: null,
                        answerImageUrl: null,
                        perspectivePrompt: null,
                        perspectiveOptions: perspectives
                    });
                    journeyState.currentStepIndex++;

                    hideLoading(answerLoading);
                    nextStepBtn.disabled = false;
                    presentQuestion();

                 } catch (error) {
                    hideLoading(answerLoading);
                    nextStepBtn.disabled = true;
                    showError(answerError, `Error preparing next step: ${error.message}. Ending journey.`);
                    setTimeout(endJourney, 3000); // Give user time to read error
                 }
            }

            function viewJourneyLog() {
                logContent.innerHTML = '';
                if (journeyState.steps.length === 0) {
                    logContent.innerHTML = '<p class="text-center">Your journey log is empty.</p>';
                } else {
                    journeyState.steps.forEach((step, index) => {
                        const logEntry = document.createElement('div');
                        logEntry.className = 'card bg-dark text-white mb-3';
                        logEntry.innerHTML = `
                            <div class="card-header">Step ${index + 1}</div>
                            <div class="card-body">
                                <h5 class="card-title">${step.question}</h5>
                                ${step.chosenPerspectiveImageUrl ?
                                    `<p class="card-text mt-3"><strong>Chosen Perspective:</strong> <em>${step.perspectivePrompt || 'N/A'}</em></p>
                                     <img src="${step.chosenPerspectiveImageUrl}" class="img-fluid rounded mb-3" alt="Chosen Perspective Image" style="max-height: 150px; object-fit: cover;">`
                                    : '<p class="card-text text-warning mt-3">Perspective image not available.</p>'}
                                <h6 class="card-subtitle mb-2 text-muted">Oracle's Insight:</h6>
                                <p class="card-text">${step.answer ? step.answer.replace(/\n/g, '<br>') : 'Answer not available.'}</p>
                                 ${step.answerImageUrl ?
                                    `<img src="${step.answerImageUrl}" class="img-fluid rounded mt-3" alt="Answer Visualization" style="max-height: 200px; object-fit: cover;">`
                                    : (step.answer ? '<p class="card-text text-warning mt-3">Answer visualization not available.</p>' : '')}
                            </div>
                        `;
                        logContent.appendChild(logEntry);
                    });
                }
                showSection(logSection);
            }

            function hideJourneyLog() {
                showSection(journeySection);
            }

            function endJourney() {
                showSection(reportSection);
                generateOracleReport();
            }

            function generateOracleReport() {
                reportSummaryText.textContent = `You explored the topic "${journeyState.currentTopic}" over ${journeyState.steps.length} steps. Your journey took you through various perspectives, uncovering insights into its multifaceted nature.`;

                reportImageCollage.innerHTML = '';
                let imageCount = 0;
                if (journeyState.steps.length === 0) {
                     reportImageCollage.innerHTML = '<p class="text-center col-12">No images generated during this journey.</p>';
                } else {
                    journeyState.steps.forEach(step => {
                        if (step.chosenPerspectiveImageUrl) {
                            const imgCol = document.createElement('div');
                            imgCol.className = 'col';
                            imgCol.innerHTML = `<img src="${step.chosenPerspectiveImageUrl}" class="img-fluid rounded" alt="Perspective image from journey">`;
                            reportImageCollage.appendChild(imgCol);
                            imageCount++;
                        }
                         if (step.answerImageUrl) {
                            const imgCol = document.createElement('div');
                            imgCol.className = 'col';
                            imgCol.innerHTML = `<img src="${step.answerImageUrl}" class="img-fluid rounded" alt="Answer image from journey">`;
                            reportImageCollage.appendChild(imgCol);
                             imageCount++;
                        }
                    });
                }
                if (imageCount === 0) {
                     reportImageCollage.innerHTML = '<p class="text-center col-12">No images were successfully generated during this journey.</p>';
                }

                downloadReportBtn.disabled = true;
            }

            function restartJourney() {
                journeyState = {
                    currentTopic: '',
                    steps: [],
                    currentStepIndex: -1,
                    aiConversationHistory: [],
                    maxSteps: 7
                };
                topicInput.value = '';
                hideError(inputError);
                hideError(questionError);
                hideError(answerError);
                hideError(answerImageError);
                showSection(inputSection);
            }

            startJourneyBtn.addEventListener('click', startJourney);
            nextStepBtn.addEventListener('click', goToNextStep);
            viewLogBtn.addEventListener('click', viewJourneyLog);
            hideLogBtn.addEventListener('click', hideJourneyLog);
            endJourneyBtn.addEventListener('click', endJourney);
            restartJourneyBtn.addEventListener('click', restartJourney);

            topicInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    startJourney();
                }
            });

            document.addEventListener('DOMContentLoaded', () => {
                showSection(inputSection);
            });

        })();
    </script>

<!-- Injectable Console Log Copier Snippet -->
<div id="appgen2025ConsoleCopyUtil" style="position: fixed; top: 5px; right: 5px; z-index: 9999; padding: 5px; background-color: rgba(0,0,0,0.7); border-radius: 5px; cursor: default;" title="Copy Console Logs for this Tab">
    <button type="button" style="background: none; border: 1px solid #fff; color: #fff; padding: 3px 8px; font-size: 10px; border-radius: 3px; cursor: pointer;">Copy Logs</button>
</div>
<script>
    (function() {
        const utilContainer = document.getElementById('appgen2025ConsoleCopyUtil');
        if (utilContainer) {
            const originalConsoleLog = console.log;
            const originalConsoleError = console.error;
            const originalConsoleWarn = console.warn;
            const originalConsoleInfo = console.info;
            const originalConsoleDebug = console.debug;
            const logs = [];
            function formatLog(type, args) {
                const timestamp = new Date().toISOString();
                const message = Array.from(args).map(arg => {
                    try {
                        if (arg instanceof Error) return arg.stack || arg.toString();
                        if (typeof arg === 'object' && arg !== null) {
                            const getCircularReplacer = () => { const seen = new WeakSet(); return (key, value) => { if (typeof value === "object" && value !== null) { if (seen.has(value)) { return "[Circular]"; } seen.add(value); } return value; }; };
                            return JSON.stringify(arg, getCircularReplacer(), 2);
                        }
                        return String(arg);
                    } catch (e) { return '[Unserializable Object]'; }
                }).join(' ');
                return `[${timestamp}] [${type.toUpperCase()}] ${message}`;
            }
            console.log = function(...args) { const formatted = formatLog('log', args); logs.push(formatted); originalConsoleLog.apply(console, args); };
            console.error = function(...args) { const formatted = formatLog('error', args); logs.push(formatted); originalConsoleError.apply(console, args); };
            console.warn = function(...args) { const formatted = formatLog('warn', args); logs.push(formatted); originalConsoleWarn.apply(console, args); };
            console.info = function(...args) { const formatted = formatLog('info', args); logs.push(formatted); originalConsoleInfo.apply(console, args); };
            console.debug = function(...args) { const formatted = formatLog('debug', args); logs.push(formatted); originalConsoleDebug.apply(console, args); };
            window.onerror = function(message, source, lineno, colno, error) { const errorObj = error || {}; const formatted = formatLog('uncaught_error', [message, `at ${source}:${lineno}:${colno}`, errorObj.stack || '(no stack)']); logs.push(formatted); originalConsoleError.call(console, 'Uncaught Error:', message, 'at', source + ':' + lineno + ':' + colno, error); return false; };
            window.onunhandledrejection = function(event) { const reason = event.reason || {}; const formatted = formatLog('unhandled_rejection', [reason.message || reason, reason.stack || '(no stack)']); logs.push(formatted); originalConsoleError.call(console, 'Unhandled Rejection:', event.reason); };
            const copyButton = utilContainer.querySelector('button');
            if (copyButton) {
                copyButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (logs.length === 0) { alert('No console logs captured yet to copy.'); return; }
                    const logText = logs.join('\n');
                    navigator.clipboard.writeText(logText).then(function() {
                        const originalText = copyButton.textContent; copyButton.textContent = 'Copied!'; copyButton.style.background = '#28a745'; copyButton.style.borderColor = '#28a745';
                        setTimeout(function() { copyButton.textContent = originalText; copyButton.style.background = 'none'; copyButton.style.borderColor = '#fff'; }, 2000);
                        originalConsoleInfo.call(console, 'AppGen2025 Util: Console logs copied to clipboard.');
                    }).catch(function(err) {
                        originalConsoleError.call(console, 'AppGen2025 Util: Failed to copy console logs - ', err.name, err.message);
                        alert('Failed to copy logs. See browser console for details. Logs may be too large or permissions denied.');
                        const originalText = copyButton.textContent; copyButton.textContent = 'Failed!'; copyButton.style.background = '#dc3545'; copyButton.style.borderColor = '#dc3545';
                        setTimeout(function() { copyButton.textContent = originalText; copyButton.style.background = 'none'; copyButton.style.borderColor = '#fff'; }, 3000);
                    });
                });
            }
        } else { console.error('AppGen2025 Util: Container element "appgen2025ConsoleCopyUtil" not found. Ensure it is correctly injected or present in the HTML.'); }
    })();
</script>
<!-- End of Injectable Snippet -->

</body>
</html>