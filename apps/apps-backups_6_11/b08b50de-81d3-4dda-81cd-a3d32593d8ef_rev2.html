<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statscan Data Explorer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .navbar-brand svg {
            color: var(--bs-primary);
        }
        .card {
            border: 1px solid #4a5568;
            background-color: #2d3748;
        }
        .card-header {
            border-bottom: 1px solid #4a5568;
        }
        .form-select,
        .form-control {
            background-color: #2d3748;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        .form-select:focus,
        .form-control:focus {
            background-color: #2d3748;
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            color: #e2e8f0;
        }
        .form-select option {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        .table-dark {
            --bs-table-bg: #2d3748;
            --bs-table-striped-bg: #3a475a;
            --bs-table-hover-bg: #4a5568;
            --bs-table-color: #e2e8f0;
            --bs-table-border-color: #4a5568;
        }
        .table-dark th[data-column] {
            cursor: pointer;
        }
        .table-dark th[data-column]:hover {
            background-color: #3a475a;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .footer {
            background-color: #2d3748;
            border-top: 1px solid #4a5568;
            padding: 1rem 0;
            margin-top: auto;
        }
        .modal-content {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        .modal-header, .modal-footer {
            border-color: #4a5568;
        }
    </style>
</head>
<body data-bs-theme="dark">
    <header class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#" aria-label="Statscan Data Explorer homepage">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-bar-chart-fill me-2" viewBox="0 0 16 16">
                    <path d="M1 11.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5zm5 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5zm5 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5z"/>
                    <path d="M.997 4.936a.5.5 0 0 1 .498-.592l3-1a.5.5 0 0 1 .192.17L6 4.793V2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v10.5a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5V7.207l-2.808-2.808a.5.5 0 0 1-.092-.17zm8 0a.5.5 0 0 1 .498-.592l3-1a.5.5 0 0 1 .192.17L14 4.793V2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v10.5a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5V7.207l-2.808-2.808a.5.5 0 0 1-.092-.17z"/>
                </svg>
                Statscan Data Explorer
            </a>
            <button class="btn btn-outline-info btn-sm ms-auto" id="aboutDatasetBtn" data-bs-toggle="modal" data-bs-target="#datasetInfoModal" aria-label="About current dataset">
                <i class="bi bi-info-circle-fill me-1"></i> About Dataset
            </button>
        </div>
    </header>

    <main class="container-fluid py-4 flex-grow-1">
        <div id="loadingIndicator" class="text-center my-5 d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted" id="loadingMessage">Fetching data from Statistics Canada...</p>
        </div>

        <div id="errorMessage" class="alert alert-danger d-none" role="alert">
            <h4 class="alert-heading">Data Load Error!</h4>
            <p id="errorDetails"></p>
            <hr>
            <p class="mb-0">Please check your internet connection or try again later. If the issue persists, the Statistics Canada API might be temporarily unavailable or the dataset ID could be incorrect.</p>
        </div>

        <div id="noDataMessage" class="alert alert-warning d-none" role="alert">
            <h4 class="alert-heading">No Data Found!</h4>
            <p>Your current filter selections yielded no data. Please adjust your filters and try again.</p>
        </div>

        <div id="dashboardContent" class="d-none">
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card text-bg-dark">
                        <div class="card-body d-flex flex-column flex-md-row align-items-md-center">
                            <label for="datasetSelect" class="form-label mb-2 mb-md-0 me-md-3">Select Dataset:</label>
                            <select class="form-select flex-grow-1" id="datasetSelect" aria-label="Select Statistics Canada Dataset"></select>
                            <button id="refreshDataBtn" class="btn btn-primary ms-md-3 mt-2 mt-md-0" aria-label="Refresh data">
                                <i class="bi bi-arrow-clockwise me-1"></i> Refresh Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-lg-3">
                    <div class="card text-bg-dark h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Data Filters</h5>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title text-primary" id="datasetName"></h6>
                            <p class="card-text text-muted small" id="datasetDescription"></p>
                            <div id="filtersContainer" class="mt-3"></div>
                            <button id="resetFiltersBtn" class="btn btn-outline-light btn-sm mt-3 w-100" aria-label="Reset all filters">Reset Filters</button>
                            <button id="downloadDataBtn" class="btn btn-primary btn-sm mt-2 w-100" aria-label="Download current data as CSV">Download CSV</button>
                        </div>
                    </div>
                </div>

                <div class="col-lg-9">
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="card text-bg-dark h-100">
                                <div class="card-body">
                                    <h5 class="card-title text-primary">Latest Value</h5>
                                    <p class="card-text fs-3 mb-0" id="latestValue"></p>
                                    <small class="text-muted" id="latestValueDate"></small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-bg-dark h-100">
                                <div class="card-body">
                                    <h5 class="card-title text-primary">Change (Last Period)</h5>
                                    <p class="card-text fs-3 mb-0" id="changeValue"></p>
                                    <small class="text-muted" id="changePercentage"></small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-bg-dark h-100">
                                <div class="card-body">
                                    <h5 class="card-title text-primary">Average Value</h5>
                                    <p class="card-text fs-3" id="averageValue"></p>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="card text-bg-dark">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Data Trend</h5>
                                    <div class="d-flex align-items-center">
                                        <label for="chartTypeSelect" class="form-label mb-0 me-2 small text-muted">Chart Type:</label>
                                        <select class="form-select form-select-sm" id="chartTypeSelect" aria-label="Select chart type">
                                            <option value="line">Line Chart</option>
                                            <option value="bar">Bar Chart</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="dataChart" role="img" aria-label="Data trend chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="card text-bg-dark">
                                <div class="card-header">
                                    <h5 class="mb-0">Raw Data Table</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-dark table-striped table-hover caption-top" aria-label="Filtered data table">
                                            <caption class="text-muted">Filtered data from Statistics Canada. Click on column headers to sort.</caption>
                                            <thead id="dataTableHead"></thead>
                                            <tbody id="dataTableBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer text-center text-muted small">
        <div class="container-fluid">
            Data provided by <a href="https://www.statcan.gc.ca/eng/developers/wds" target="_blank" class="text-primary text-decoration-none">Statistics Canada Open Data API</a>.
        </div>
    </footer>

    <div class="modal fade" id="datasetInfoModal" tabindex="-1" aria-labelledby="datasetInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
            <div class="modal-content text-bg-dark">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="modal-title" id="datasetInfoModalLabel">About Dataset: <span id="modalDatasetName"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalDatasetInfoBody">
                    <p class="text-muted text-center">Loading dataset metadata...</p>
                </div>
                <div class="modal-footer border-top border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <a id="modalDatasetSourceLink" href="#" target="_blank" class="btn btn-primary">View on Statscan Website</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        const appState = {
            isLoading: false,
            error: null,
            rawData: null,
            processedData: [],
            dimensions: {},
            dimensionLabels: {},
            currentFilters: {},
            filteredData: [],
            chartInstance: null,
            chartType: 'line',
            availableDatasets: [
                { id: '17100005', name: 'Population estimates, quarterly', description: 'Population estimates by age group, sex, and geography, quarterly. Data is subject to revision.', sourceUrl: 'https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1710000501' },
                { id: '18100004', name: 'Consumer Price Index (CPI), monthly', description: 'Monthly Consumer Price Index (CPI) for Canada, provinces, and selected cities.', sourceUrl: 'https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1810000401' },
                { id: '36100103', name: 'Gross domestic product (GDP), by industry', description: 'Gross domestic product (GDP) at basic prices, by industry, monthly.', sourceUrl: 'https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=3610010301' },
                { id: '13100782', name: 'Labour Force Survey (LFS)', description: 'Labour Force Survey (LFS) estimates, by selected demographic characteristics, seasonally adjusted and unadjusted, monthly.', sourceUrl: 'https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1310078201' },
                { id: '35100001', name: 'Building permits, by type of structure', description: 'Building permits, by type of structure, residential and non-residential, monthly.', sourceUrl: 'https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=3510000101' }
            ],
            currentDatasetId: '17100005',
            currentDatasetMetadata: null,
            sortColumn: null,
            sortDirection: 'asc',
            chartColors: {
                primary: 'rgb(13, 110, 253)',
                secondary: 'rgb(108, 117, 125)',
                success: 'rgb(25, 135, 84)',
                info: 'rgb(13, 202, 240)',
                warning: 'rgb(255, 193, 7)',
                danger: 'rgb(220, 53, 69)',
                lightText: '#e2e8f0',
                gridLine: 'rgba(74, 85, 104, 0.5)',
                tooltipBg: '#2d3748',
                tooltipBorder: '#4a5568',
                dataBackground: 'rgba(13, 110, 253, 0.4)',
                dataBorder: 'rgb(13, 110, 253)'
            }
        };

        const DOM = {
            loadingIndicator: document.getElementById('loadingIndicator'),
            loadingMessage: document.getElementById('loadingMessage'),
            errorMessage: document.getElementById('errorMessage'),
            errorDetails: document.getElementById('errorDetails'),
            noDataMessage: document.getElementById('noDataMessage'),
            dashboardContent: document.getElementById('dashboardContent'),
            datasetSelect: document.getElementById('datasetSelect'),
            refreshDataBtn: document.getElementById('refreshDataBtn'),
            datasetName: document.getElementById('datasetName'),
            datasetDescription: document.getElementById('datasetDescription'),
            filtersContainer: document.getElementById('filtersContainer'),
            resetFiltersBtn: document.getElementById('resetFiltersBtn'),
            downloadDataBtn: document.getElementById('downloadDataBtn'),
            latestValue: document.getElementById('latestValue'),
            latestValueDate: document.getElementById('latestValueDate'),
            changeValue: document.getElementById('changeValue'),
            changePercentage: document.getElementById('changePercentage'),
            averageValue: document.getElementById('averageValue'),
            dataChart: document.getElementById('dataChart'),
            chartTypeSelect: document.getElementById('chartTypeSelect'),
            dataTableHead: document.getElementById('dataTableHead'),
            dataTableBody: document.getElementById('dataTableBody'),
            aboutDatasetBtn: document.getElementById('aboutDatasetBtn'),
            modalDatasetName: document.getElementById('modalDatasetName'),
            modalDatasetInfoBody: document.getElementById('modalDatasetInfoBody'),
            modalDatasetSourceLink: document.getElementById('modalDatasetSourceLink')
        };

        function updateLoadingState(message = 'Fetching data from Statistics Canada...') {
            appState.isLoading = true;
            DOM.loadingMessage.textContent = message;
            DOM.loadingIndicator.classList.remove('d-none');
            DOM.dashboardContent.classList.add('d-none');
            hideMessages();
        }

        function hideLoadingState() {
            appState.isLoading = false;
            DOM.loadingIndicator.classList.add('d-none');
        }

        function showErrorMessage(message) {
            DOM.errorMessage.classList.remove('d-none');
            DOM.errorDetails.innerHTML = message;
            DOM.dashboardContent.classList.add('d-none');
            DOM.noDataMessage.classList.add('d-none');
        }

        function hideMessages() {
            DOM.errorMessage.classList.add('d-none');
            DOM.noDataMessage.classList.add('d-none');
        }

        async function fetchAndProcessData(cubeId) {
            updateLoadingState('Fetching data from Statistics Canada...');
            const selectedDataset = appState.availableDatasets.find(ds => ds.id === cubeId);
            if (selectedDataset) {
                DOM.datasetName.textContent = selectedDataset.name;
                DOM.datasetDescription.textContent = selectedDataset.description;
            } else {
                DOM.datasetName.textContent = 'Unknown Dataset';
                DOM.datasetDescription.textContent = '';
            }

            try {
                const url = `https://www150.statcan.gc.ca/t1/wds/rest/json/getSeriesByCubeAndLatestNPeriods?cubeId=${cubeId}&latestN=100`;
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status} (${response.statusText})`);
                }

                const data = await response.json();

                if (data.status && data.status !== 'SUCCESS') {
                    throw new Error(`Statscan API error: ${data.message || 'Unknown API error'}`);
                }
                if (!data.object || data.object.length === 0 || !data.object[0].series || !data.object[0].dimension) {
                    throw new Error('Data structure error: Expected series or dimension data not found in API response. This dataset might not be supported or the API format has changed.');
                }

                appState.rawData = data;
                processRawData(data);
                appState.sortColumn = null;
                appState.sortDirection = 'asc';
                applyFiltersAndRender();
                DOM.dashboardContent.classList.remove('d-none');
            } catch (error) {
                let userMessage = '';
                if (error.message.includes('HTTP error!')) {
                    userMessage = `<strong>Network/Server Error:</strong> ${error.message}. Please check your internet connection.`;
                } else if (error.message.includes('Statscan API error:')) {
                    userMessage = `<strong>Statscan API Error:</strong> ${error.message}. The requested dataset might not be available or its ID is incorrect.`;
                } else if (error.message.includes('Data structure error:')) {
                    userMessage = `<strong>Data Structure Error:</strong> ${error.message}. The API response format was unexpected.`;
                } else {
                    userMessage = `<strong>Unexpected Error:</strong> ${error.message}. Please try again later.`;
                }
                showErrorMessage(userMessage);
            } finally {
                hideLoadingState();
            }
        }

        function processRawData(data) {
            appState.processedData = [];
            appState.dimensions = {};
            appState.dimensionLabels = {};
            appState.currentFilters = {};

            const cube = data.object[0];
            const dimensionMetadata = cube.dimension;

            for (const dimKey in dimensionMetadata) {
                if (Object.prototype.hasOwnProperty.call(dimensionMetadata, dimKey)) {
                    const dim = dimensionMetadata[dimKey];
                    appState.dimensionLabels[dimKey] = dim.label;
                    appState.dimensions[dim.label] = new Set();
                }
            }

            cube.series.forEach(series => {
                const dataPoint = {};
                let isValid = true;

                dataPoint[appState.dimensionLabels.REF_DATE] = series.refPeriod;
                dataPoint['Value'] = parseFloat(series.value);

                for (const dimKey in series.dimensions) {
                    if (Object.prototype.hasOwnProperty.call(series.dimensions, dimKey)) {
                        const categoryIndex = series.dimensions[dimKey];
                        const dimensionLabel = appState.dimensionLabels[dimKey];
                        if (dimensionLabel && dimensionMetadata[dimKey] && dimensionMetadata[dimKey].category && dimensionMetadata[dimKey].category.label) {
                            const categoryLabel = dimensionMetadata[dimKey].category.label[dimensionMetadata[dimKey].category.index[categoryIndex]];
                            dataPoint[dimensionLabel] = categoryLabel;
                            appState.dimensions[dimensionLabel].add(categoryLabel);
                        } else {
                            isValid = false;
                            break;
                        }
                    }
                }
                if (isValid) {
                    appState.processedData.push(dataPoint);
                }
            });

            for (const dimLabel in appState.dimensions) {
                if (Object.prototype.hasOwnProperty.call(appState.dimensions, dimLabel)) {
                    appState.dimensions[dimLabel] = Array.from(appState.dimensions[dimLabel]).sort();
                    appState.currentFilters[dimLabel] = 'All';
                }
            }
        }

        function parseRefDateForSorting(dateString) {
            if (dateString.match(/^\d{4}-\d{2}$/)) {
                return new Date(dateString + '-01');
            }
            return new Date(dateString);
        }

        function applyFiltersAndRender() {
            hideMessages();
            appState.filteredData = appState.processedData.filter(item => {
                for (const dimLabel in appState.currentFilters) {
                    if (Object.prototype.hasOwnProperty.call(appState.currentFilters, dimLabel)) {
                        const filterValue = appState.currentFilters[dimLabel];
                        if (filterValue !== 'All' && item[dimLabel] !== filterValue) {
                            return false;
                        }
                    }
                }
                return true;
            });

            if (appState.filteredData.length === 0) {
                DOM.noDataMessage.classList.remove('d-none');
                DOM.latestValue.textContent = 'N/A';
                DOM.latestValueDate.textContent = '';
                DOM.changeValue.textContent = 'N/A';
                DOM.changePercentage.textContent = '';
                DOM.averageValue.textContent = 'N/A';
                if (appState.chartInstance) {
                    appState.chartInstance.destroy();
                    appState.chartInstance = null;
                }
                DOM.dataTableHead.innerHTML = '';
                DOM.dataTableBody.innerHTML = '';
            } else {
                DOM.noDataMessage.classList.add('d-none');
                updateUI();
            }
        }

        function updateUI() {
            renderFilters();
            renderSummary();
            renderChart();
            renderTable();
        }

        function populateDatasetSelect() {
            DOM.datasetSelect.innerHTML = '';
            appState.availableDatasets.forEach(dataset => {
                const option = document.createElement('option');
                option.value = dataset.id;
                option.textContent = dataset.name;
                DOM.datasetSelect.appendChild(option);
            });
            DOM.datasetSelect.value = appState.currentDatasetId;
        }

        function renderFilters() {
            DOM.filtersContainer.innerHTML = '';

            for (const dimLabel in appState.dimensions) {
                if (Object.prototype.hasOwnProperty.call(appState.dimensions, dimLabel)) {
                    if (dimLabel === appState.dimensionLabels.REF_DATE) continue;

                    const div = document.createElement('div');
                    div.classList.add('mb-3');

                    const label = document.createElement('label');
                    label.classList.add('form-label', 'small', 'text-muted');
                    label.textContent = dimLabel + ':';
                    label.setAttribute('for', `filter-${dimLabel.replace(/\s/g, '-')}`);

                    const select = document.createElement('select');
                    select.classList.add('form-select', 'form-select-sm');
                    select.id = `filter-${dimLabel.replace(/\s/g, '-')}`;
                    select.setAttribute('data-dimension', dimLabel);
                    select.setAttribute('aria-label', `Filter by ${dimLabel}`);

                    const allOption = document.createElement('option');
                    allOption.value = 'All';
                    allOption.textContent = 'All';
                    select.appendChild(allOption);

                    appState.dimensions[dimLabel].forEach(value => {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value;
                        select.appendChild(option);
                    });

                    select.value = appState.currentFilters[dimLabel];

                    div.appendChild(label);
                    div.appendChild(select);
                    DOM.filtersContainer.appendChild(div);
                }
            }
        }

        function renderSummary() {
            if (appState.filteredData.length === 0) {
                return;
            }

            const sortedData = [...appState.filteredData].sort((a, b) => {
                const dateA = parseRefDateForSorting(a[appState.dimensionLabels.REF_DATE]);
                const dateB = parseRefDateForSorting(b[appState.dimensionLabels.REF_DATE]);
                return dateA.getTime() - dateB.getTime();
            });

            const latest = sortedData[sortedData.length - 1];
            const previous = sortedData.length > 1 ? sortedData[sortedData.length - 2] : null;

            const latestVal = latest ? latest.Value : NaN;
            const previousVal = previous ? previous.Value : NaN;

            DOM.latestValue.textContent = !isNaN(latestVal) ? latestVal.toLocaleString() : 'N/A';
            DOM.latestValueDate.textContent = latest ? `as of ${latest[appState.dimensionLabels.REF_DATE]}` : '';

            let change = 'N/A';
            let changePercent = '';
            DOM.changeValue.classList.remove('text-success', 'text-danger');
            if (!isNaN(latestVal) && !isNaN(previousVal)) {
                const diff = latestVal - previousVal;
                change = diff.toLocaleString();
                if (previousVal !== 0) {
                    changePercent = (diff / previousVal * 100).toFixed(2) + '%';
                }
                if (diff > 0) {
                    DOM.changeValue.classList.add('text-success');
                } else if (diff < 0) {
                    DOM.changeValue.classList.add('text-danger');
                }
            }
            DOM.changeValue.textContent = change;
            DOM.changePercentage.textContent = changePercent;

            const sum = appState.filteredData.reduce((acc, item) => acc + item.Value, 0);
            const average = appState.filteredData.length > 0 ? sum / appState.filteredData.length : 0;
            DOM.averageValue.textContent = !isNaN(average) ? average.toLocaleString(undefined, { maximumFractionDigits: 0 }) : 'N/A';
        }

        function renderChart() {
            if (appState.chartInstance) {
                appState.chartInstance.destroy();
            }

            const chartData = [...appState.filteredData].sort((a, b) => {
                const dateA = parseRefDateForSorting(a[appState.dimensionLabels.REF_DATE]);
                const dateB = parseRefDateForSorting(b[appState.dimensionLabels.REF_DATE]);
                return dateA.getTime() - dateB.getTime();
            });

            const labels = chartData.map(item => item[appState.dimensionLabels.REF_DATE]);
            const values = chartData.map(item => item.Value);

            const ctx = DOM.dataChart.getContext('2d');
            appState.chartInstance = new Chart(ctx, {
                type: appState.chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Value',
                        data: values,
                        backgroundColor: appState.chartColors.dataBackground,
                        borderColor: appState.chartColors.dataBorder,
                        borderWidth: 2,
                        fill: appState.chartType === 'line',
                        tension: appState.chartType === 'line' ? 0.3 : 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: appState.chartColors.lightText
                            }
                        },
                        tooltip: {
                            backgroundColor: appState.chartColors.tooltipBg,
                            borderColor: appState.chartColors.tooltipBorder,
                            borderWidth: 1,
                            titleColor: appState.chartColors.lightText,
                            bodyColor: appState.chartColors.lightText,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toLocaleString();
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: appState.chartColors.lightText
                            },
                            grid: {
                                color: appState.chartColors.gridLine
                            },
                            title: {
                                display: true,
                                text: appState.dimensionLabels.REF_DATE,
                                color: appState.chartColors.lightText
                            }
                        },
                        y: {
                            ticks: {
                                color: appState.chartColors.lightText,
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            },
                            grid: {
                                color: appState.chartColors.gridLine
                            },
                            title: {
                                display: true,
                                text: 'Value',
                                color: appState.chartColors.lightText
                            }
                        }
                    }
                }
            });
        }

        function renderTable() {
            DOM.dataTableHead.innerHTML = '';
            DOM.dataTableBody.innerHTML = '';

            if (appState.filteredData.length === 0) {
                return;
            }

            const headers = Object.keys(appState.filteredData[0]);
            const headerRow = document.createElement('tr');

            const dataToSort = [...appState.filteredData];

            if (appState.sortColumn) {
                dataToSort.sort((a, b) => {
                    const valA = a[appState.sortColumn];
                    const valB = b[appState.sortColumn];

                    if (appState.sortColumn === appState.dimensionLabels.REF_DATE) {
                        const dateA = parseRefDateForSorting(valA);
                        const dateB = parseRefDateForSorting(valB);
                        return appState.sortDirection === 'asc' ? dateA.getTime() - dateB.getTime() : dateB.getTime() - dateA.getTime();
                    }

                    if (typeof valA === 'number' && typeof valB === 'number') {
                        return appState.sortDirection === 'asc' ? valA - valB : valB - valA;
                    }

                    const strA = String(valA).toLowerCase();
                    const strB = String(valB).toLowerCase();
                    return appState.sortDirection === 'asc' ? strA.localeCompare(strB) : strB.localeCompare(strA);
                });
            }

            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.scope = 'col';
                th.textContent = headerText;
                th.classList.add('text-nowrap', 'align-middle');

                if (headerText !== appState.dimensionLabels.REF_DATE) {
                    th.setAttribute('data-column', headerText);
                    const icon = document.createElement('i');
                    icon.classList.add('ms-2', 'bi');
                    if (appState.sortColumn === headerText) {
                        icon.classList.add(appState.sortDirection === 'asc' ? 'bi-sort-up' : 'bi-sort-down');
                    } else {
                        icon.classList.add('bi-arrow-down-up');
                    }
                    th.appendChild(icon);
                }
                headerRow.appendChild(th);
            });
            DOM.dataTableHead.appendChild(headerRow);

            dataToSort.forEach(item => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = (header === 'Value' && !isNaN(item[header])) ? item[header].toLocaleString() : item[header];
                    tr.appendChild(td);
                });
                DOM.dataTableBody.appendChild(tr);
            });
        }

        function sortData(columnName) {
            if (appState.sortColumn === columnName) {
                appState.sortDirection = appState.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                appState.sortColumn = columnName;
                appState.sortDirection = 'asc';
            }
            renderTable();
        }

        function downloadCSV() {
            if (appState.filteredData.length === 0) {
                alert('No data to download.');
                return;
            }

            const headers = Object.keys(appState.filteredData[0]);
            const csvRows = [];
            csvRows.push(headers.map(h => `"${h}"`).join(','));

            appState.filteredData.forEach(item => {
                const values = headers.map(header => {
                    let value = item[header];
                    if (typeof value === 'number') {
                        value = value.toString();
                    } else if (value === null || value === undefined) {
                        value = '';
                    } else {
                        value = String(value);
                    }
                    const escapedValue = (value.includes(',') || value.includes('"') || value.includes('\n')) ? `"${value.replace(/"/g, '""')}"` : value;
                    return escapedValue;
                });
                csvRows.push(values.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${appState.currentDatasetId}_data.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        async function fetchDatasetMetadata(cubeId) {
            DOM.modalDatasetInfoBody.innerHTML = '<p class="text-muted text-center">Loading dataset metadata...</p>';
            DOM.modalDatasetName.textContent = 'Loading...';
            DOM.modalDatasetSourceLink.href = '#';
            DOM.modalDatasetSourceLink.classList.add('disabled');

            try {
                const url = `https://www150.statcan.gc.ca/t1/wds/rest/json/getCubeMetadata?cubeId=${cubeId}`;
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status} (${response.statusText})`);
                }

                const data = await response.json();

                if (data.status && data.status !== 'SUCCESS') {
                    throw new Error(`Statscan API error: ${data.message || 'Unknown API error'}`);
                }
                if (!data.object || data.object.length === 0) {
                    throw new Error('No metadata found for this dataset.');
                }

                appState.currentDatasetMetadata = data.object[0];
                displayDatasetMetadata(appState.currentDatasetMetadata);
            } catch (error) {
                DOM.modalDatasetInfoBody.innerHTML = `<div class="alert alert-danger" role="alert">Failed to load metadata: ${error.message}</div>`;
                DOM.modalDatasetName.textContent = 'Error';
            } finally {
                DOM.modalDatasetSourceLink.classList.remove('disabled');
            }
        }

        function displayDatasetMetadata(metadata) {
            DOM.modalDatasetName.textContent = metadata.cubeTitle || 'N/A';
            DOM.modalDatasetSourceLink.href = appState.availableDatasets.find(ds => ds.id === appState.currentDatasetId)?.sourceUrl || '#';
            DOM.modalDatasetSourceLink.target = '_blank';

            let html = `
                <p><strong>Description:</strong> ${metadata.description || 'N/A'}</p>
                <p><strong>Last Updated:</strong> ${metadata.releaseDate || 'N/A'}</p>
                <p><strong>Survey Name:</strong> ${metadata.surveyName || 'N/A'}</p>
                <hr>
                <h6>Dimensions:</h6>
                <ul>
            `;
            if (metadata.dimension) {
                for (const dimKey in metadata.dimension) {
                    if (Object.prototype.hasOwnProperty.call(metadata.dimension, dimKey)) {
                        const dim = metadata.dimension[dimKey];
                        html += `<li><strong>${dim.label}:</strong> ${dim.category ? Object.keys(dim.category.label).length : 0} members</li>`;
                    }
                }
            } else {
                html += '<li>No dimension information available.</li>';
            }
            html += `</ul>`;

            if (metadata.note && metadata.note.length > 0) {
                html += `<hr><h6>Notes:</h6><ul>`;
                metadata.note.forEach(note => {
                    html += `<li>${note.text}</li>`;
                });
                html += `</ul>`;
            }

            DOM.modalDatasetInfoBody.innerHTML = html;
        }

        function initializeApp() {
            populateDatasetSelect();

            DOM.datasetSelect.addEventListener('change', (event) => {
                appState.currentDatasetId = event.target.value;
                fetchAndProcessData(appState.currentDatasetId);
            });

            DOM.refreshDataBtn.addEventListener('click', () => {
                fetchAndProcessData(appState.currentDatasetId);
            });

            DOM.filtersContainer.addEventListener('change', (event) => {
                if (event.target.tagName === 'SELECT') {
                    const dimensionLabel = event.target.getAttribute('data-dimension');
                    appState.currentFilters[dimensionLabel] = event.target.value;
                    applyFiltersAndRender();
                }
            });

            DOM.resetFiltersBtn.addEventListener('click', () => {
                for (const dimLabel in appState.currentFilters) {
                    if (Object.prototype.hasOwnProperty.call(appState.currentFilters, dimLabel)) {
                        appState.currentFilters[dimLabel] = 'All';
                    }
                }
                renderFilters();
                applyFiltersAndRender();
            });

            DOM.chartTypeSelect.addEventListener('change', (event) => {
                appState.chartType = event.target.value;
                renderChart();
            });

            DOM.downloadDataBtn.addEventListener('click', downloadCSV);

            DOM.aboutDatasetBtn.addEventListener('click', () => {
                fetchDatasetMetadata(appState.currentDatasetId);
            });

            DOM.dataTableHead.addEventListener('click', (event) => {
                const targetTh = event.target.closest('th[data-column]');
                if (targetTh) {
                    const columnName = targetTh.getAttribute('data-column');
                    sortData(columnName);
                }
            });

            fetchAndProcessData(appState.currentDatasetId);
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>

<!-- Injectable Console Log Copier Snippet -->
<div id="appgen2025ConsoleCopyUtil" style="position: fixed; top: 5px; right: 5px; z-index: 9999; padding: 5px; background-color: rgba(0,0,0,0.7); border-radius: 5px; cursor: default;" title="Copy Console Logs for this Tab">
    <button type="button" style="background: none; border: 1px solid #fff; color: #fff; padding: 3px 8px; font-size: 10px; border-radius: 3px; cursor: pointer;">Copy Logs</button>
</div>
<script>
    (function() {
        const utilContainer = document.getElementById('appgen2025ConsoleCopyUtil');
        if (utilContainer) {
            const originalConsoleLog = console.log; const originalConsoleError = console.error; const originalConsoleWarn = console.warn; const originalConsoleInfo = console.info; const originalConsoleDebug = console.debug;
            const logs = [];
            function formatLog(type, args) {
                const timestamp = new Date().toISOString();
                const message = Array.from(args).map(arg => { try { if (arg instanceof Error) return arg.stack || arg.toString(); if (typeof arg === 'object' && arg !== null) { const getCircularReplacer = () => { const seen = new WeakSet(); return (key, value) => { if (typeof value === "object" && value !== null) { if (seen.has(value)) { return "[Circular]"; } seen.add(value); } return value; }; }; return JSON.stringify(arg, getCircularReplacer(), 2); } return String(arg); } catch (e) { return '[Unserializable Object]'; } }).join(' ');
                return `[${timestamp}] [${type.toUpperCase()}] ${message}`;
            }
            console.log = function(...args) { const formatted = formatLog('log', args); logs.push(formatted); originalConsoleLog.apply(console, args); };
            console.error = function(...args) { const formatted = formatLog('error', args); logs.push(formatted); originalConsoleError.apply(console, args); };
            console.warn = function(...args) { const formatted = formatLog('warn', args); logs.push(formatted); originalConsoleWarn.apply(console, args); };
            console.info = function(...args) { const formatted = formatLog('info', args); logs.push(formatted); originalConsoleInfo.apply(console, args); };
            console.debug = function(...args) { const formatted = formatLog('debug', args); logs.push(formatted); originalConsoleDebug.apply(console, args); };
            window.onerror = function(message, source, lineno, colno, error) { const errorObj = error || {}; const formatted = formatLog('uncaught_error', [message, `at ${source}:${lineno}:${colno}`, errorObj.stack || '(no stack)']); logs.push(formatted); originalConsoleError.call(console, 'Uncaught Error:', message, 'at', source + ':' + lineno + ':' + colno, error); return false; };
            window.onunhandledrejection = function(event) { const reason = event.reason || {}; const formatted = formatLog('unhandled_rejection', [reason.message || reason, reason.stack || '(no stack)']); logs.push(formatted); originalConsoleError.call(console, 'Unhandled Rejection:', event.reason); };
            const copyButton = utilContainer.querySelector('button');
            if (copyButton) {
                copyButton.addEventListener('click', function(e) {
                    e.stopPropagation(); if (logs.length === 0) { alert('No console logs captured yet to copy.'); return; }
                    const logText = logs.join('\n');
                    navigator.clipboard.writeText(logText).then(function() {
                        const originalText = copyButton.textContent; copyButton.textContent = 'Copied!'; copyButton.style.background = '#28a745'; copyButton.style.borderColor = '#28a745';
                        setTimeout(function() { copyButton.textContent = originalText; copyButton.style.background = 'none'; copyButton.style.borderColor = '#fff'; }, 2000);
                        originalConsoleInfo.call(console, 'AppGen2025 Util: Console logs copied to clipboard.');
                    }).catch(function(err) {
                        originalConsoleError.call(console, 'AppGen2025 Util: Failed to copy console logs - ', err.name, err.message);
                        alert('Failed to copy logs. See browser console for details. Logs may be too large or permissions denied.');
                        const originalText = copyButton.textContent; copyButton.textContent = 'Failed!'; copyButton.style.background = '#dc3545'; copyButton.style.borderColor = '#dc3545';
                        setTimeout(function() { copyButton.textContent = originalText; copyButton.style.background = 'none'; copyButton.style.borderColor = '#fff'; }, 3000);
                    });
                });
            }
        } else { console.error('AppGen2025 Util: Container element "appgen2025ConsoleCopyUtil" not found.'); }
    })();
</script>
<!-- End of Injectable Snippet -->

</body>
</html>