<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beekeeping Simulator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: var(--bs-body-color);
            background-color: var(--bs-body-bg);
        }

        #app-container {
            background-color: var(--bs-body-bg);
        }

        #game-header {
            background-color: var(--bs-tertiary-bg);
            flex-shrink: 0; 
            transition: border-bottom-color 0.5s ease-in-out;
        }
        
        #game-title {
            color: var(--bs-primary); 
        }

        #main-interface-area {
            flex-grow: 1; 
            overflow: hidden; 
        }

        #sidebar-nav {
            overflow-y: auto; 
            height: 100%; 
            background-color: var(--bs-tertiary-bg); 
        }

        #content-pane {
            overflow-y: auto; 
            scroll-behavior: smooth;
            height: 100%; 
            background-color: var(--bs-body-bg);
        }
        
        #game-footer {
            flex-shrink: 0; 
            background-color: var(--bs-tertiary-bg);
        }

        #sidebar-nav .nav-link {
            color: var(--bs-nav-link-color); 
            padding: 0.6rem 1rem;
            font-weight: 500;
            border-radius: 0.3rem;
        }

        #sidebar-nav .nav-link.active {
            background-color: var(--bs-primary);
            color: var(--bs-light);
        }

        #sidebar-nav .nav-link:hover {
            background-color: var(--bs-nav-link-hover-bg);
            color: var(--bs-primary);
        }

        #sidebar-nav .nav-link img,
        #sidebar-nav .nav-link .bi { 
            opacity: 0.8; 
            transition: opacity 0.2s ease-in-out;
            margin-right: 0.5em;
            width: 1.1em; 
            height: 1.1em; 
            vertical-align: text-bottom;
        }

        #sidebar-nav .nav-link.active img,
        #sidebar-nav .nav-link:hover img,
        #sidebar-nav .nav-link.active .bi,
        #sidebar-nav .nav-link:hover .bi {
            opacity: 1;
        }
        
        #dynamic-hive-nav-list .nav-link {
            font-size: 0.9em;
            padding: 0.4rem 1rem;
        }
        
        .card {
            background-color: var(--bs-secondary-bg);
        }

        .card-header {
            background-color: var(--bs-tertiary-bg); 
        }

        .progress {
            height: 1rem;
            font-size: 0.75rem;
            background-color: var(--bs-secondary-bg);
        }
        
        .stat-value {
            font-weight: bold;
            color: var(--bs-info);
        }
        .stat-value-unknown {
            font-weight: normal;
            color: var(--bs-secondary-color); 
            font-style: italic;
        }

        .hive-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .hive-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
        }

        .action-btn-sm {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        .guide-image {
            max-width: 100%;
            height: auto;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            background-color: var(--bs-light); 
        }
        .almanac-cover {
            max-height: 250px;
            object-fit: cover;
            width: 100%;
            border-radius: .25rem;
            margin-bottom: 1.5rem;
            background-color: var(--bs-light);
        }
        .toast-container {
            z-index: 1100; 
        }
        .bi { 
            vertical-align: -0.125em; 
        }
        .btn .bi {
             vertical-align: text-bottom;
        }
        #pause-button .bi-play-fill, #pause-button .bi-pause-fill {
            font-size: 1.1em; 
        }
        .journal-list {
            max-height: 60vh; 
            overflow-y: auto;
        }
        #game-header.header-spring { border-bottom: 3px solid #5cb85c !important; } 
        #game-header.header-summer { border-bottom: 3px solid #f0ad4e !important; } 
        #game-header.header-autumn { border-bottom: 3px solid #d9534f !important; } 
        #game-header.header-winter { border-bottom: 3px solid #5bc0de !important; } 

        .frame-slot {
            border: 1px solid var(--bs-border-color);
            min-height: 120px; 
            font-size: 0.7rem; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between; 
            padding: 0.3rem;
            border-radius: 0.25rem;
            position: relative;
        }
        .frame-icon-container {
            position: relative;
            width: 100%;
            text-align: center;
            height: 2rem;
        }
        .frame-icon-container .bi { 
            font-size: 1.75rem; 
        }
        .frame-icon-container .bi-award-fill {
            font-size: 0.9rem !important;
        }
        .frame-label {
            font-size: 0.65rem;
            text-align: center;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 0.1rem;
            margin-bottom: 0.1rem;
        }
        .frame-slot-foundation { background-color: var(--bs-gray-700); color: var(--bs-gray-300); }
        .frame-slot-drawn_comb { background-color: var(--bs-gray-600); color: var(--bs-gray-200); }
        .frame-slot-eggs { background-color: #3a3f44; border: 1px dashed var(--bs-border-color-translucent); }
        .frame-slot-eggs .bi { color: var(--bs-light); }
        .frame-slot-larvae { background-color: var(--bs-info-bg-subtle); } 
        .frame-slot-larvae .bi { color: var(--bs-info-emphasis); }
        .frame-slot-pupae { background-color: var(--bs-secondary-bg); border: 1px solid var(--bs-border-color); }
        .frame-slot-pupae .bi { color: var(--bs-secondary-emphasis); }
        .frame-slot-honey { background-color: var(--bs-warning-bg-subtle); } 
        .frame-slot-honey .bi { color: var(--bs-warning-emphasis); }
        .frame-slot-pollen { background-color: var(--bs-primary-bg-subtle); } 
        .frame-slot-pollen .bi { color: var(--bs-primary-emphasis); }
        
        .frame-coverage-bar-container {
            width: 90%;
            height: 6px; 
            background-color: var(--bs-gray-700);
            border-radius: 3px;
            margin-top: auto;
            overflow: hidden;
        }
        .frame-coverage-fill {
            height: 100%;
            background-color: var(--bs-success);
            border-radius: 3px 0 0 3px;
            transition: width 0.3s ease-in-out;
        }
        .frame-coverage-text {
            font-size: 0.6rem;
            margin-top: 1px;
        }
        .frame-slot-capped .frame-coverage-fill {
            background-color: var(--bs-secondary);
        }
        .frame-slot-selectable {
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .frame-slot-selectable:hover {
            background-color: var(--bs-primary-bg-subtle);
        }
        .frame-slot-selectable.selected-frame {
            border: 2px solid var(--bs-primary);
            box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
        }

        .modal-content {
            background-color: var(--bs-dark);
            border: 1px solid var(--bs-border-color);
        }
        .modal-header, .modal-footer {
            border-color: var(--bs-border-color-translucent);
        }
        .list-group-item {
            background-color: var(--bs-tertiary-bg);
        }
    </style>
</head>
<body>
    <div id="app-container" class="container-fluid d-flex flex-column min-vh-100 p-0">

        <header id="game-header" class="py-3 px-4 border-bottom shadow-sm">
            <div class="d-flex justify-content-between align-items-center">
                <h1 id="game-title" class="h2 mb-0">Beekeeping Simulator</h1>
                <div id="game-status-bar" class="text-center mx-3">
                    <div><span id="beekeeper-name-display" class="fw-bold">My Apiary</span></div>
                    <div>Date: <span id="game-date" class="fw-bold">Spring, Year 1, Day 1</span></div>
                    <div>Money: <span id="player-money" class="fw-bold text-success">$250.00</span></div>
                    <div>Apiary Health: <span id="apiary-health-status" class="fw-bold">Good</span></div>
                </div>
                <div class="text-end">
                    <button id="next-day-button" class="btn btn-primary btn-sm me-2" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Advance to the next day"><i class="bi bi-caret-right-fill"></i> Advance Day</button>
                    <button id="pause-button" class="btn btn-secondary btn-sm me-2" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Pause Game"><i class="bi bi-pause-fill"></i> Pause</button>
                    <button id="settings-button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#settingsModal" data-bs-tooltip="tooltip" data-bs-placement="bottom" title="Game Settings">
                        <img src="/generated_images/dalle_3fcb1131-10c.png" alt="Settings Icon" style="width: 1.2em; height: 1.2em; vertical-align: middle;">
                    </button>
                </div>
            </div>
        </header>

        <div id="main-interface-area" class="flex-grow-1 d-flex p-3">
            <nav id="sidebar-nav" class="col-lg-2 col-md-3 p-3 border rounded shadow-sm me-3">
                <ul class="nav nav-pills flex-column">
                    <li class="nav-item mb-2"><a class="nav-link active" id="nav-apiary-overview" href="#"><img src="/generated_images/dalle_1b6fffb3-faa.png" alt="Apiary Icon">Apiary Overview</a></li>
                    <li class="nav-item mb-2"><a class="nav-link" id="nav-market" href="#"><img src="/generated_images/dalle_4fbd6488-32b.png" alt="Market Icon">Market</a></li>
                    <li class="nav-item mb-2"><a class="nav-link" id="nav-research" href="#"><img src="/generated_images/dalle_24279f93-1c0.png" alt="Research Icon">Knowledge</a></li>
                    <li class="nav-item mb-2"><a class="nav-link" id="nav-guide" href="#"><img src="/generated_images/dalle_034e8bdf-261.png" alt="Guide Icon">Beekeeper's Almanac</a></li>
                    <li class="nav-item mb-2"><a class="nav-link" id="nav-journal" href="#"><i class="bi bi-book"></i>Beekeeper's Journal</a></li>
                </ul>
                <hr>
                <div id="hive-list-nav" class="mt-3">
                    <h6 class="text-muted">My Hives:</h6>
                    <ul class="nav nav-pills flex-column" id="dynamic-hive-nav-list">
                    </ul>
                </div>
                 <hr>
                <div id="inventory-display" class="mt-3">
                    <h6 class="text-muted">Inventory:</h6>
                    <small id="inventory-list" class="d-block"></small>
                </div>
            </nav>

            <main id="content-pane" class="col-lg-10 col-md-9 p-4 border rounded shadow-sm">
            </main>
        </div>

        <footer id="game-footer" class="py-2 px-4 border-top text-center">
            <small class="text-muted">Beekeeping Simulator v<span id="game-version-display">0.5.0</span> | Current Season: <span id="footer-season">Spring</span> | Weather: <span id="footer-weather">Sunny</span></small>
        </footer>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="settingsModalLabel">Settings</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body">
            <div class="mb-3">
                <label for="beekeeperNameInputModal" class="form-label">Beekeeper/Apiary Name:</label>
                <input type="text" class="form-control" id="beekeeperNameInputModal" value="My Apiary" maxlength="25">
            </div>
            <button type="button" class="btn btn-danger" id="resetGameButtonModal"><i class="bi bi-exclamation-triangle-fill"></i> Reset Game Data</button>
            <small class="d-block mt-1 text-muted">This will erase all progress and start a new game.</small>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-primary" id="saveSettingsButtonModal"><i class="bi bi-save"></i> Save Settings</button></div>
    </div></div></div>

    <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="eventModalLabel">Event!</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body" id="eventModalBody"></div>
        <div class="modal-footer" id="eventModalFooter"></div>
    </div></div></div>

    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="confirmationModalLabel">Confirm Action</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body" id="confirmationModalBody"></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="confirmationCancelBtn">Cancel</button><button type="button" class="btn btn-primary" id="confirmationConfirmBtn">Confirm</button></div>
    </div></div></div>

    <div class="modal fade" id="guideDetailModal" tabindex="-1" aria-labelledby="guideDetailModalLabel" aria-hidden="true"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="guideDetailModalLabel">Guide Entry</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body" id="guideDetailModalBody"></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
    </div></div></div>
    
    <div class="modal fade" id="installColonyModal" tabindex="-1" aria-labelledby="installColonyModalLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="installColonyModalLabel">Install Colony</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body">
            <p>Select a colony type to install into this empty hive:</p>
            <div id="installColonyOptionsContainer"></div>
            <p id="installColonyNoOptions" class="text-danger d-none">You don't have any bee packages or nucs in your inventory.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="confirmInstallColonyBtn">Confirm Installation</button>
        </div>
    </div></div></div>

    <div class="modal fade" id="hiveSplitModal" tabindex="-1" aria-labelledby="hiveSplitModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="hiveSplitModalLabel">Split Hive - Select Frames</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body">
            <p>Select 3-5 frames from <strong id="splitSourceHiveName"></strong> to move to a new hive body. Ensure you include brood (eggs/larvae) and food (honey/pollen).</p>
            <div id="hiveSplitFrameSelection" class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-2 mb-3"></div>
            <p class="text-muted"><small>The new hive will initially be queenless. If selected frames include eggs or young larvae, they may attempt to raise a new queen. The original queen remains in the source hive.</small></p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="confirmHiveSplitBtn" disabled>Confirm Split (0 selected)</button>
        </div>
    </div></div></div>
    
    <div class="modal fade" id="bulkFeedModal" tabindex="-1" aria-labelledby="bulkFeedModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="bulkFeedModalLabel">Bulk Feed Hives</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body">
            <p>Select hives to feed and the type/amount of food.</p>
            <div class="mb-3">
                <label for="bulkFeedFoodType" class="form-label">Food Type:</label>
                <select class="form-select" id="bulkFeedFoodType">
                    <option value="sugar_syrup">Sugar Syrup</option>
                    <option value="pollen_patty">Pollen Patty</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="bulkFeedAmount" class="form-label">Amount per Hive (kg or units):</label>
                <input type="number" class="form-control" id="bulkFeedAmount" value="1" min="0.1" step="0.1">
            </div>
            <h6>Select Hives:</h6>
            <div id="bulkFeedHiveList" class="list-group mb-3" style="max-height: 200px; overflow-y: auto;"></div>
            <p>Total cost: <span id="bulkFeedTotalCost">$0.00</span>. Available: <span id="bulkFeedAvailableStock">0</span></p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="confirmBulkFeedBtn">Feed Selected Hives</button>
        </div>
    </div></div></div>

    <div class="modal fade" id="bulkTreatModal" tabindex="-1" aria-labelledby="bulkTreatModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="bulkTreatModalLabel">Bulk Treat Hives (Varroa)</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body">
            <p>Select hives to apply Varroa treatment.</p>
            <div class="mb-3">
                <label for="bulkTreatTreatmentType" class="form-label">Treatment Type:</label>
                <select class="form-select" id="bulkTreatTreatmentType">
                </select>
            </div>
            <h6>Select Hives:</h6>
            <div id="bulkTreatHiveList" class="list-group mb-3" style="max-height: 200px; overflow-y: auto;"></div>
             <p>Total cost: <span id="bulkTreatTotalCost">$0.00</span>. Available treatments: <span id="bulkTreatAvailableStock">0</span></p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="confirmBulkTreatBtn">Treat Selected Hives</button>
        </div>
    </div></div></div>


    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="gameToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto" id="toastTitle">Notification</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastBody">
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    (function() {
        'use strict';

        const GAME_VERSION = "0.5.0"; 
        const SEASONS = { SPRING: "Spring", SUMMER: "Summer", AUTUMN: "Autumn", WINTER: "Winter" };
        const WEATHER_TYPES = ["Sunny", "Cloudy", "Rainy", "Windy", "Cold Snap", "Heatwave"];
        const INITIAL_MONEY = 300; 
        const MAX_HIVE_NAME_LENGTH = 25;
        const VARROA_GROWTH_RATE = 0.05; 
        const VARROA_TREATMENT_EFFECTIVENESS = 0.8; 
        const INSPECTION_VALIDITY_DAYS = 5;
        const NUC_FRAME_COUNT = 4;
        const FRAMES_PER_HIVE = 10;
        const FRAME_DRAW_RATE_PER_BEE_DAY = 0.001; 
        const FRAME_CAPACITY_KG = 2.5; 
        const EGG_TO_LARVA_DAYS = 3;
        const LARVA_TO_PUPA_DAYS = 6;
        const PUPA_TO_ADULT_DAYS = 12;
        const POLLEN_PER_LARVA_DAY = 0.0001; 
        const NECTAR_PER_ADULT_DAY = 0.00005; 
        const HONEY_PER_ADULT_DAY_CONSUMPTION = 0.00008; 
        const EGGS_PER_LAY_ACTION = 100; 
        const CELLS_PER_FRAME_APPROX = 5000; 
        const COVERAGE_PER_LAY_ACTION = (EGGS_PER_LAY_ACTION / CELLS_PER_FRAME_APPROX) * 100;
        const POLLEN_PER_LAY_ACTION = 0.01; 
        const NURSES_PER_LAY_ACTION = 1;
        const MATING_FLIGHT_DURATION_DAYS_MIN = 5;
        const MATING_FLIGHT_DURATION_DAYS_MAX = 10;


        let gameState; 
        
        let settingsModalInstance, eventModalInstance, confirmationModalInstance, guideDetailModalInstance, gameToastInstance, installColonyModalInstance, hiveSplitModalInstance, bulkFeedModalInstance, bulkTreatModalInstance;

        const DOM = {
            contentPane: document.getElementById('content-pane'),
            beekeeperNameDisplay: document.getElementById('beekeeper-name-display'),
            gameDateDisplay: document.getElementById('game-date'),
            playerMoneyDisplay: document.getElementById('player-money'),
            apiaryHealthDisplay: document.getElementById('apiary-health-status'),
            footerSeasonDisplay: document.getElementById('footer-season'),
            footerWeatherDisplay: document.getElementById('footer-weather'),
            dynamicHiveNavList: document.getElementById('dynamic-hive-nav-list'),
            inventoryList: document.getElementById('inventory-list'),
            pauseButton: document.getElementById('pause-button'),
            pauseButtonIcon: document.querySelector('#pause-button .bi'),
            nextDayButton: document.getElementById('next-day-button'),
            settingsModal: {
                beekeeperNameInput: document.getElementById('beekeeperNameInputModal'),
                saveButton: document.getElementById('saveSettingsButtonModal'),
                resetButton: document.getElementById('resetGameButtonModal')
            },
            eventModal: {
                title: document.getElementById('eventModalLabel'),
                body: document.getElementById('eventModalBody'),
                footer: document.getElementById('eventModalFooter')
            },
            confirmationModal: {
                title: document.getElementById('confirmationModalLabel'),
                body: document.getElementById('confirmationModalBody'),
                confirmButton: document.getElementById('confirmationConfirmBtn')
            },
            guideDetailModal: {
                title: document.getElementById('guideDetailModalLabel'),
                body: document.getElementById('guideDetailModalBody')
            },
            installColonyModal: {
                optionsContainer: document.getElementById('installColonyOptionsContainer'),
                noOptionsText: document.getElementById('installColonyNoOptions'),
                confirmButton: document.getElementById('confirmInstallColonyBtn')
            },
            hiveSplitModal: {
                sourceHiveName: document.getElementById('splitSourceHiveName'),
                frameSelectionContainer: document.getElementById('hiveSplitFrameSelection'),
                confirmButton: document.getElementById('confirmHiveSplitBtn')
            },
            bulkFeedModal: {
                foodTypeSelect: document.getElementById('bulkFeedFoodType'),
                amountInput: document.getElementById('bulkFeedAmount'),
                hiveListContainer: document.getElementById('bulkFeedHiveList'),
                totalCostDisplay: document.getElementById('bulkFeedTotalCost'),
                availableStockDisplay: document.getElementById('bulkFeedAvailableStock'),
                confirmButton: document.getElementById('confirmBulkFeedBtn')
            },
            bulkTreatModal: {
                treatmentTypeSelect: document.getElementById('bulkTreatTreatmentType'),
                hiveListContainer: document.getElementById('bulkTreatHiveList'),
                totalCostDisplay: document.getElementById('bulkTreatTotalCost'),
                availableStockDisplay: document.getElementById('bulkTreatAvailableStock'),
                confirmButton: document.getElementById('confirmBulkTreatBtn')
            },
            toast: {
                title: document.getElementById('toastTitle'),
                body: document.getElementById('toastBody'),
            },
            gameVersionDisplay: document.getElementById('game-version-display')
        };
        
        const GameData = {
            guideContent: [
                { id: "welcome", title: "Welcome to Beekeeping!", shortDesc: "An introduction to your apiary.", 
                  fullContentHTML: `
                    <img src="/generated_images/dalle_9e83b2a9-3d9.png" alt="Apiary in a sunny meadow" class="img-fluid rounded mb-3 almanac-cover">
                    <h4>Welcome, Beekeeper!</h4>
                    <p>This almanac is your guide to the fascinating world of bees and the art of beekeeping. Here, you'll find information on bee biology, hive management, common challenges, and how the simulation mirrors real-life beekeeping practices.</p>
                    <p>Your journey begins with a small apiary. Your goal is to nurture your colonies, help them thrive through the seasons, harvest valuable products, and expand your operation. Pay close attention to your bees' needs, the changing weather, and potential threats like pests and diseases.</p>
                    <p>Use the navigation on the left to explore different aspects of the game. Good luck!</p>` 
                },
                { id: "bee_types", title: "Bee Types & Roles", shortDesc: "Queen, Worker, Drone.", 
                  fullContentHTML: `<h4>Bee Types & Roles</h4>
                    <p>A honey bee colony is a complex society with specialized roles for each type of bee.</p>
                    <h5>Queen Bee</h5>
                    <img src="/generated_images/dalle_4d02bfd9-1a0.png" alt="Queen Bee illustration" class="guide-image" style="max-width:300px;">
                    <p>The queen is the heart of the colony. Her primary role is to lay eggs, ensuring the continuation of the hive. A healthy queen can lay thousands of eggs per day during peak season. She also produces pheromones that regulate colony cohesion and behavior. In this simulation, queen health, age, and available space affect her laying rate. A new queen must take mating flights before she can lay eggs.</p>
                    <h5>Worker Bee</h5>
                    <img src="/generated_images/dalle_0ae3380b-d92.png" alt="Worker Bee illustration" class="guide-image" style="max-width:300px;">
                    <p>Worker bees are sterile females and make up the vast majority of the colony. They perform all the tasks necessary for hive survival, including: cleaning cells, feeding larvae (nurse bees), building wax comb, guarding the hive entrance, and foraging for nectar, pollen, water, and propolis. Their roles change as they age. Foragers are crucial for resource gathering in the game.</p>
                    <h5>Drone Bee</h5>
                    <img src="/generated_images/dalle_1d178691-0dc.png" alt="Drone Bee illustration" class="guide-image" style="max-width:300px;">
                    <p>Drones are male bees. Their sole purpose is to mate with a virgin queen. They do not forage, build comb, or defend the hive. Drones are produced in spring and summer and are often expelled from the hive in autumn to conserve resources. In the game, drone population has a minor impact on queen mating success (an abstracted concept for now).</p>` 
                },
                { id: "hive_inspections", title: "Hive Inspections", shortDesc: "What to look for.", 
                  fullContentHTML: `<h4>Hive Inspections</h4>
                    <p>Regular hive inspections are crucial for monitoring colony health, population, resources, and identifying problems early. In this simulation, hive data becomes 'stale' after ${INSPECTION_VALIDITY_DAYS} days. Performing an inspection updates the data to real-time values but slightly stresses the colony.</p>
                    <h5>What to Look For:</h5>
                    <ul>
                        <li><strong>Queen Presence & Laying Pattern:</strong> Spotting the queen, or evidence of her (freshly laid eggs in a compact pattern), confirms she is alive and laying.
                           <img src="/generated_images/dalle_2a85bba6-439.png" alt="Healthy Brood comb section" class="guide-image" style="max-width:400px;"></li>
                        <li><strong>Brood Stages:</strong> Observe the presence and quantity of eggs, larvae, and capped pupae. A healthy progression through these stages is vital.</li>
                        <li><strong>Population Size:</strong> Estimate the number of bees covering the frames.</li>
                        <li><strong>Food Stores:</strong> Check levels of honey and pollen on frames. Bees need adequate food, especially heading into winter or during nectar dearths.</li>
                        <li><strong>Pests & Diseases:</strong> Look for signs of Varroa mites, Small Hive Beetles, Wax Moths, or symptoms of diseases like American Foulbrood or Chalkbrood.</li>
                        <li><strong>Swarm Cells/Queen Cells:</strong> Presence of queen cells (elongated cells, often on frame bottoms or faces) indicates the colony might be preparing to swarm or replace their queen (supersedure).</li>
                    </ul>`
                },
                { id: "pests_diseases", title: "Common Pests & Diseases", shortDesc: "Identifying and managing threats.", 
                  fullContentHTML: `<h4>Common Pests & Diseases</h4>
                    <p>Honey bee colonies are susceptible to various pests and diseases that can weaken or destroy them if not managed.</p>
                    <h5>Varroa Mites (<em>Varroa destructor</em>)</h5>
                    <img src="/generated_images/dalle_83639747-1d2.png" alt="Varroa Mite on a bee" class="guide-image" style="max-width:300px;">
                    <p>Varroa mites are external parasites that feed on adult bees and developing brood. They transmit viruses and weaken the colony. High mite levels are a primary cause of colony losses. Regular monitoring and treatment are essential. In the game, Varroa levels increase over time and impact hive health.</p>
                    <h5>American Foulbrood (AFB)</h5>
                    <img src="/generated_images/dalle_04593238-fd5.png" alt="Comb section affected by American Foulbrood" class="guide-image" style="max-width:400px;">
                    <p>AFB is a highly contagious and destructive bacterial disease affecting bee larvae. Symptoms include sunken, perforated cappings and a "ropy" larval remnant. There is no cure; infected colonies and equipment usually must be destroyed by burning to prevent spread. This is a serious threat in the simulation.</p>
                    <h5>Chalkbrood</h5>
                    <img src="/generated_images/dalle_eea9b54c-2a0.png" alt="Chalkbrood mummies in comb cells" class="guide-image" style="max-width:400px;">
                    <p>Chalkbrood is a fungal disease that affects larvae, causing them to become hard, chalk-like mummies. It's often stress-related and typically less devastating than AFB but can weaken colonies. Good ventilation and strong colonies help prevent it.</p>
                    <h5>Small Hive Beetle (SHB)</h5>
                    <img src="/generated_images/dalle_82085711-4ff.png" alt="Small Hive Beetle adult" class="guide-image" style="max-width:300px;">
                    <p>SHB are pests that can damage comb, honey, and pollen. Larvae burrow through comb, and adults can cause honey to ferment. Strong colonies can usually manage small beetle populations, but weak hives are vulnerable. Traps can help control them.</p>
                    <h5>Wax Moths</h5>
                    <img src="/generated_images/dalle_6fdb66d6-83d.png" alt="Wax Moth larvae damage on comb" class="guide-image" style="max-width:400px;">
                    <p>Wax moths infest hives, particularly weak ones or stored comb. Larvae tunnel through comb, consuming wax, pollen, and honey, leaving behind webbing and debris. Strong colonies and proper storage of equipment are key preventatives.</p>`
                },
                 { id: "sim_vs_reality", title: "Simulation vs. Reality", shortDesc: "How the game models beekeeping.", 
                  fullContentHTML: `<h4>Simulation vs. Reality</h4>
                    <p>This Beekeeping Simulator aims to capture many core aspects of real-world beekeeping, but it is, by necessity, a simplification. Here's how some game mechanics relate to reality:</p>
                    <ul>
                        <li><strong>Time & Seasons:</strong> The game progresses day by day, with distinct seasons. Real beekeeping is heavily influenced by seasonal changes in weather, forage availability, and bee behavior. The simulation models this by adjusting parameters like nectar flow, queen laying rates, and pest activity based on the season.</li>
                        <li><strong>Hive Population Dynamics:</strong> Worker bee populations rise and fall based on the queen's egg-laying, brood development time on frames (eggs, larvae, pupae), and bee lifespan. This mirrors the natural colony cycle. Forager numbers directly impact resource collection.</li>
                        <li><strong>Resource Management:</strong> Bees collect nectar (converted to honey) and pollen, storing them on frames. The game requires you to monitor these stores, especially for winter survival, similar to a real beekeeper. Feeding might be necessary.</li>
                        <li><strong>Pest & Disease Management:</strong> Varroa mites, AFB, etc., are simulated threats. The game allows for treatments, which have effectiveness rates and costs, reflecting real-world decisions beekeepers make. Early detection and intervention are key in both the game and reality.</li>
                        <li><strong>Inspections:</strong> Performing inspections in the game gives you vital, up-to-date information, similar to opening a real hive. Without inspections, data becomes 'stale'. Inspections cause minor stress.</li>
                        <li><strong>Market & Economics:</strong> Buying equipment (like empty hive bodies, bee packages, nucs, queens) and selling honey/products reflects the economic side of beekeeping. Prices may fluctuate.</li>
                        <li><strong>Frame Management:</strong> Hives consist of frames. Bees draw foundation, store resources, and raise brood on these frames. You'll see representations of eggs, larvae, pupae, honey, and pollen on frames. This is a core part of hive management.</li>
                        <li><strong>Swarming:</strong> Colonies can prepare to swarm if they become too crowded, the queen is old, or other factors. You may see queen cells on frames as a precursor. Swarming results in a loss of bees and potentially the old queen.</li>
                        <li><strong>Hive Splitting:</strong> Strong colonies can be split by moving frames to a new hive body, a common beekeeping practice for expansion or swarm prevention.</li>
                        <li><strong>Queen Management:</strong> Queens can age, fail, or be lost. You can purchase and introduce new queens to queenless hives. A new queen (e.g., from a swarm cell or emergency rearing) will be a virgin and need time to mate before laying.</li>
                        <li><strong>Abstractions:</strong> Many complex biological processes (e.g., bee communication, detailed genetics, precise nutritional values of pollen) are abstracted for gameplay. For example, "forage quality" might be a single variable instead of modeling hundreds of plant types.</li>
                    </ul>
                    <p>The goal is to provide an engaging and educational experience that highlights the challenges and rewards of beekeeping. While not every detail can be perfectly replicated, the core principles of colony health, resource management, and seasonal awareness are central to the simulation.</p>`
                },
            ],
            marketItems: [
                { id: "sugar", name: "Sugar (1kg)", type: "supply", buyPrice: 2, sellPrice: null, description: "For making sugar syrup to feed bees." },
                { id: "pollen_patty", name: "Pollen Patty (1 unit)", type: "supply", buyPrice: 5, sellPrice: null, description: "Provides protein supplement for brood rearing. (Approx 0.5kg effect)" },
                { id: "varroa_treatment_basic", name: "Basic Varroa Treatment", type: "treatment", buyPrice: 15, sellPrice: null, description: "A standard treatment for Varroa mites." },
                { id: "hive_body", name: "New Hive Body (Empty + Foundation)", type: "equipment", buyPrice: 50, sellPrice: 10, description: "Woodenware and 10 frames with foundation. Bees not included." },
                { id: "bee_package", name: "Bee Package (3lb + Queen)", type: "livestock", buyPrice: 120, sellPrice: null, description: "Approx. 10,000 bees and a mated queen. Needs an empty hive." },
                { id: "nuc_colony", name: "Nuc Colony (4 Frames + Queen)", type: "livestock", buyPrice: 180, sellPrice: null, description: "Established small colony with queen, brood, and food on 4 drawn frames. Needs an empty hive." },
                { id: "queen_bee_mated", name: "Mated Queen Bee", type: "livestock", buyPrice: 45, sellPrice: null, description: "A healthy, mated queen for your hive." },
                { id: "raw_honey", name: "Raw Honey (1kg)", type: "product", buyPrice: null, sellPriceBase: 8, description: "Unprocessed honey from your hives." },
                { id: "beeswax", name: "Beeswax (100g)", type: "product", buyPrice: null, sellPriceBase: 3, description: "Rendered beeswax." }
            ],
            researchNodes: [
                { id: "basic_beekeeping", name: "Basic Beekeeping", cost: 0, description: "Fundamental knowledge of bee care.", unlocked: true, effects: {} },
                { id: "varroa_monitoring", name: "Varroa Monitoring", cost: 50, prereq: "basic_beekeeping", description: "Learn to identify and count Varroa mites.", unlocked: false, effects: { varroaDetectionChance: 0.1 } },
                { id: "advanced_feeding", name: "Advanced Feeding Strategies", cost: 75, prereq: "basic_beekeeping", description: "Understand optimal feeding times and ratios.", unlocked: false, effects: { feedingEffectiveness: 0.15 } },
                { id: "integrated_pest_management", name: "Integrated Pest Management", cost: 150, prereq: "varroa_monitoring", description: "Holistic approaches to pest control.", unlocked: false, effects: { treatmentCostReduction: 0.1 } }
            ],
            eventDefinitions: [
                { 
                    id: "good_forage", 
                    title: "Excellent Foraging Conditions!", 
                    text: "The weather has been perfect and local flora is booming. Your bees are bringing in extra nectar!",
                    type: "positive",
                    condition: (gs) => gs.currentSeason !== SEASONS.WINTER && Math.random() < 0.05,
                    effect: (gs) => {
                        gs.hives.forEach(hive => {
                            if (hive.population.foragers > 0 && !hive.isEmptyHiveBody) {
                                const bonusNectarKg = Math.floor(Math.random() * 1 + 0.5); 
                                hive.addResourceToFrames('nectar', bonusNectarKg);
                            }
                        });
                        UIManager.showToast("Bumper Harvest!", "Your bees found abundant nectar today.");
                        JournalManager.addEntry(`Excellent foraging conditions boosted nectar collection.`);
                    },
                    choices: [{ text: "Wonderful!", action: null }]
                },
                {
                    id: "mild_varroa_increase",
                    title: "Varroa Mite Activity",
                    text: "Routine checks suggest a slight increase in Varroa mite populations in some hives. Consider monitoring closely or treating if levels get high.",
                    type: "neutral",
                    condition: (gs) => gs.hives.some(h => !h.isEmptyHiveBody && h.health.varroaMites > 100 && h.health.varroaMites < 500) && Math.random() < 0.1,
                    effect: null,
                    choices: [{ text: "Noted.", action: null }]
                },
                {
                    id: "pesticide_incident_nearby",
                    title: "Pesticide Concern",
                    text: "Reports indicate pesticide spraying occurred in a nearby agricultural area. This might affect your foragers.",
                    type: "negative",
                    condition: (gs) => (gs.currentSeason === SEASONS.SPRING || gs.currentSeason === SEASONS.SUMMER) && Math.random() < 0.03,
                    effect: (gs) => {
                        let affectedHivesCount = 0;
                        gs.hives.forEach(hive => {
                            if (!hive.isEmptyHiveBody && Math.random() < 0.3) { 
                                const loss = Math.floor(hive.population.foragers * (Math.random() * 0.1 + 0.05)); 
                                hive.population.foragers = Math.max(0, hive.population.foragers - loss);
                                hive.updateTotalPopulation();
                                affectedHivesCount++;
                                JournalManager.addEntry(`Hive ${hive.name} lost ${loss} foragers due to pesticide exposure.`);
                            }
                        });
                        if (affectedHivesCount > 0) {
                           UIManager.showToast("Forager Losses!", `${affectedHivesCount} hive(s) experienced forager losses due to pesticides.`, "warning");
                        }
                    },
                    choices: [{ text: "Oh no!", action: null}]
                }
            ]
        };
        
        function initializeNewGameState() {
            gameState = {
                beekeeperName: "My Apiary",
                money: INITIAL_MONEY,
                year: 1,
                currentSeason: SEASONS.SPRING,
                dayInSeason: 1,
                dayTotal: 1,
                currentWeather: WEATHER_TYPES[0],
                hives: [],
                inventory: { 
                    rawHoney: 0, beeswax: 0, sugar: 0, pollenPatty: 0, 
                    emptyHiveBodies: 1, beePackages: 0, nucColonies: 0, matedQueens: 0,
                    varroa_treatment_basic: 0
                },
                researchPoints: 0,
                unlockedResearch: ["basic_beekeeping"],
                researchEffects: {},
                journal: [],
                isGameOver: false,
                nextHiveId: 1
            };
            JournalManager.addEntry("Welcome to your new apiary! Your beekeeping journey begins. You have one empty hive body in your inventory.");
        }

        const PersistenceManager = {
            SAVE_KEY_PREFIX: `beekeepingSimulatorSaveData_v_`,
            GAME_MODEL_VERSION: GAME_VERSION,

            getSaveKey() {
                return `${this.SAVE_KEY_PREFIX}${this.GAME_MODEL_VERSION.replace(/\./g, '_')}`;
            },

            saveGame() {
                if (gameState.isGameOver && !confirm("Game is over. Save final state? This might prevent starting a new game automatically if you reload.")) {
                    return; 
                }
                try {
                    const dataToSave = {
                        version: this.GAME_MODEL_VERSION,
                        timestamp: new Date().toISOString(),
                        gameState: gameState
                    };
                    localStorage.setItem(this.getSaveKey(), JSON.stringify(dataToSave));
                } catch (error) {
                    console.error("Error saving game:", error);
                    UIManager.showToast("Save Failed", "Could not save game data. Your browser might be blocking local storage or it's full.", "danger");
                }
            },

            loadGame() {
                try {
                    const savedString = localStorage.getItem(this.getSaveKey());
                    if (!savedString) return false;

                    const savedData = JSON.parse(savedString);
                    if (!savedData || typeof savedData !== 'object') {
                        console.error("Invalid saved data format.");
                        return false;
                    }

                    if (savedData.version !== this.GAME_MODEL_VERSION) {
                        UIManager.showToast("Load Failed", `Save data is from an incompatible version (${savedData.version}). Starting a new game. Current version is ${this.GAME_MODEL_VERSION}.`, "warning");
                        localStorage.removeItem(this.getSaveKey()); 
                        return false;
                    }

                    if (!savedData.gameState) {
                        console.error("Saved data is missing gameState.");
                        return false;
                    }
                    
                    gameState = savedData.gameState;
                    gameState.nextHiveId = gameState.nextHiveId || (gameState.hives.length > 0 ? Math.max(0, ...gameState.hives.map(h => h.id)) + 1 : 1);

                    gameState.inventory = gameState.inventory || { rawHoney: 0, beeswax: 0, sugar: 0, pollenPatty: 0, emptyHiveBodies: 0, beePackages: 0, nucColonies: 0, matedQueens: 0, varroa_treatment_basic: 0 };
                    if(typeof gameState.inventory.emptyHiveBodies === 'undefined') gameState.inventory.emptyHiveBodies = 0;
                    if(typeof gameState.inventory.beePackages === 'undefined') gameState.inventory.beePackages = 0;
                    if(typeof gameState.inventory.nucColonies === 'undefined') gameState.inventory.nucColonies = 0;
                    if(typeof gameState.inventory.matedQueens === 'undefined') gameState.inventory.matedQueens = 0;
                    if(typeof gameState.inventory.varroa_treatment_basic === 'undefined') gameState.inventory.varroa_treatment_basic = 0;


                    gameState.journal = gameState.journal || [];
                    gameState.unlockedResearch = gameState.unlockedResearch || ["basic_beekeeping"];
                    gameState.researchEffects = gameState.researchEffects || {};
                    gameState.isGameOver = gameState.isGameOver || false;
                    gameState.beekeeperName = gameState.beekeeperName || "My Apiary";
                    
                    if (gameState.hives && Array.isArray(gameState.hives)) {
                        gameState.hives = gameState.hives.map(plainHive => {
                            if (!plainHive || typeof plainHive !== 'object') return null;
                            const hiveInstance = new Hive(plainHive.id, plainHive.name, plainHive.isEmptyHiveBody || false);
                            Object.assign(hiveInstance, plainHive);
                            
                            if (plainHive.frames && Array.isArray(plainHive.frames)) {
                                hiveInstance.frames = plainHive.frames.map(f => ({
                                    id: f.id,
                                    type: f.type || 'foundation',
                                    content: f.content || null,
                                    coveragePercent: f.coveragePercent || 0,
                                    isCapped: f.isCapped || false,
                                    broodAge: f.broodAge || 0,
                                    queenCellPresent: f.queenCellPresent || false
                                })); 
                            } else { 
                                hiveInstance.initializeFrames(); 
                            }

                            if (plainHive.queen && typeof plainHive.queen === 'object') {
                                const queenInstance = new Queen();
                                Object.assign(queenInstance, plainHive.queen);
                                queenInstance.isVirgin = typeof plainHive.queen.isVirgin !== 'undefined' ? plainHive.queen.isVirgin : false;
                                queenInstance.matingFlightCountdown = plainHive.queen.matingFlightCountdown || 0;
                                hiveInstance.queen = queenInstance;
                            } else if (!hiveInstance.isEmptyHiveBody && plainHive.queen !== null) { 
                                hiveInstance.queen = new Queen(); 
                            } else {
                                hiveInstance.queen = null;
                            }
                            return hiveInstance;
                        }).filter(h => h !== null);
                    } else {
                        gameState.hives = [];
                    }
                    
                    UIManager.showToast("Game Loaded", `Welcome back, ${gameState.beekeeperName}!`, "success");
                    return true;
                } catch (error) {
                    console.error("Error loading game:", error);
                    UIManager.showToast("Load Error", "Failed to load saved game. Starting a new game.", "danger");
                    localStorage.removeItem(this.getSaveKey()); 
                    return false;
                }
            },
            
            resetGameConfirm(confirmUser = true) {
                if (confirmUser) {
                    UIManager.showConfirmation("Are you sure you want to reset all game data and start over?", () => {
                        this.performReset();
                    });
                } else {
                    this.performReset();
                }
            },

            performReset() {
                try {
                    localStorage.removeItem(this.getSaveKey());
                } catch (error) {
                    console.error("Error clearing saved game data:", error);
                    UIManager.showToast("Reset Error", "Could not clear old save data from local storage.", "warning");
                }
                initializeNewGameState();
                GameLoopManager.isPaused = false; 
                DOM.pauseButtonIcon.className = 'bi bi-pause-fill';
                DOM.pauseButton.setAttribute('data-bs-original-title', 'Pause Game');
                DOM.nextDayButton.disabled = false;
                DOM.pauseButton.disabled = false;

                UIManager.currentView = 'apiary-overview';
                UIManager.activeHiveId = null;
                UIManager.render();
                UIManager.showToast("Game Reset", "A new beekeeping season begins!", "info");
                if (settingsModalInstance) settingsModalInstance.hide();
                if (eventModalInstance) eventModalInstance.hide();
                if (confirmationModalInstance) confirmationModalInstance.hide();
                if (guideDetailModalInstance) guideDetailModalInstance.hide();
                if (installColonyModalInstance) installColonyModalInstance.hide();
                if (hiveSplitModalInstance) hiveSplitModalInstance.hide();
                if (bulkFeedModalInstance) bulkFeedModalInstance.hide();
                if (bulkTreatModalInstance) bulkTreatModalInstance.hide();
            }
        };

        class Queen {
            constructor(age = 0, health = 100, baseLayingRate = 1500) {
                this.age = age; 
                this.health = health; 
                this.baseLayingRate = baseLayingRate; 
                this.maxLifespan = 3 * 365; 
                this.isVirgin = false;
                this.matingFlightCountdown = 0;
            }

            dailyUpdate(hiveResources) {
                this.age++;
                if (this.age > this.maxLifespan * 0.6 && Math.random() < 0.003 * (this.age / this.maxLifespan)) this.health -= (Math.random() * 5 + 1); 
                this.health = Math.max(0, Math.min(100, this.health));

                if (this.isVirgin && this.matingFlightCountdown > 0) {
                    this.matingFlightCountdown--;
                    if (this.matingFlightCountdown === 0) {
                        this.isVirgin = false; 
                        JournalManager.addEntry(`A new queen has successfully mated and begun laying!`);
                        UIManager.showToast("Queen Mated!", `A new queen has started laying eggs.`, "success");
                    }
                }
            }

            getEffectiveLayingRate(season, availableSpacePercent) {
                if (this.health < 20 || season === SEASONS.WINTER || this.isVirgin) return 0;
                let currentEffectiveLayingRate = this.baseLayingRate * (this.health / 100.0) * (availableSpacePercent / 100.0);
                if (season === SEASONS.SPRING) currentEffectiveLayingRate *= 1.0;
                else if (season === SEASONS.SUMMER) currentEffectiveLayingRate *= 1.2;
                else if (season === SEASONS.AUTUMN) currentEffectiveLayingRate *= 0.5;
                
                currentEffectiveLayingRate *= (1 - (this.age / (this.maxLifespan * 1.5) )); 
                return Math.floor(Math.max(0, currentEffectiveLayingRate));
            }
            
            setAsNewQueen() {
                this.age = 0;
                this.health = 100;
                this.isVirgin = true;
                this.matingFlightCountdown = Math.floor(Math.random() * (MATING_FLIGHT_DURATION_DAYS_MAX - MATING_FLIGHT_DURATION_DAYS_MIN + 1)) + MATING_FLIGHT_DURATION_DAYS_MIN; 
            }
        }

        class Hive {
            constructor(id, name, isEmptyHiveBody = false) {
                this.id = id;
                this.name = name || `Hive ${id}`;
                this.isEmptyHiveBody = isEmptyHiveBody;
                this.frames = [];
                this.initializeFrames();

                if (isEmptyHiveBody) {
                    this.queen = null;
                    this.population = { workers: 0, drones: 0, foragers: 0, total: 0 };
                } else {
                    this.queen = new Queen();
                    this.population = { workers: 10000, drones: 500, foragers: 4000, total: 0 };
                    this.updateTotalPopulation();
                }
                
                this.health = { overall: 90, varroaMites: 50, diseases: {} };
                this.temperament = "Calm"; 
                this.swarmingUrge = 0; 
                this.lastInspectionData = { day: -1, queenPresent: false, broodLevel: 'Unknown', miteCount: 'Unknown', foodStores: 'Unknown', queenCells: 0 };
            }

            initializeFrames() {
                this.frames = Array(FRAMES_PER_HIVE).fill(null).map((_, idx) => ({ 
                    id: idx, 
                    type: 'foundation', 
                    content: null, 
                    coveragePercent: 0, 
                    isCapped: false,
                    broodAge: 0,
                    queenCellPresent: false
                }));
            }
            
            updateTotalPopulation() {
                this.population.total = this.population.workers + this.population.drones;
            }

            getFrameResourceCount(resourceType) {
                return this.frames.reduce((sum, frame) => {
                    if (frame.content === resourceType) {
                        sum += (frame.coveragePercent / 100) * FRAME_CAPACITY_KG; 
                    }
                    return sum;
                }, 0);
            }
            
            getBroodCount(broodType) { 
                return this.frames.reduce((count, frame) => {
                    if (frame.content === broodType) {
                        count += Math.floor(CELLS_PER_FRAME_APPROX * (frame.coveragePercent / 100)); 
                    }
                    return count;
                }, 0);
            }

            dailyUpdate(season, weather) {
                if (this.isEmptyHiveBody || (this.population.total <= 0 && !this.queen)) {
                     this.updateHealth(season); 
                     if (this.population.total <= 0 && !this.isEmptyHiveBody && !gameState.isGameOver) {
                        GameLoopManager.handleHiveCollapse(this.id);
                     }
                     return; 
                }

                if (this.queen) this.queen.dailyUpdate(this.getFrameResourceCount('pollen'));
                else this.checkForEmergencyQueenRearing();


                let foragingResults = this.calculateForaging(season, weather);
                this.addResourceToFrames('nectar', foragingResults.nectar);
                this.addResourceToFrames('pollen', foragingResults.pollen);

                this.processFrames(season);
                this.consumeResources();
                this.updatePopulationDailyLosses(); 
                this.updateHealth(season);
                this.updateSwarmingUrge(season);
                this.updateTotalPopulation();
                
                if (this.queen && (this.queen.health <= 0 || this.queen.age >= this.queen.maxLifespan)) {
                    JournalManager.addEntry(`The queen in ${this.name} has died or failed.`);
                    UIManager.showToast("Queen Failure!", `The queen in ${this.name} has perished. The hive is now queenless.`, "danger");
                    this.queen = null;
                }
            }
            
            processFrames(season) {
                let availableLayingSpacePercent = this.frames.reduce((sum, f) => {
                    if (f.type === 'drawn_comb' && f.content === null) sum += (100 - f.coveragePercent);
                    return sum;
                }, 0) / (this.frames.filter(f => f.type === 'drawn_comb').length || 1);


                let eggsToLayToday = this.queen ? this.queen.getEffectiveLayingRate(season, availableLayingSpacePercent) : 0;
                let totalPollenKg = this.getFrameResourceCount('pollen');
                let availableNurseBees = Math.floor(this.population.workers * 0.2); 

                this.frames.forEach(frame => {
                    if (frame.type === 'foundation' && this.population.workers > 0) {
                        let drawAmount = this.population.workers * FRAME_DRAW_RATE_PER_BEE_DAY;
                        frame.coveragePercent = Math.min(100, frame.coveragePercent + drawAmount); 
                        if (frame.coveragePercent >= 100) {
                            frame.type = 'drawn_comb';
                            frame.coveragePercent = 0; 
                        }
                    }

                    if (this.queen && eggsToLayToday > 0 && frame.type === 'drawn_comb' && frame.content === null && frame.coveragePercent < 95 && totalPollenKg >= POLLEN_PER_LAY_ACTION && availableNurseBees >= NURSES_PER_LAY_ACTION) {
                        const eggsThisAction = Math.min(eggsToLayToday, EGGS_PER_LAY_ACTION);
                        const coverageThisAction = (eggsThisAction / CELLS_PER_FRAME_APPROX) * 100;
                        
                        frame.content = 'eggs';
                        frame.broodAge = 0;
                        frame.coveragePercent += coverageThisAction;
                        frame.coveragePercent = Math.min(100, frame.coveragePercent);
                        eggsToLayToday -= eggsThisAction; 
                        totalPollenKg -= POLLEN_PER_LAY_ACTION; 
                        availableNurseBees -= NURSES_PER_LAY_ACTION;
                    }
                    
                    if (frame.content === 'eggs') {
                        frame.broodAge++;
                        if (frame.broodAge >= EGG_TO_LARVA_DAYS) {
                            frame.content = 'larvae';
                            frame.broodAge = 0;
                        }
                    } else if (frame.content === 'larvae') {
                        const larvaeCountInFrame = Math.floor(CELLS_PER_FRAME_APPROX * (frame.coveragePercent / 100));
                        const pollenNeededForFrameLarvae = larvaeCountInFrame * POLLEN_PER_LARVA_DAY;
                        if (totalPollenKg >= pollenNeededForFrameLarvae) {
                            totalPollenKg -= pollenNeededForFrameLarvae;
                            frame.broodAge++;
                            if (frame.broodAge >= LARVA_TO_PUPA_DAYS) {
                                frame.content = 'pupae';
                                frame.broodAge = 0;
                                frame.isCapped = true;
                            }
                        } else {
                            frame.coveragePercent *= 0.9; 
                            if (frame.coveragePercent < 5) { frame.content = null; frame.coveragePercent = 0; }
                        }
                    } else if (frame.content === 'pupae') {
                        frame.broodAge++;
                        if (frame.broodAge >= PUPA_TO_ADULT_DAYS) {
                            const emergingBees = Math.floor(CELLS_PER_FRAME_APPROX * (frame.coveragePercent / 100));
                            const newWorkers = Math.floor(emergingBees * 0.95);
                            const newDrones = emergingBees - newWorkers;
                            this.population.workers += newWorkers;
                            this.population.drones += newDrones;
                            this.population.foragers += Math.floor(newWorkers * 0.2); 
                            this.population.foragers = Math.min(this.population.foragers, Math.floor(this.population.workers * 0.5));
                            
                            frame.content = null;
                            frame.broodAge = 0;
                            frame.isCapped = false;
                            frame.coveragePercent = 0; 
                            if (frame.queenCellPresent) {
                                frame.queenCellPresent = false;
                                if (!this.queen || this.queen.health <= 0) {
                                    this.queen = new Queen();
                                    this.queen.setAsNewQueen();
                                    JournalManager.addEntry(`A new queen emerged from a queen cell in ${this.name}!`);
                                    UIManager.showToast("New Queen!", `A new queen has emerged in ${this.name}. She will need time to mate.`, "success");
                                }
                            }
                        }
                    }
                    
                    if (frame.content === 'nectar' && frame.coveragePercent > 0) {
                        const nectarToConvertPercent = frame.coveragePercent * 0.1; 
                        frame.coveragePercent -= nectarToConvertPercent;
                        
                        let addedToHoney = false;
                        for (const targetFrame of this.frames) {
                            if (targetFrame.type === 'drawn_comb' && (targetFrame.content === null || targetFrame.content === 'honey')) {
                                const spaceForHoneyPercent = 100 - targetFrame.coveragePercent;
                                if (spaceForHoneyPercent > 0) {
                                    const addPercent = Math.min(nectarToConvertPercent * 0.8, spaceForHoneyPercent); 
                                    targetFrame.content = 'honey';
                                    targetFrame.coveragePercent += addPercent;
                                    targetFrame.coveragePercent = Math.min(100, targetFrame.coveragePercent);
                                    addedToHoney = true;
                                    break; 
                                }
                            }
                        }
                        if (!addedToHoney) frame.coveragePercent += nectarToConvertPercent; 

                        if(frame.coveragePercent <=0) frame.content = null;
                    }
                    if (frame.content === 'honey' && frame.coveragePercent >= 90 && !frame.isCapped) { 
                        frame.isCapped = true;
                    }
                });
                 this.updateTotalPopulation();
            }

            addResourceToFrames(resourceType, amountInKg) {
                let remainingAmountKg = amountInKg;
                const eligibleFrames = this.frames.filter(f => f.type === 'drawn_comb' && (f.content === null || f.content === resourceType)).sort((a,b) => a.coveragePercent - b.coveragePercent);

                for (const frame of eligibleFrames) {
                    if (remainingAmountKg <= 0) break;
                    
                    const currentAmountInFrameKg = (frame.coveragePercent / 100) * FRAME_CAPACITY_KG;
                    const spaceLeftInFrameKg = FRAME_CAPACITY_KG - currentAmountInFrameKg;
                    const toAddKg = Math.min(remainingAmountKg, spaceLeftInFrameKg);
                    
                    if (toAddKg > 0) {
                        if (frame.content === null) frame.content = resourceType;
                        frame.coveragePercent += (toAddKg / FRAME_CAPACITY_KG) * 100;
                        frame.coveragePercent = Math.min(100, frame.coveragePercent);
                        remainingAmountKg -= toAddKg;
                    }
                }
            }
            
            consumeResources() {
                let honeyNeededKg = this.population.total * HONEY_PER_ADULT_DAY_CONSUMPTION;
                let pollenNeededKg = this.getBroodCount('larvae') * POLLEN_PER_LARVA_DAY + this.population.workers * NECTAR_PER_ADULT_DAY * 0.1; 

                for (const frame of this.frames.filter(f => f.content === 'honey' || f.content === 'pollen').sort((a,b) => b.coveragePercent - a.coveragePercent)) {
                    const resourceInFrameKg = (frame.coveragePercent / 100) * FRAME_CAPACITY_KG;
                    if (honeyNeededKg > 0 && frame.content === 'honey' && resourceInFrameKg > 0) {
                        const takeKg = Math.min(honeyNeededKg, resourceInFrameKg);
                        frame.coveragePercent -= (takeKg / FRAME_CAPACITY_KG) * 100;
                        honeyNeededKg -= takeKg;
                        if (frame.coveragePercent <= 0) { frame.content = null; frame.isCapped = false; frame.coveragePercent = 0; }
                        else if (frame.coveragePercent < 90) frame.isCapped = false;
                    }
                    if (pollenNeededKg > 0 && frame.content === 'pollen' && resourceInFrameKg > 0) {
                        const takeKg = Math.min(pollenNeededKg, resourceInFrameKg);
                        frame.coveragePercent -= (takeKg / FRAME_CAPACITY_KG) * 100;
                        pollenNeededKg -= takeKg;
                        if (frame.coveragePercent <= 0) { frame.content = null; frame.coveragePercent = 0; }
                    }
                }

                if (honeyNeededKg > 0) { 
                    this.health.overall -= 5; 
                    this.population.workers = Math.floor(this.population.workers * 0.95);
                    this.population.drones = Math.floor(this.population.drones * 0.95);
                    this.population.foragers = Math.floor(this.population.foragers * 0.95);
                }
                if (pollenNeededKg > 0) { 
                    this.frames.filter(f => f.content === 'larvae').forEach(f => f.coveragePercent *= 0.8);
                }
                 this.updateTotalPopulation();
            }

            calculateForaging(season, weather) {
                let nectarGainKg = 0;
                let pollenGainKg = 0;
                if (this.isEmptyHiveBody || this.population.foragers <= 0 || season === SEASONS.WINTER) return { nectar: 0, pollen: 0 };

                let baseForagePotential = this.population.foragers * 0.00025 * FRAME_CAPACITY_KG; 
                
                if (season === SEASONS.SPRING) baseForagePotential *= 1.2;
                if (season === SEASONS.SUMMER) baseForagePotential *= 1.5;
                if (season === SEASONS.AUTUMN) baseForagePotential *= 0.8;

                if (weather === "Sunny") baseForagePotential *= 1.2;
                if (weather === "Cloudy") baseForagePotential *= 0.9;
                if (weather === "Rainy") baseForagePotential *= 0.2;
                if (weather === "Windy") baseForagePotential *= 0.6;
                if (weather === "Cold Snap") baseForagePotential *= 0.3;
                if (weather === "Heatwave") baseForagePotential *= 0.7;

                nectarGainKg = baseForagePotential * (Math.random() * 0.5 + 0.75); 
                pollenGainKg = nectarGainKg * (Math.random() * 0.3 + 0.1); 

                return { nectar: parseFloat(nectarGainKg.toFixed(2)), pollen: parseFloat(pollenGainKg.toFixed(2)) };
            }
            
            updatePopulationDailyLosses() {
                if (this.isEmptyHiveBody || this.population.total <= 0) return;
                const workerLifespan = (gameState.currentSeason === SEASONS.WINTER) ? 90 : 45; 
                const droneLifespan = 60;
                
                let dailyWorkerLoss = Math.floor(this.population.workers / workerLifespan);
                let dailyDroneLoss = Math.floor(this.population.drones / droneLifespan);
                if (gameState.currentSeason === SEASONS.AUTUMN && Math.random() < 0.2) dailyDroneLoss += Math.floor(this.population.drones * 0.1);


                this.population.workers = Math.max(0, this.population.workers - dailyWorkerLoss);
                this.population.drones = Math.max(0, this.population.drones - dailyDroneLoss);
                
                let foragerLossRate = this.population.workers > 0 ? (this.population.foragers / this.population.workers) : 0;
                let lostForagers = Math.floor(dailyWorkerLoss * foragerLossRate);
                this.population.foragers = Math.max(0, this.population.foragers - lostForagers);
                this.population.foragers = Math.min(this.population.foragers, Math.floor(this.population.workers * 0.5));

                this.updateTotalPopulation();

                if (this.population.total <= 0 && !this.isEmptyHiveBody && !gameState.isGameOver && !this.queen) {
                    GameLoopManager.handleHiveCollapse(this.id);
                }
            }

            updateHealth(season) {
                if (this.isEmptyHiveBody) return;
                this.health.varroaMites *= (1 + VARROA_GROWTH_RATE * (season === SEASONS.WINTER ? 0.1 : 1)); 
                this.health.varroaMites = Math.floor(this.health.varroaMites);

                let healthImpact = 0;
                if (this.health.varroaMites > 1000) healthImpact += (this.health.varroaMites - 1000) / 100; 
                if (this.health.diseases && this.health.diseases.AFB) healthImpact += 20;
                if (this.health.diseases && this.health.diseases.chalkbroodLevel > 0) healthImpact += this.health.diseases.chalkbroodLevel * 2;

                this.health.overall = Math.max(0, 100 - healthImpact);
                if (this.queen && this.health.overall < 30 && Math.random() < 0.1) { 
                    this.queen.health = Math.max(0, this.queen.health - 20);
                     UIManager.showToast("Queen Health Declining!", `The queen in ${this.name} is suffering due to poor hive health.`, "warning");
                }
            }
            
            updateSwarmingUrge(season) {
                if (this.isEmptyHiveBody || !this.queen) { this.swarmingUrge = 0; return; }
                
                this.swarmingUrge *= 0.95; 

                if (season === SEASONS.SPRING || season === SEASONS.SUMMER) {
                    if (this.population.total > 35000) this.swarmingUrge += 5; 
                    if (this.queen.age > 365 * 1.5) this.swarmingUrge += 3; 
                    
                    const drawnFrames = this.frames.filter(f => f.type === 'drawn_comb').length;
                    const fullFrames = this.frames.filter(f => f.coveragePercent >= 90 && (f.content === 'honey' || f.content === 'pupae')).length;
                    const availableLayingCells = this.frames.reduce((sum, f) => {
                        if (f.type === 'drawn_comb' && f.content === null) sum += (100 - f.coveragePercent);
                        return sum;
                    }, 0);

                    if (fullFrames / FRAMES_PER_HIVE > 0.7) this.swarmingUrge += 10; 
                    else if (drawnFrames / FRAMES_PER_HIVE > 0.9 && availableLayingCells < 100) this.swarmingUrge += 8; 
                } else {
                    this.swarmingUrge -= 10; 
                }
                this.swarmingUrge = Math.max(0, Math.min(100, this.swarmingUrge));

                const existingQueenCells = this.frames.filter(f => f.queenCellPresent).length;
                if (this.swarmingUrge > 70 && existingQueenCells < 2 && Math.random() < 0.2) {
                    const suitableFrames = this.frames.filter(f => f.type === 'drawn_comb' && (f.content === 'eggs' || (f.content === 'larvae' && f.broodAge <=1)) && !f.queenCellPresent);
                    if (suitableFrames.length > 0) {
                        suitableFrames[Math.floor(Math.random() * suitableFrames.length)].queenCellPresent = true;
                        JournalManager.addEntry(`Queen cells spotted in ${this.name}! Swarm risk increasing.`);
                    }
                }


                if (this.swarmingUrge > 90 && existingQueenCells > 0 && Math.random() < 0.25) {
                    this.triggerSwarm();
                }
            }

            triggerSwarm() {
                if (this.isEmptyHiveBody || this.population.total < 5000) return;
                const swarmSize = Math.floor(this.population.total * (Math.random() * 0.3 + 0.4)); 
                const oldQueenLeaves = Math.random() < 0.7 || (this.queen && this.queen.age > 365 * 2); 

                this.population.workers -= Math.floor(swarmSize * (this.population.workers / this.population.total));
                this.population.drones -= Math.floor(swarmSize * (this.population.drones / this.population.total));
                this.population.foragers = Math.floor(this.population.workers * 0.4);
                this.updateTotalPopulation();

                if (oldQueenLeaves && this.queen) {
                    this.queen = null; 
                }
                
                this.frames.forEach(f => { if (Math.random() < 0.3 && f.queenCellPresent) f.queenCellPresent = false; }); 
                this.swarmingUrge = 0;
                JournalManager.addEntry(`Hive ${this.name} swarmed! Lost approx ${swarmSize} bees.`);
                UIManager.showToast("Swarm!", `Hive ${this.name} has swarmed! You lost a significant portion of its population.`, "warning");
                EventManager.triggerSpecificEvent({
                    title: "Hive Swarmed!",
                    text: `${this.name} has swarmed. A portion of the bees ${oldQueenLeaves && !this.queen ? 'and the old queen' : ''} have left. The hive will need time to recover${oldQueenLeaves && !this.queen ? ' and may need a new queen from existing queen cells or introduction' : '. A queen cell may produce a new queen.'}.`,
                    choices: [{text: "Acknowledge", action: null}]
                });
            }
            
            checkForEmergencyQueenRearing() {
                if (this.queen || this.isEmptyHiveBody) return;
                const hasQueenCells = this.frames.some(f => f.queenCellPresent);
                if (hasQueenCells) return; 

                const suitableFramesForQueenCell = this.frames.filter(f => f.type === 'drawn_comb' && (f.content === 'eggs' || (f.content === 'larvae' && f.broodAge <= 2)));
                if (suitableFramesForQueenCell.length > 0 && Math.random() < 0.1) {
                    suitableFramesForQueenCell[Math.floor(Math.random() * suitableFramesForQueenCell.length)].queenCellPresent = true;
                    JournalManager.addEntry(`${this.name} is queenless and attempting to raise an emergency queen.`);
                    UIManager.showToast("Emergency Requeening!", `${this.name} is attempting to raise an emergency queen.`, "info");
                }
            }


            applyTreatment(treatmentId) {
                if (treatmentId === "varroa_treatment_basic") {
                    this.health.varroaMites = Math.floor(this.health.varroaMites * (1 - VARROA_TREATMENT_EFFECTIVENESS));
                    JournalManager.addEntry(`Applied Varroa treatment to ${this.name}.`);
                    UIManager.showToast("Treatment Applied", `Varroa treatment applied to ${this.name}.`, "success");
                    return true;
                }
                return false;
            }

            feed(foodType, amountKg) {
                amountKg = parseFloat(amountKg);
                if (isNaN(amountKg) || amountKg <=0) {
                    UIManager.showToast("Invalid Amount", "Please enter a positive number for feeding.", "warning");
                    return false;
                }

                if (foodType === "sugar_syrup") {
                    this.addResourceToFrames('nectar', amountKg); 
                    JournalManager.addEntry(`Fed ${this.name} ${amountKg.toFixed(1)}kg sugar syrup.`);
                    UIManager.showToast("Feeding Success", `${this.name} fed ${amountKg.toFixed(1)}kg sugar syrup.`, "success");
                    return true;
                } else if (foodType === "pollen_patty") {
                    this.addResourceToFrames('pollen', amountKg * 0.5); 
                    JournalManager.addEntry(`Fed ${this.name} ${amountKg.toFixed(0)} pollen patties.`);
                    UIManager.showToast("Feeding Success", `${this.name} fed ${amountKg.toFixed(0)} pollen patties.`, "success");
                    return true;
                }
                return false;
            }
            
            harvest(product, amountKg) {
                amountKg = parseFloat(amountKg);
                 if (isNaN(amountKg) || amountKg <=0) {
                    UIManager.showToast("Invalid Amount", "Please enter a positive number for harvesting.", "warning");
                    return false;
                 }

                if (product === "honey") {
                    let harvestedAmountKg = 0;
                    for (const frame of this.frames) {
                        if (harvestedAmountKg >= amountKg) break;
                        if (frame.content === 'honey' && frame.isCapped && frame.coveragePercent > 0) {
                            const honeyInFrameKg = (frame.coveragePercent / 100) * FRAME_CAPACITY_KG;
                            const toHarvestFromFrameKg = Math.min(amountKg - harvestedAmountKg, honeyInFrameKg);
                            
                            frame.coveragePercent -= (toHarvestFromFrameKg / FRAME_CAPACITY_KG) * 100;
                            harvestedAmountKg += toHarvestFromFrameKg;
                            
                            if (frame.coveragePercent <= 0) {
                                frame.content = null;
                                frame.isCapped = false;
                                frame.coveragePercent = 0;
                            } else if (frame.coveragePercent < 90) {
                                frame.isCapped = false; 
                            }
                        }
                    }

                    if (harvestedAmountKg > 0) {
                        gameState.inventory.rawHoney = (gameState.inventory.rawHoney || 0) + harvestedAmountKg;
                        JournalManager.addEntry(`Harvested ${harvestedAmountKg.toFixed(1)}kg honey from ${this.name}.`);
                        UIManager.showToast("Honey Harvested!", `${harvestedAmountKg.toFixed(1)}kg honey harvested from ${this.name}.`, "success");
                        return true;
                    } else {
                        UIManager.showToast("Not Enough Honey", `Not enough capped honey in ${this.name} to harvest.`, "warning");
                        return false;
                    }
                }
                 return false;
            }

            performInspection() {
                this.lastInspectionData.day = gameState.dayTotal;
                this.lastInspectionData.queenPresent = !!this.queen && this.queen.health > 0 && !this.queen.isVirgin;
                const broodFrames = this.frames.filter(f => ['eggs', 'larvae', 'pupae'].includes(f.content) && f.coveragePercent > 10).length;
                if (broodFrames > 6) this.lastInspectionData.broodLevel = 'High';
                else if (broodFrames > 3) this.lastInspectionData.broodLevel = 'Medium';
                else if (broodFrames > 0) this.lastInspectionData.broodLevel = 'Low';
                else this.lastInspectionData.broodLevel = 'None';
                this.lastInspectionData.miteCount = this.health.varroaMites;
                const foodFrames = this.frames.filter(f => (f.content === 'honey' || f.content === 'pollen') && f.coveragePercent > 50).length;
                if (foodFrames > 5) this.lastInspectionData.foodStores = 'High';
                else if (foodFrames > 2) this.lastInspectionData.foodStores = 'Medium';
                else this.lastInspectionData.foodStores = 'Low';
                this.lastInspectionData.queenCells = this.frames.filter(f => f.queenCellPresent).length;
                
                this.health.overall = Math.max(0, this.health.overall - 2); 
                this.temperament = Math.random() < 0.1 ? (this.temperament === "Calm" ? "Testy" : "Calm") : this.temperament;
                JournalManager.addEntry(`Inspected ${this.name}.`);
                UIManager.showToast("Inspection Complete", `${this.name} has been inspected.`, "info");
            }

            getDataForDisplay() {
                if (this.isEmptyHiveBody) {
                    return { name: this.name, isEmpty: true, population: 'N/A', honey: 'N/A', pollen: 'N/A', varroa: 'N/A', swarm: 'N/A', health: 'N/A', lastInspected: 'N/A', queenStatus: 'N/A', queenCells: 'N/A' };
                }

                const isStale = (gameState.dayTotal - this.lastInspectionData.day) > INSPECTION_VALIDITY_DAYS || this.lastInspectionData.day === -1;
                let queenStatusText = 'Unknown (Inspect)';
                if (!isStale) {
                    if (this.lastInspectionData.queenPresent && this.queen) {
                        queenStatusText = `Present (Age: ${Math.floor(this.queen.age / 30)} mo, Health: ${this.queen.health}%)`;
                        if (this.queen.isVirgin) queenStatusText += ` (Virgin, mating in ${this.queen.matingFlightCountdown}d)`;
                    } else if (this.queen && this.queen.isVirgin) {
                         queenStatusText = `Virgin Queen (Age: ${Math.floor(this.queen.age / 30)} mo, mating in ${this.queen.matingFlightCountdown}d)`;
                    } else {
                        queenStatusText = 'Not Found/Queenless';
                    }
                } else if (this.queen && this.queen.isVirgin) {
                     queenStatusText = `Virgin Queen (Est., mating in ${this.queen.matingFlightCountdown}d)`;
                }


                if (isStale) {
                    return {
                        name: this.name,
                        isEmpty: false,
                        population: 'Unknown (Inspect)',
                        honey: 'Unknown (Inspect)',
                        pollen: 'Unknown (Inspect)',
                        varroa: 'Unknown (Inspect)',
                        swarm: `${this.swarmingUrge.toFixed(0)}% (Est.)`,
                        health: `${this.health.overall.toFixed(0)}% (Est.)`,
                        lastInspected: this.lastInspectionData.day === -1 ? 'Never' : `Day ${this.lastInspectionData.day} (Stale)`,
                        queenStatus: queenStatusText,
                        queenCells: 'Unknown (Inspect)'
                    };
                }
                return {
                    name: this.name,
                    isEmpty: false,
                    population: this.population.total.toLocaleString(),
                    honey: this.getFrameResourceCount('honey').toFixed(1) + ' kg',
                    pollen: this.getFrameResourceCount('pollen').toFixed(1) + ' kg',
                    varroa: this.lastInspectionData.miteCount.toLocaleString(),
                    swarm: `${this.swarmingUrge.toFixed(0)}%`,
                    health: `${this.health.overall.toFixed(0)}%`,
                    lastInspected: `Day ${this.lastInspectionData.day} (Fresh)`,
                    queenStatus: queenStatusText,
                    queenCells: this.lastInspectionData.queenCells
                };
            }
            
            installColony(type) {
                if (!this.isEmptyHiveBody) return false;

                const item = GameData.marketItems.find(i => i.id === type);
                if (!item || gameState.inventory[type] <= 0) {
                    UIManager.showToast("Not Available", `You don't have any ${item ? item.name : type} in inventory.`, "warning");
                    return false;
                }

                this.isEmptyHiveBody = false;
                this.queen = new Queen();
                if (type === 'bee_package') {
                    this.population = { workers: 8000, drones: 200, foragers: 2000, total: 0 };
                    this.updateTotalPopulation();
                } else if (type === 'nuc_colony') {
                    this.population = { workers: 5000, drones: 100, foragers: 1000, total: 0 };
                    this.updateTotalPopulation();
                    for (let i = 0; i < NUC_FRAME_COUNT; i++) {
                        this.frames[i].type = 'drawn_comb';
                        if (i < 2) { this.frames[i].content = 'larvae'; this.frames[i].coveragePercent = 70; this.frames[i].broodAge = Math.floor(Math.random() * LARVA_TO_PUPA_DAYS); } 
                        else if (i < 3) { this.frames[i].content = 'honey'; this.frames[i].coveragePercent = 80; this.frames[i].isCapped = true; }
                        else { this.frames[i].content = 'pollen'; this.frames[i].coveragePercent = 60; }
                    }
                }
                gameState.inventory[type]--;
                this.performInspection(); 
                JournalManager.addEntry(`Installed a ${item.name} into ${this.name}.`);
                UIManager.showToast("Colony Installed!", `${item.name} successfully installed in ${this.name}.`, "success");
                return true;
            }

            canSplit() {
                if (this.isEmptyHiveBody || !this.queen || this.population.total < 20000) return false;
                const broodFrames = this.frames.filter(f => ['eggs', 'larvae', 'pupae'].includes(f.content) && f.coveragePercent > 30).length;
                const foodFrames = this.frames.filter(f => (f.content === 'honey' || f.content === 'pollen') && f.coveragePercent > 50).length;
                return broodFrames >= 3 && foodFrames >= 2 && gameState.inventory.emptyHiveBodies > 0;
            }

            splitHive(targetHive, selectedFrameIndices) {
                if (!this.canSplit() || !targetHive || !targetHive.isEmptyHiveBody) {
                    UIManager.showToast("Split Failed", "Conditions not met for splitting or target hive invalid.", "danger");
                    return false;
                }
                if (selectedFrameIndices.length < 3 || selectedFrameIndices.length > 5) {
                     UIManager.showToast("Split Failed", "Select 3 to 5 frames for the split.", "warning");
                     return false;
                }
                const hasBrood = selectedFrameIndices.some(idx => ['eggs', 'larvae'].includes(this.frames[idx].content));
                const hasFood = selectedFrameIndices.some(idx => ['honey', 'pollen'].includes(this.frames[idx].content));
                if (!hasBrood || !hasFood) {
                    UIManager.showToast("Split Failed", "Selected frames must include both brood (eggs/larvae) and food (honey/pollen).", "warning");
                    return false;
                }

                selectedFrameIndices.forEach((frameIndex, newFrameSlot) => {
                    targetHive.frames[newFrameSlot] = JSON.parse(JSON.stringify(this.frames[frameIndex]));
                    targetHive.frames[newFrameSlot].id = newFrameSlot; 
                    this.frames[frameIndex] = { id: frameIndex, type: 'foundation', content: null, coveragePercent: 0, isCapped: false, broodAge: 0, queenCellPresent: false }; 
                });
                
                const splitPopulationRatio = 0.4; 
                targetHive.population.workers = Math.floor(this.population.workers * splitPopulationRatio);
                targetHive.population.drones = Math.floor(this.population.drones * splitPopulationRatio);
                targetHive.population.foragers = Math.floor(this.population.foragers * splitPopulationRatio);
                targetHive.updateTotalPopulation();
                targetHive.isEmptyHiveBody = false; 
                targetHive.queen = null; 

                this.population.workers -= targetHive.population.workers;
                this.population.drones -= targetHive.population.drones;
                this.population.foragers -= targetHive.population.foragers;
                this.updateTotalPopulation();
                
                gameState.inventory.emptyHiveBodies--;
                this.performInspection();
                targetHive.performInspection();
                JournalManager.addEntry(`Split ${this.name} into a new hive: ${targetHive.name}.`);
                UIManager.showToast("Hive Split Successful!", `${this.name} was split. ${targetHive.name} is now active.`, "success");
                return true;
            }
            
            introduceNewQueen() {
                if (this.isEmptyHiveBody || this.queen) {
                    UIManager.showToast("Cannot Introduce Queen", "This hive is empty or already has a queen.", "warning");
                    return false;
                }
                if (gameState.inventory.matedQueens <= 0) {
                    UIManager.showToast("No Queens Available", "You do not have any mated queens in your inventory.", "warning");
                    return false;
                }
                this.queen = new Queen();
                gameState.inventory.matedQueens--;
                JournalManager.addEntry(`Introduced a new mated queen to ${this.name}.`);
                UIManager.showToast("Queen Introduced", `A new mated queen has been introduced to ${this.name}.`, "success");
                this.performInspection(); 
                return true;
            }
        }

        const UIManager = {
            currentView: 'apiary-overview',
            activeHiveId: null,

            initializeBootstrapComponents() {
                const componentsToInit = [
                    { id: 'settingsModal', instanceVar: 'settingsModalInstance' },
                    { id: 'eventModal', instanceVar: 'eventModalInstance' },
                    { id: 'confirmationModal', instanceVar: 'confirmationModalInstance' },
                    { id: 'guideDetailModal', instanceVar: 'guideDetailModalInstance' },
                    { id: 'installColonyModal', instanceVar: 'installColonyModalInstance' },
                    { id: 'hiveSplitModal', instanceVar: 'hiveSplitModalInstance' },
                    { id: 'bulkFeedModal', instanceVar: 'bulkFeedModalInstance' },
                    { id: 'bulkTreatModal', instanceVar: 'bulkTreatModalInstance' },
                    { id: 'gameToast', instanceVar: 'gameToastInstance', type: 'Toast' }
                ];
            
                componentsToInit.forEach(comp => {
                    const el = document.getElementById(comp.id);
                    if (el) {
                        try {
                            if (comp.type === 'Toast') {
                                window[comp.instanceVar] = new bootstrap.Toast(el);
                            } else {
                                window[comp.instanceVar] = new bootstrap.Modal(el);
                            }
                        } catch (e) {
                            console.error(`Failed to initialize Bootstrap component ${comp.id}:`, e);
                            window[comp.instanceVar] = null;
                        }
                    } else {
                        console.error(`#${comp.id} element not found.`);
                        window[comp.instanceVar] = null;
                    }
                });
            },
            
            init() {
                DOM.gameVersionDisplay.textContent = GAME_VERSION;
                this._initializeTooltips(document.body);
            },
            
            _initializeTooltips(parentElement = document) {
                try {
                    const tooltipTriggerList = Array.from(parentElement.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.forEach(tooltipTriggerEl => {
                        const existingTooltip = bootstrap.Tooltip.getInstance(tooltipTriggerEl);
                        if (existingTooltip) {
                            existingTooltip.dispose();
                        }
                        new bootstrap.Tooltip(tooltipTriggerEl);
                    });
                } catch (error) {
                    console.error("Error initializing tooltips:", error);
                }
            },

            setActiveNav(targetId) {
                document.querySelectorAll('#sidebar-nav .nav-link').forEach(link => link.classList.remove('active'));
                const activeLink = document.getElementById(targetId);
                if (activeLink) activeLink.classList.add('active');
                
                document.querySelectorAll('#dynamic-hive-nav-list .nav-link').forEach(link => link.classList.remove('active'));
                if (targetId.startsWith('nav-hive-') || (this.currentView === 'hive-detail' && this.activeHiveId)) {
                    const activeHiveLink = document.querySelector(`#dynamic-hive-nav-list .nav-link[data-hiveid="${this.activeHiveId}"]`);
                    if (activeHiveLink) activeHiveLink.classList.add('active');
                }
            },

            updateHeader() {
                try {
                    DOM.beekeeperNameDisplay.textContent = gameState.beekeeperName;
                    DOM.gameDateDisplay.textContent = `${gameState.currentSeason}, Year ${gameState.year}, Day ${gameState.dayInSeason}`;
                    DOM.playerMoneyDisplay.textContent = `$${gameState.money.toFixed(2)}`;
                    DOM.playerMoneyDisplay.classList.toggle('text-danger', gameState.money < 0);
                    DOM.playerMoneyDisplay.classList.toggle('text-success', gameState.money >= 0);

                    DOM.footerSeasonDisplay.textContent = gameState.currentSeason;
                    DOM.footerWeatherDisplay.textContent = gameState.currentWeather;
                    
                    let totalHealth = 0;
                    const populatedHives = gameState.hives.filter(h => !h.isEmptyHiveBody && h.population.total > 0);
                    if (populatedHives.length > 0) {
                        populatedHives.forEach(h => totalHealth += h.health.overall);
                        const avgHealth = Math.round(totalHealth / populatedHives.length);
                        DOM.apiaryHealthDisplay.textContent = `${avgHealth}% (${this.getHealthStatusText(avgHealth)})`;
                        DOM.apiaryHealthDisplay.className = "fw-bold"; 
                        if (avgHealth > 80) DOM.apiaryHealthDisplay.classList.add("text-success");
                        else if (avgHealth > 50) DOM.apiaryHealthDisplay.classList.add("text-warning");
                        else DOM.apiaryHealthDisplay.classList.add("text-danger");
                    } else {
                         DOM.apiaryHealthDisplay.textContent = "N/A";
                         DOM.apiaryHealthDisplay.className = "fw-bold text-muted";
                    }

                    const gameHeaderEl = document.getElementById('game-header');
                    if (gameHeaderEl) {
                        ['header-spring', 'header-summer', 'header-autumn', 'header-winter'].forEach(c => gameHeaderEl.classList.remove(c));
                        gameHeaderEl.classList.add(`header-${gameState.currentSeason.toLowerCase()}`);
                    }
                    this.updateInventoryDisplay();

                } catch (error) {
                    console.error("Error updating header:", error);
                }
            },
            
            updateInventoryDisplay() {
                let html = '';
                if (gameState.inventory.emptyHiveBodies > 0) html += `Empty Hives: ${gameState.inventory.emptyHiveBodies}<br>`;
                if (gameState.inventory.beePackages > 0) html += `Bee Packages: ${gameState.inventory.beePackages}<br>`;
                if (gameState.inventory.nucColonies > 0) html += `Nuc Colonies: ${gameState.inventory.nucColonies}<br>`;
                if (gameState.inventory.matedQueens > 0) html += `Mated Queens: ${gameState.inventory.matedQueens}<br>`;
                if (gameState.inventory.sugar > 0) html += `Sugar: ${gameState.inventory.sugar.toFixed(1)} kg<br>`;
                if (gameState.inventory.pollenPatty > 0) html += `Pollen Patties: ${gameState.inventory.pollenPatty}<br>`;
                Object.keys(gameState.inventory).forEach(key => {
                    if (key.startsWith('varroa_treatment_') && gameState.inventory[key] > 0) {
                        const item = GameData.marketItems.find(i => i.id === key);
                        if (item) html += `${item.name}: ${gameState.inventory[key]}<br>`;
                    }
                });
                if (gameState.inventory.rawHoney > 0) html += `Raw Honey: ${gameState.inventory.rawHoney.toFixed(1)} kg<br>`;
                if (gameState.inventory.beeswax > 0) html += `Beeswax: ${gameState.inventory.beeswax.toFixed(1)} g<br>`;
                DOM.inventoryList.innerHTML = html || 'No items in inventory.';
            },

            getHealthStatusText(healthValue) {
                if (healthValue > 90) return "Excellent";
                if (healthValue > 75) return "Good";
                if (healthValue > 50) return "Fair";
                if (healthValue > 25) return "Poor";
                return "Critical";
            },

            updateHiveNavList() {
                try {
                    DOM.dynamicHiveNavList.innerHTML = '';
                    if (!gameState.hives) return;
                    gameState.hives.forEach(hive => {
                        if (!hive) return; 
                        const li = document.createElement('li');
                        li.className = 'nav-item mb-1';
                        const a = document.createElement('a');
                        a.className = `nav-link nav-link-hive text-truncate`;
                        if (this.currentView === 'hive-detail' && this.activeHiveId === hive.id) {
                            a.classList.add('active');
                        }
                        a.href = '#';
                        a.dataset.hiveid = hive.id;
                        const statusText = hive.isEmptyHiveBody ? "(Empty)" : `(H:${hive.health.overall.toFixed(0)}%)`;
                        a.textContent = `${hive.name} ${statusText}`;
                        a.setAttribute('title', `${hive.name} ${statusText}`);
                        a.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.activeHiveId = hive.id;
                            this.currentView = 'hive-detail';
                            this.render();
                        });
                        li.appendChild(a);
                        DOM.dynamicHiveNavList.appendChild(li);
                    });
                    this._initializeTooltips(DOM.dynamicHiveNavList);
                } catch (error) {
                    console.error("Error updating hive nav list:", error);
                }
            },

            render() {
                try {
                    this.updateHeader();
                    this.updateHiveNavList();
                    
                    let targetNavId = `nav-${this.currentView.replace('-','_')}`;
                    if (this.currentView === 'hive-detail' && this.activeHiveId) {
                         targetNavId = `nav-hive-${this.activeHiveId}`; 
                    }
                    this.setActiveNav(targetNavId);

                    switch (this.currentView) {
                        case 'apiary-overview': this.renderApiaryOverview(); break;
                        case 'hive-detail': this.renderHiveDetailView(this.activeHiveId); break;
                        case 'market': this.renderMarket(); break;
                        case 'research': this.renderResearch(); break;
                        case 'guide': this.renderGuide(); break;
                        case 'journal': this.renderJournal(); break;
                        default: DOM.contentPane.innerHTML = '<p>Select an option from the menu.</p>';
                    }
                    this._initializeTooltips(DOM.contentPane);
                } catch (error) {
                    console.error("Error during main render:", error);
                    DOM.contentPane.innerHTML = '<p class="text-danger">A critical error occurred while rendering this view. Please try navigating or resetting the game.</p>';
                    this.showToast("Render Error", "An error occurred displaying content.", "danger");
                }
            },

            renderApiaryOverview() {
                try {
                    let html = `<div class="d-flex justify-content-between align-items-center mb-3">
                                    <h2>Apiary Overview</h2>
                                    <div>
                                        <button class="btn btn-success btn-sm me-2" id="placeEmptyHiveButton" data-bs-toggle="tooltip" title="Place an empty hive from inventory"><i class="bi bi-plus-circle me-1"></i> Place Empty Hive</button>
                                    </div>
                                </div>`;
                    html += `<div class="mb-3 p-3 border rounded bg-dark-subtle">
                                <h5 class="mb-2">Apiary Actions</h5>
                                <button class="btn btn-sm btn-outline-info me-2" id="bulkFeedButton" data-bs-toggle="tooltip" title="Feed multiple hives at once"><i class="bi bi-droplet-fill"></i> Bulk Feed</button>
                                <button class="btn btn-sm btn-outline-warning" id="bulkTreatButton" data-bs-toggle="tooltip" title="Treat multiple hives for Varroa"><i class="bi bi-shield-plus"></i> Bulk Treat Varroa</button>
                             </div>`;
                    html += '<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">';
                    if (!gameState.hives || gameState.hives.length === 0) {
                        html += `<div class="col-12"><p>You have no hives. Place an empty hive from your inventory (if you have one) or buy one from the market.</p></div>`;
                    } else {
                        gameState.hives.forEach(hive => {
                            if (!hive) return; 
                            const displayData = hive.getDataForDisplay();
                            const healthText = displayData.isEmpty ? 'N/A' : this.getHealthStatusText(hive.health.overall);
                            const healthBadgeColor = displayData.isEmpty ? 'secondary' : (hive.health.overall > 70 ? 'success' : hive.health.overall > 40 ? 'warning' : 'danger');
                            const inspectionIcon = displayData.isEmpty ? '' : (displayData.lastInspected.includes('Stale') || displayData.lastInspected.includes('Never') ? '<i class="bi bi-exclamation-triangle-fill text-warning ms-1" title="Data Stale"></i>' : '<i class="bi bi-check-circle-fill text-success ms-1" title="Data Fresh"></i>');
                            const queenCellText = !displayData.isEmpty && displayData.queenCells > 0 ? `<span class="badge bg-info ms-2" title="Queen Cells Present">${displayData.queenCells} QC</span>` : '';
                            
                            html += `
                                <div class="col">
                                    <div class="card h-100 hive-card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0 text-truncate" title="${displayData.name}">${displayData.name} ${displayData.isEmpty ? "(Empty)" : ""}</h5>
                                            <div>
                                                ${queenCellText}
                                                <span class="badge bg-${healthBadgeColor}">${healthText}</span>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <p class="card-text mb-1">Population: <span class="${displayData.population.includes('Unknown') ? 'stat-value-unknown' : 'stat-value'}">${displayData.population}</span></p>
                                            <p class="card-text mb-1">Honey Stores: <span class="${displayData.honey.includes('Unknown') ? 'stat-value-unknown' : 'stat-value'}">${displayData.honey}</span></p>
                                            <p class="card-text mb-1">Pollen Stores: <span class="${displayData.pollen.includes('Unknown') ? 'stat-value-unknown' : 'stat-value'}">${displayData.pollen}</span></p>
                                            <p class="card-text mb-1">Varroa Mites: <span class="${displayData.varroa.includes('Unknown') ? 'stat-value-unknown' : 'stat-value'} ${!displayData.isEmpty && hive.health.varroaMites > 500 ? 'text-danger fw-bold' : !displayData.isEmpty && hive.health.varroaMites > 200 ? 'text-warning' : ''}">${displayData.varroa}</span></p>
                                            <p class="card-text mb-1">Swarm Urge: <span class="${displayData.swarm.includes('Unknown') ? 'stat-value-unknown' : 'stat-value'} ${!displayData.isEmpty && hive.swarmingUrge > 70 ? 'text-danger fw-bold' : !displayData.isEmpty && hive.swarmingUrge > 40 ? 'text-warning' : ''}">${displayData.swarm}</span></p>
                                            <p class="card-text mb-1"><small>Last Inspected: ${displayData.lastInspected} ${inspectionIcon}</small></p>
                                        </div>
                                        <div class="card-footer bg-transparent border-top-0 text-end">
                                            <button class="btn btn-primary btn-sm view-hive-details" data-hiveid="${hive.id}"><i class="bi bi-eye"></i> View Details</button>
                                        </div>
                                    </div>
                                </div>`;
                        });
                    }
                    html += '</div>';
                    DOM.contentPane.innerHTML = html;

                    document.querySelectorAll('.view-hive-details').forEach(button => {
                        button.addEventListener('click', (e) => {
                            this.activeHiveId = parseInt(e.currentTarget.dataset.hiveid);
                            this.currentView = 'hive-detail';
                            this.render();
                        });
                    });
                    
                    const placeEmptyHiveButton = document.getElementById('placeEmptyHiveButton');
                    if (placeEmptyHiveButton) {
                        placeEmptyHiveButton.disabled = gameState.inventory.emptyHiveBodies <= 0;
                        placeEmptyHiveButton.addEventListener('click', () => GameLoopManager.placeEmptyHiveFromInventory());
                    }

                    const bulkFeedBtn = document.getElementById('bulkFeedButton');
                    if (bulkFeedBtn) bulkFeedBtn.addEventListener('click', () => this.showBulkFeedModal());
                    const bulkTreatBtn = document.getElementById('bulkTreatButton');
                    if (bulkTreatBtn) bulkTreatBtn.addEventListener('click', () => this.showBulkTreatModal());


                } catch (error) {
                    console.error("Error rendering apiary overview:", error);
                    DOM.contentPane.innerHTML = '<p class="text-danger">Error displaying apiary overview.</p>';
                }
            },

            renderHiveDetailView(hiveId) {
                try {
                    const hive = gameState.hives.find(h => h.id === hiveId);
                    if (!hive) {
                        DOM.contentPane.innerHTML = '<p class="text-danger">Hive not found. It may have been removed or collapsed.</p>';
                        this.currentView = 'apiary-overview'; 
                        this.activeHiveId = null;
                        this.render();
                        return;
                    }
                    const displayData = hive.getDataForDisplay();
                    const isStale = displayData.lastInspected.includes('Stale') || displayData.lastInspected.includes('Never');

                    const varroaTreatmentItem = GameData.marketItems.find(i=>i.id==='varroa_treatment_basic');
                    const varroaTreatmentCost = varroaTreatmentItem ? varroaTreatmentItem.buyPrice : 'N/A';
                    const sugarItem = GameData.marketItems.find(i=>i.id==='sugar');
                    const sugarCost = sugarItem ? sugarItem.buyPrice : 'N/A';
                    const pollenPattyItem = GameData.marketItems.find(i=>i.id==='pollen_patty');
                    const pollenPattyCost = pollenPattyItem ? pollenPattyItem.buyPrice : 'N/A';

                    let html = `
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2 class="text-truncate" title="${hive.name}">Hive: ${hive.name} ${hive.isEmptyHiveBody ? "(Empty)" : ""} <button class="btn btn-sm btn-outline-secondary ms-2" id="renameHiveBtn" data-bs-toggle="tooltip" title="Rename Hive"><i class="bi bi-pencil-fill"></i></button></h2>
                            <button class="btn btn-sm btn-outline-danger" id="removeHiveBtn" data-hiveid="${hive.id}" data-bs-toggle="tooltip" title="Remove this hive permanently"><i class="bi bi-trash-fill"></i> Remove Hive</button>
                        </div>
                        ${isStale && !hive.isEmptyHiveBody ? `<div class="alert alert-warning d-flex align-items-center" role="alert"><i class="bi bi-exclamation-triangle-fill me-2"></i>Hive data is stale. Perform an inspection for current details.</div>` : ''}
                        <ul class="nav nav-tabs mb-3" id="hiveDetailTabs" role="tablist">
                            <li class="nav-item" role="presentation"><button class="nav-link active" id="summary-tab-${hive.id}" data-bs-toggle="tab" data-bs-target="#summary-${hive.id}" type="button" role="tab">Summary</button></li>
                            <li class="nav-item" role="presentation"><button class="nav-link" id="brood-tab-${hive.id}" data-bs-toggle="tab" data-bs-target="#brood-${hive.id}" type="button" role="tab">Brood Chamber</button></li>
                            <li class="nav-item" role="presentation"><button class="nav-link" id="health-tab-${hive.id}" data-bs-toggle="tab" data-bs-target="#health-${hive.id}" type="button" role="tab">Health & Pests</button></li>
                            <li class="nav-item" role="presentation"><button class="nav-link" id="actions-tab-${hive.id}" data-bs-toggle="tab" data-bs-target="#actions-${hive.id}" type="button" role="tab">Actions</button></li>
                        </ul>
                        <div class="tab-content" id="hiveDetailTabsContent">
                            <div class="tab-pane fade show active" id="summary-${hive.id}" role="tabpanel" aria-labelledby="summary-tab-${hive.id}">
                                <h4>Summary</h4>`;
                    if (hive.isEmptyHiveBody) {
                        html += `<p>This hive body is empty. Use the Actions tab to install a bee package or nuc colony.</p>`;
                    } else {
                        html += ` <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Queen Status:</strong> <span class="${isStale ? 'stat-value-unknown' : 'stat-value'}">${displayData.queenStatus}</span></p>
                                        <p><strong>Temperament:</strong> ${hive.temperament}</p>
                                        <p><strong>Swarm Urge:</strong> <span class="${isStale ? 'stat-value-unknown' : 'stat-value'} ${!isStale && hive.swarmingUrge > 70 ? 'text-danger fw-bold' : !isStale && hive.swarmingUrge > 40 ? 'text-warning' : ''}">${displayData.swarm}</span></p>
                                        <p><strong>Queen Cells Present:</strong> <span class="${isStale ? 'stat-value-unknown' : 'stat-value'} ${!isStale && displayData.queenCells > 0 ? 'text-info fw-bold' : ''}">${isStale ? displayData.queenCells : (displayData.queenCells > 0 ? displayData.queenCells : 'None')}</span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Total Population:</strong> <span class="${isStale ? 'stat-value-unknown' : 'stat-value'}">${displayData.population}</span></p>
                                        ${!isStale ? `<p><small>(Workers: ${hive.population.workers.toLocaleString()}, Drones: ${hive.population.drones.toLocaleString()}, Foragers: ${hive.population.foragers.toLocaleString()})</small></p>` : ''}
                                    </div>
                                </div>
                                <h5>Resources (on frames)</h5>
                                <div class="row">
                                    <div class="col-md-4"><strong>Honey:</strong> <span class="${isStale ? 'stat-value-unknown' : 'stat-value'}">${displayData.honey}</span></div>
                                    <div class="col-md-4"><strong>Pollen:</strong> <span class="${isStale ? 'stat-value-unknown' : 'stat-value'}">${displayData.pollen}</span></div>
                                </div>
                                <p class="mt-2"><small>Last Inspected: ${displayData.lastInspected}</small></p>`;
                    }
                    html += `</div>
                            <div class="tab-pane fade" id="brood-${hive.id}" role="tabpanel" aria-labelledby="brood-tab-${hive.id}">
                                <h4>Brood Chamber Frames</h4>`;
                    if (hive.isEmptyHiveBody) {
                        html += `<p>This hive body is empty. Frames will be shown once a colony is installed.</p>`;
                    } else if (isStale) {
                         html += `<p class="text-warning"><i class="bi bi-eye-slash-fill me-1"></i>Frame details are hidden. Perform an inspection to view current frame status.</p>`;
                    } else {
                        html += `<div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 g-2 mb-3">`; 
                        hive.frames.forEach(frame => {
                            let iconClass = 'bi-square'; 
                            let contentText = frame.type === 'foundation' ? 'Foundation' : 'Drawn Comb';
                            let frameBgClass = frame.type === 'foundation' ? 'frame-slot-foundation' : 'frame-slot-drawn_comb';
                            let broodAgeText = '';

                            if (frame.content) {
                                contentText = frame.content.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                                if (['eggs', 'larvae', 'pupae'].includes(frame.content)) {
                                    broodAgeText = ` (Age: ${frame.broodAge}d)`;
                                }
                                switch(frame.content) {
                                    case 'eggs': iconClass = 'bi-egg-fried'; frameBgClass = 'frame-slot-eggs'; break;
                                    case 'larvae': iconClass = 'bi-record-circle'; frameBgClass = 'frame-slot-larvae'; break;
                                    case 'pupae': iconClass = 'bi-shield-check'; frameBgClass = 'frame-slot-pupae'; break;
                                    case 'honey': iconClass = 'bi-droplet-half'; frameBgClass = 'frame-slot-honey'; break;
                                    case 'pollen': iconClass = 'bi-flower3'; frameBgClass = 'frame-slot-pollen'; break;
                                    default: iconClass = 'bi-grid'; frameBgClass = 'frame-slot-drawn_comb'; break;
                                }
                            } else if (frame.type === 'drawn_comb') {
                                iconClass = 'bi-grid';
                            }
                            const tooltipTitle = `Frame ${frame.id + 1}: ${contentText}${broodAgeText} - ${frame.coveragePercent.toFixed(0)}% ${frame.isCapped ? '(Capped)' : ''} ${frame.queenCellPresent ? 'QUEEN CELL!' : ''}`;
                            html += `<div class="col">
                                        <div class="card card-body p-2 text-center frame-slot ${frameBgClass} ${frame.isCapped ? 'frame-slot-capped' : ''}" 
                                             data-bs-toggle="tooltip" 
                                             title="${tooltipTitle}">
                                            <div class="frame-icon-container mb-1">
                                                <i class="bi ${iconClass}"></i>
                                                ${frame.queenCellPresent ? '<i class="bi bi-award-fill text-warning position-absolute top-0 end-0" title="Queen Cell"></i>' : ''}
                                            </div>
                                            <div class="frame-label small text-truncate">${contentText}</div>
                                            ${frame.type !== 'foundation' ? `
                                            <div class="frame-coverage-bar-container mt-1">
                                                <div class="frame-coverage-fill" style="width: ${frame.coveragePercent.toFixed(0)}%;"></div>
                                            </div>
                                            <div class="frame-coverage-text small">${frame.coveragePercent.toFixed(0)}%</div>
                                            ` : '<div class="small text-muted mt-auto">(Foundation)</div>'}
                                        </div>
                                    </div>`;
                        });
                        html += `</div>`;
                    }
                    html += `</div>
                            <div class="tab-pane fade" id="health-${hive.id}" role="tabpanel" aria-labelledby="health-tab-${hive.id}">
                                <h4>Health & Pests</h4>`;
                    if (hive.isEmptyHiveBody) {
                        html += `<p>This hive body is empty.</p>`;
                    } else {
                       html += `<p><strong>Overall Health:</strong> <span class="${isStale ? 'stat-value-unknown' : 'stat-value'}">${displayData.health}</span></p>
                                <p><strong>Varroa Mite Level:</strong> <span class="${isStale ? 'stat-value-unknown' : 'stat-value'} ${!isStale && hive.health.varroaMites > 500 ? 'text-danger fw-bold' : !isStale && hive.health.varroaMites > 200 ? 'text-warning' : ''}">${displayData.varroa}</span></p>
                                <p><strong>Diseases:</strong> ${isStale ? '<span class="stat-value-unknown">Unknown (Inspect)</span>' : (Object.keys(hive.health.diseases).length > 0 ? Object.entries(hive.health.diseases).map(([k,v])=>`${k}: ${v}`).join(', ') : 'None detected')}</p>`;
                    }
                    html += `</div>
                            <div class="tab-pane fade" id="actions-${hive.id}" role="tabpanel" aria-labelledby="actions-tab-${hive.id}">
                                <h4>Hive Actions</h4>`;
                    if (hive.isEmptyHiveBody) {
                        html += `<button class="btn btn-success me-2" id="installColonyBtn" data-hiveid="${hive.id}"><i class="bi bi-box-arrow-in-down"></i> Install Colony</button>`;
                    } else {
                        html += `<button class="btn btn-info me-2" id="inspectHiveBtn" data-hiveid="${hive.id}" ${isStale ? '' : 'disabled'}><i class="bi bi-search"></i> Inspect Hive ${isStale ? '' : '(Data Fresh)'}</button>
                                 <button class="btn btn-warning me-2" id="treatHiveBtn" data-hiveid="${hive.id}" data-bs-toggle="tooltip" title="Cost: $${varroaTreatmentCost}"><i class="bi bi-shield-plus"></i> Treat Varroa</button>
                                 <hr>
                                 <h5>Feeding</h5>
                                 <div class="input-group input-group-sm mb-2" style="max-width: 300px;">
                                    <input type="number" class="form-control" id="feedAmountSugar-${hive.id}" value="1" min="0.1" step="0.1">
                                    <button class="btn btn-outline-secondary" id="feedSugarBtn-${hive.id}" data-bs-toggle="tooltip" title="Cost: $${(sugarCost * 1).toFixed(2)}/kg (approx)"><i class="bi bi-droplet"></i> Feed Sugar Syrup</button>
                                 </div>
                                 <div class="input-group input-group-sm mb-3" style="max-width: 300px;">
                                    <input type="number" class="form-control" id="feedAmountPollen-${hive.id}" value="1" min="1" step="1">
                                    <button class="btn btn-outline-secondary" id="feedPollenBtn-${hive.id}" data-bs-toggle="tooltip" title="Cost: $${(pollenPattyCost * 1).toFixed(2)}/patty"><i class="bi bi-flower1"></i> Feed Pollen Patty</button>
                                 </div>
                                 <hr>
                                 <h5>Management</h5>
                                 <button class="btn btn-success me-2" id="harvestHoneyBtn-${hive.id}" data-bs-toggle="tooltip" title="Harvest capped honey frames"><i class="bi bi-bucket"></i> Harvest Honey (1kg)</button>
                                 <button class="btn btn-primary me-2" id="splitHiveBtn" data-hiveid="${hive.id}" ${hive.canSplit() ? '' : 'disabled'} data-bs-toggle="tooltip" title="${hive.canSplit() ? 'Split this strong hive' : 'Hive not strong enough or no empty hive body available'}"><i class="bi bi-subtract"></i> Split Hive</button>
                                 <button class="btn btn-info" id="introduceQueenBtn" data-hiveid="${hive.id}" ${!hive.queen && gameState.inventory.matedQueens > 0 ? '' : 'disabled'} data-bs-toggle="tooltip" title="${!hive.queen && gameState.inventory.matedQueens > 0 ? 'Introduce a new mated queen' : (hive.queen ? 'Hive has a queen' : 'No mated queens in inventory')}"><i class="bi bi-person-plus-fill"></i> Introduce Queen</button>`;
                    }
                    html += `</div>
                        </div>`;

                    DOM.contentPane.innerHTML = html;

                    if (document.getElementById('renameHiveBtn')) {
                        document.getElementById('renameHiveBtn').addEventListener('click', () => {
                            const newName = prompt(`Enter new name for ${hive.name}:`, hive.name);
                            if (newName && newName.trim() !== "" && newName.length <= MAX_HIVE_NAME_LENGTH) {
                                hive.name = newName.trim();
                                JournalManager.addEntry(`Renamed hive ${hive.id} to ${hive.name}.`);
                                this.render();
                            } else if (newName !== null) {
                                UIManager.showToast("Invalid Name", `Hive name cannot be empty and must be ${MAX_HIVE_NAME_LENGTH} characters or less.`, "warning");
                            }
                        });
                    }
                    if (document.getElementById('removeHiveBtn')) {
                        document.getElementById('removeHiveBtn').addEventListener('click', (e) => {
                            const hiveIdToRemove = parseInt(e.currentTarget.dataset.hiveid);
                            UIManager.showConfirmation(`Are you sure you want to permanently remove ${hive.name}? This cannot be undone.`, () => {
                                GameLoopManager.removeHive(hiveIdToRemove);
                            });
                        });
                    }

                    if (hive.isEmptyHiveBody) {
                        if (document.getElementById('installColonyBtn')) {
                            document.getElementById('installColonyBtn').addEventListener('click', () => this.showInstallColonyModal(hive.id));
                        }
                    } else {
                        if (document.getElementById('inspectHiveBtn')) {
                            document.getElementById('inspectHiveBtn').addEventListener('click', (e) => {
                                hive.performInspection();
                                this.render();
                            });
                        }
                        if (document.getElementById('treatHiveBtn')) {
                            document.getElementById('treatHiveBtn').addEventListener('click', () => {
                                const treatmentItem = GameData.marketItems.find(i => i.id === 'varroa_treatment_basic');
                                if (!treatmentItem) return;
                                if (gameState.inventory.varroa_treatment_basic > 0) {
                                    UIManager.showConfirmation(`Treat ${hive.name} for Varroa mites? This will use 1 treatment from inventory.`, () => {
                                        if (hive.applyTreatment('varroa_treatment_basic')) {
                                           gameState.inventory.varroa_treatment_basic--;
                                           this.render();
                                        }
                                    });
                                } else {
                                    UIManager.showToast("No Treatment", "You have no Varroa treatments in inventory. Buy some from the market.", "warning");
                                }
                            });
                        }
                        if (document.getElementById(`feedSugarBtn-${hive.id}`)) {
                            document.getElementById(`feedSugarBtn-${hive.id}`).addEventListener('click', () => {
                                const amount = parseFloat(document.getElementById(`feedAmountSugar-${hive.id}`).value);
                                if (gameState.inventory.sugar >= amount) {
                                    hive.feed('sugar_syrup', amount);
                                    gameState.inventory.sugar -= amount;
                                    this.render();
                                } else {
                                    UIManager.showToast("Not Enough Sugar", `You need ${amount.toFixed(1)}kg sugar, but only have ${gameState.inventory.sugar.toFixed(1)}kg. Buy more from the market.`, "warning");
                                }
                            });
                        }
                        if (document.getElementById(`feedPollenBtn-${hive.id}`)) {
                            document.getElementById(`feedPollenBtn-${hive.id}`).addEventListener('click', () => {
                                const amount = parseInt(document.getElementById(`feedAmountPollen-${hive.id}`).value);
                                if (gameState.inventory.pollenPatty >= amount) {
                                    hive.feed('pollen_patty', amount);
                                    gameState.inventory.pollenPatty -= amount;
                                    this.render();
                                } else {
                                    UIManager.showToast("Not Enough Pollen Patties", `You need ${amount} patties, but only have ${gameState.inventory.pollenPatty}. Buy more from the market.`, "warning");
                                }
                            });
                        }
                        if (document.getElementById(`harvestHoneyBtn-${hive.id}`)) {
                            document.getElementById(`harvestHoneyBtn-${hive.id}`).addEventListener('click', () => {
                                if (hive.harvest('honey', 1)) {
                                    this.render();
                                }
                            });
                        }
                        if (document.getElementById('splitHiveBtn')) {
                           document.getElementById('splitHiveBtn').addEventListener('click', () => this.showHiveSplitModal(hive.id));
                        }
                        if (document.getElementById('introduceQueenBtn')) {
                            document.getElementById('introduceQueenBtn').addEventListener('click', () => {
                                if (hive.introduceNewQueen()) {
                                    this.render();
                                }
                            });
                        }
                    }

                } catch (error) {
                    console.error("Error rendering hive detail view:", error);
                    DOM.contentPane.innerHTML = '<p class="text-danger">Error displaying hive details.</p>';
                }
            },
            
            renderMarket() {
                try {
                    let html = `<h2>Market</h2>
                                <p>Buy supplies and equipment, or sell your hive products.</p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h4>Buy Items</h4>
                                        <div class="list-group">`;
                    GameData.marketItems.filter(item => item.buyPrice !== null).forEach(item => {
                        html += `<div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${item.name}</strong> - $${item.buyPrice.toFixed(2)}
                                        <small class="d-block text-muted">${item.description}</small>
                                    </div>
                                    <button class="btn btn-success btn-sm buy-item" data-itemid="${item.id}"><i class="bi bi-cart-plus"></i> Buy</button>
                                 </div>`;
                    });
                    html += `       </div>
                                </div>
                                <div class="col-md-6">
                                    <h4>Sell Products</h4>
                                    <div class="list-group">`;
                    GameData.marketItems.filter(item => item.sellPriceBase !== null).forEach(item => {
                        const currentSellPrice = MarketManager.getCurrentSellPrice(item.id);
                        const inventoryAmount = gameState.inventory[item.id] || (item.id === 'rawHoney' ? gameState.inventory.rawHoney : item.id === 'beeswax' ? gameState.inventory.beeswax : 0);
                        html += `<div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${item.name}</strong> - Current Price: $${currentSellPrice.toFixed(2)}
                                        <small class="d-block text-muted">You have: ${inventoryAmount.toFixed(item.id === 'rawHoney' || item.id === 'beeswax' ? 1:0)} ${item.id === 'beeswax' ? 'g' : item.id === 'rawHoney' ? 'kg' : 'units'}</small>
                                    </div>
                                    <button class="btn btn-primary btn-sm sell-item" data-itemid="${item.id}" ${inventoryAmount > 0 ? '' : 'disabled'}><i class="bi bi-cash-coin"></i> Sell 1 unit</button>
                                 </div>`;
                    });
                    html += `       </div>
                                </div>
                            </div>`;
                    DOM.contentPane.innerHTML = html;

                    document.querySelectorAll('.buy-item').forEach(button => {
                        button.addEventListener('click', (e) => MarketManager.buyItem(e.currentTarget.dataset.itemid));
                    });
                    document.querySelectorAll('.sell-item').forEach(button => {
                        button.addEventListener('click', (e) => MarketManager.sellItem(e.currentTarget.dataset.itemid, 1));
                    });
                } catch (error) {
                    console.error("Error rendering market:", error);
                    DOM.contentPane.innerHTML = '<p class="text-danger">Error displaying market.</p>';
                }
            },

            renderResearch() {
                try {
                    let html = `<h2>Knowledge & Upgrades</h2>
                                <p>Invest money to unlock new beekeeping techniques and bonuses. Current Research Points: ${gameState.researchPoints}</p>
                                <div class="list-group">`;
                    GameData.researchNodes.forEach(node => {
                        const isUnlocked = gameState.unlockedResearch.includes(node.id);
                        const canAfford = gameState.money >= node.cost;
                        const prereqMet = node.prereq ? gameState.unlockedResearch.includes(node.prereq) : true;
                        html += `<div class="list-group-item ${isUnlocked ? 'list-group-item-success' : ''}">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">${node.name} ${isUnlocked ? '<span class="badge bg-success">Unlocked</span>' : ''}</h5>
                                        <small>${isUnlocked ? 'Researched' : `Cost: $${node.cost}`}</small>
                                    </div>
                                    <p class="mb-1">${node.description}</p>
                                    ${!isUnlocked && prereqMet ? `<button class="btn btn-primary btn-sm research-node" data-nodeid="${node.id}" ${canAfford ? '' : 'disabled'}>Research</button>` : ''}
                                    ${!prereqMet ? `<small class="text-muted">Requires: ${GameData.researchNodes.find(n=>n.id===node.prereq)?.name || 'Unknown'}</small>` : ''}
                                 </div>`;
                    });
                    html += `</div>`;
                    DOM.contentPane.innerHTML = html;

                    document.querySelectorAll('.research-node').forEach(button => {
                        button.addEventListener('click', (e) => ResearchManager.unlockNode(e.currentTarget.dataset.nodeid));
                    });
                } catch (error) {
                    console.error("Error rendering research:", error);
                    DOM.contentPane.innerHTML = '<p class="text-danger">Error displaying research tree.</p>';
                }
            },
            
            renderGuide() {
                try {
                    let html = `<h2>Beekeeper's Almanac</h2>
                                <p>Your comprehensive guide to beekeeping. Click an entry to learn more.</p>
                                <div class="row">`;
                     GameData.guideContent.forEach(entry => {
                        html += `<div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h5 class="card-title">${entry.title}</h5>
                                            <p class="card-text">${entry.shortDesc}</p>
                                            <button class="btn btn-sm btn-outline-info view-guide-entry" data-entryid="${entry.id}">Read More</button>
                                        </div>
                                    </div>
                                 </div>`;
                    });
                    html += `</div>`;
                    DOM.contentPane.innerHTML = html;

                    document.querySelectorAll('.view-guide-entry').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const entryId = e.currentTarget.dataset.entryid;
                            const entry = GameData.guideContent.find(item => item.id === entryId);
                            if (entry && guideDetailModalInstance) {
                                DOM.guideDetailModal.title.textContent = entry.title;
                                DOM.guideDetailModal.body.innerHTML = entry.fullContentHTML;
                                guideDetailModalInstance.show();
                            } else if (!guideDetailModalInstance) {
                                console.error("guideDetailModalInstance is null");
                            }
                        });
                    });
                } catch (error) {
                    console.error("Error rendering guide:", error);
                    DOM.contentPane.innerHTML = '<p class="text-danger">Error displaying the Almanac.</p>';
                }
            },
            
            renderJournal() {
                try {
                    let html = `<h2>Beekeeper's Journal</h2>
                                <p>A log of important events and observations in your apiary.</p>
                                <div class="list-group journal-list">`;
                    if (gameState.journal.length === 0) {
                        html += '<p class="text-muted">No entries yet.</p>';
                    } else {
                        [...gameState.journal].reverse().forEach(entry => {
                             html += `<div class="list-group-item">
                                        <small class="text-muted">Year ${entry.year}, ${entry.season}, Day ${entry.dayInSeason}</small>
                                        <p class="mb-0">${entry.message}</p>
                                     </div>`;
                        });
                    }
                    html += `</div>`;
                    DOM.contentPane.innerHTML = html;
                } catch (error) {
                    console.error("Error rendering journal:", error);
                    DOM.contentPane.innerHTML = '<p class="text-danger">Error displaying journal.</p>';
                }
            },

            showToast(title, message, type = 'info') {
                if (!gameToastInstance) {
                    console.warn("gameToastInstance is not initialized. Toast not shown. Message:", title, message);
                    alert(`${title}: ${message}`); 
                    return;
                }
                try {
                    DOM.toast.title.textContent = title;
                    DOM.toast.body.textContent = message;
                    
                    const toastEl = document.getElementById('gameToast');
                    toastEl.classList.remove('text-bg-primary', 'text-bg-secondary', 'text-bg-success', 'text-bg-danger', 'text-bg-warning', 'text-bg-info', 'text-bg-light', 'text-bg-dark');
                    let bgClass = 'text-bg-info';
                    switch(type) {
                        case 'success': bgClass = 'text-bg-success'; break;
                        case 'warning': bgClass = 'text-bg-warning'; break;
                        case 'danger': bgClass = 'text-bg-danger'; break;
                        case 'primary': bgClass = 'text-bg-primary'; break;
                    }
                    toastEl.classList.add(bgClass);
                    gameToastInstance.show();
                } catch (error) {
                    console.error("Error showing toast:", error);
                }
            },
            
            showConfirmation(message, onConfirm) {
                if (!confirmationModalInstance) {
                    console.warn("confirmationModalInstance not initialized. Confirmation not shown.");
                    if(confirm(message)) onConfirm();
                    return;
                }
                DOM.confirmationModal.body.textContent = message;
                DOM.confirmationModal.confirmButton.onclick = () => {
                    onConfirm();
                    confirmationModalInstance.hide();
                };
                confirmationModalInstance.show();
            },

            showInstallColonyModal(hiveId) {
                if (!installColonyModalInstance) { console.warn("installColonyModalInstance not initialized."); return; }
                const hive = gameState.hives.find(h => h.id === hiveId);
                if (!hive || !hive.isEmptyHiveBody) return;

                let optionsHtml = '';
                const availableColonies = GameData.marketItems.filter(item => (item.id === 'bee_package' || item.id === 'nuc_colony') && gameState.inventory[item.id] > 0);

                if (availableColonies.length > 0) {
                    availableColonies.forEach(item => {
                        optionsHtml += `<div class="form-check">
                                          <input class="form-check-input" type="radio" name="colonyType" id="colony-${item.id}" value="${item.id}">
                                          <label class="form-check-label" for="colony-${item.id}">
                                            ${item.name} (You have: ${gameState.inventory[item.id]}) - <small>${item.description}</small>
                                          </label>
                                        </div>`;
                    });
                    DOM.installColonyModal.optionsContainer.innerHTML = optionsHtml;
                    DOM.installColonyModal.noOptionsText.classList.add('d-none');
                    DOM.installColonyModal.confirmButton.disabled = false;
                } else {
                    DOM.installColonyModal.optionsContainer.innerHTML = '';
                    DOM.installColonyModal.noOptionsText.classList.remove('d-none');
                    DOM.installColonyModal.confirmButton.disabled = true;
                }
                
                DOM.installColonyModal.confirmButton.onclick = () => {
                    const selectedType = document.querySelector('input[name="colonyType"]:checked');
                    if (selectedType) {
                        if (hive.installColony(selectedType.value)) {
                           this.render();
                           installColonyModalInstance.hide();
                        }
                    } else {
                        this.showToast("Selection Required", "Please select a colony type to install.", "warning");
                    }
                };
                installColonyModalInstance.show();
            },

            showHiveSplitModal(hiveId) {
                if (!hiveSplitModalInstance) { console.warn("hiveSplitModalInstance not initialized."); return; }
                const sourceHive = gameState.hives.find(h => h.id === hiveId);
                if (!sourceHive || !sourceHive.canSplit()) {
                    this.showToast("Cannot Split", "This hive is not strong enough to split or you have no empty hive bodies.", "warning");
                    return;
                }

                DOM.hiveSplitModal.sourceHiveName.textContent = sourceHive.name;
                let framesHtml = '';
                sourceHive.frames.forEach(frame => {
                    if (frame.type !== 'foundation') { 
                        let contentText = frame.content ? frame.content.replace('_', ' ') : 'Drawn Comb';
                        if (frame.content && ['eggs', 'larvae', 'pupae'].includes(frame.content)) {
                             contentText += ` (Age: ${frame.broodAge}d)`;
                        }
                        framesHtml += `<div class="col">
                                        <div class="card card-body p-1 frame-slot-selectable text-center" data-frame-id="${frame.id}" style="min-height: 60px;">
                                            <small>Fr ${frame.id + 1}: ${contentText} (${frame.coveragePercent.toFixed(0)}%)
                                            ${frame.queenCellPresent ? '<br><span class="text-warning small">QC</span>' : ''}</small>
                                        </div>
                                     </div>`;
                    }
                });
                DOM.hiveSplitModal.frameSelectionContainer.innerHTML = framesHtml;
                
                let selectedFrames = [];
                DOM.hiveSplitModal.frameSelectionContainer.querySelectorAll('.frame-slot-selectable').forEach(el => {
                    el.addEventListener('click', () => {
                        const frameId = parseInt(el.dataset.frameId);
                        if (selectedFrames.includes(frameId)) {
                            selectedFrames = selectedFrames.filter(id => id !== frameId);
                            el.classList.remove('selected-frame');
                        } else if (selectedFrames.length < 5) {
                            selectedFrames.push(frameId);
                            el.classList.add('selected-frame');
                        }
                        DOM.hiveSplitModal.confirmButton.disabled = selectedFrames.length < 3 || selectedFrames.length > 5;
                        DOM.hiveSplitModal.confirmButton.textContent = `Confirm Split (${selectedFrames.length} selected)`;
                    });
                });
                DOM.hiveSplitModal.confirmButton.disabled = true;
                DOM.hiveSplitModal.confirmButton.textContent = `Confirm Split (0 selected)`;

                DOM.hiveSplitModal.confirmButton.onclick = () => {
                    const newHive = GameLoopManager.addHive(true); 
                    if (newHive && sourceHive.splitHive(newHive, selectedFrames)) {
                        this.currentView = 'hive-detail';
                        this.activeHiveId = newHive.id;
                        this.render();
                        hiveSplitModalInstance.hide();
                    } else {
                        if (newHive) gameState.hives = gameState.hives.filter(h => h.id !== newHive.id); 
                    }
                };
                hiveSplitModalInstance.show();
            },
            
            showBulkFeedModal() {
                if (!bulkFeedModalInstance) { console.warn("bulkFeedModalInstance not initialized."); return; }
                const populatedHives = gameState.hives.filter(h => !h.isEmptyHiveBody);
                let hiveListHtml = '';
                if (populatedHives.length === 0) {
                    hiveListHtml = '<p class="text-muted">No populated hives to feed.</p>';
                    DOM.bulkFeedModal.confirmButton.disabled = true;
                } else {
                    populatedHives.forEach(hive => {
                        hiveListHtml += `<label class="list-group-item">
                                            <input class="form-check-input me-1" type="checkbox" value="${hive.id}" data-hivename="${hive.name}">
                                            ${hive.name} (Pop: ${hive.population.total.toLocaleString()})
                                         </label>`;
                    });
                    DOM.bulkFeedModal.confirmButton.disabled = false;
                }
                DOM.bulkFeedModal.hiveListContainer.innerHTML = hiveListHtml;
                this._updateBulkFeedCost(); 

                DOM.bulkFeedModal.foodTypeSelect.onchange = () => this._updateBulkFeedCost();
                DOM.bulkFeedModal.amountInput.oninput = () => this._updateBulkFeedCost();
                DOM.bulkFeedModal.hiveListContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.onchange = () => this._updateBulkFeedCost();
                });

                DOM.bulkFeedModal.confirmButton.onclick = () => {
                    GameLoopManager.handleApiaryActions('bulkFeed');
                };
                bulkFeedModalInstance.show();
            },

            _updateBulkFeedCost() {
                const foodType = DOM.bulkFeedModal.foodTypeSelect.value;
                const amountPerHive = parseFloat(DOM.bulkFeedModal.amountInput.value) || 0;
                const selectedHives = Array.from(DOM.bulkFeedModal.hiveListContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
                
                let itemKey, itemCost;
                if (foodType === 'sugar_syrup') {
                    itemKey = 'sugar';
                    const sugarMarketItem = GameData.marketItems.find(i => i.id === 'sugar');
                    itemCost = sugarMarketItem ? sugarMarketItem.buyPrice : 0;
                } else { 
                    itemKey = 'pollenPatty';
                    const pollenMarketItem = GameData.marketItems.find(i => i.id === 'pollen_patty');
                    itemCost = pollenMarketItem ? pollenMarketItem.buyPrice : 0;
                }

                const totalCost = selectedHives.length * amountPerHive * itemCost;
                const totalAmountNeeded = selectedHives.length * amountPerHive;
                const availableStock = gameState.inventory[itemKey] || 0;

                DOM.bulkFeedModal.totalCostDisplay.textContent = `$${totalCost.toFixed(2)}`;
                DOM.bulkFeedModal.availableStockDisplay.textContent = `${availableStock.toFixed(foodType === 'sugar_syrup' ? 1 : 0)} ${foodType === 'sugar_syrup' ? 'kg' : 'units'}`;
                DOM.bulkFeedModal.confirmButton.disabled = totalCost > gameState.money || totalAmountNeeded > availableStock || selectedHives.length === 0 || amountPerHive <=0;
            },

            showBulkTreatModal() {
                if (!bulkTreatModalInstance) { console.warn("bulkTreatModalInstance not initialized."); return; }
                
                const treatmentItems = GameData.marketItems.filter(item => item.type === 'treatment');
                let treatmentOptionsHtml = '';
                treatmentItems.forEach(item => {
                    treatmentOptionsHtml += `<option value="${item.id}">${item.name} (Cost: $${item.buyPrice})</option>`;
                });
                DOM.bulkTreatModal.treatmentTypeSelect.innerHTML = treatmentOptionsHtml;

                const populatedHives = gameState.hives.filter(h => !h.isEmptyHiveBody);
                let hiveListHtml = '';
                 if (populatedHives.length === 0) {
                    hiveListHtml = '<p class="text-muted">No populated hives to treat.</p>';
                    DOM.bulkTreatModal.confirmButton.disabled = true;
                } else {
                    populatedHives.forEach(hive => {
                        hiveListHtml += `<label class="list-group-item">
                                            <input class="form-check-input me-1" type="checkbox" value="${hive.id}" data-hivename="${hive.name}">
                                            ${hive.name} (Varroa: ${hive.health.varroaMites.toLocaleString()})
                                         </label>`;
                    });
                     DOM.bulkTreatModal.confirmButton.disabled = false;
                }
                DOM.bulkTreatModal.hiveListContainer.innerHTML = hiveListHtml;
                this._updateBulkTreatCost();

                DOM.bulkTreatModal.treatmentTypeSelect.onchange = () => this._updateBulkTreatCost();
                DOM.bulkTreatModal.hiveListContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.onchange = () => this._updateBulkTreatCost();
                });
                
                DOM.bulkTreatModal.confirmButton.onclick = () => {
                    GameLoopManager.handleApiaryActions('bulkTreat');
                };
                bulkTreatModalInstance.show();
            },
            
            _updateBulkTreatCost() {
                const treatmentId = DOM.bulkTreatModal.treatmentTypeSelect.value;
                const selectedHives = Array.from(DOM.bulkTreatModal.hiveListContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
                const treatmentItem = GameData.marketItems.find(item => item.id === treatmentId);
                
                if (!treatmentItem) {
                    DOM.bulkTreatModal.totalCostDisplay.textContent = '$0.00';
                    DOM.bulkTreatModal.availableStockDisplay.textContent = '0';
                    DOM.bulkTreatModal.confirmButton.disabled = true;
                    return;
                }

                const totalCost = selectedHives.length * treatmentItem.buyPrice;
                const treatmentsNeeded = selectedHives.length;
                const availableTreatments = gameState.inventory[treatmentId] || 0;

                DOM.bulkTreatModal.totalCostDisplay.textContent = `$${totalCost.toFixed(2)}`;
                DOM.bulkTreatModal.availableStockDisplay.textContent = `${availableTreatments}`;
                DOM.bulkTreatModal.confirmButton.disabled = totalCost > gameState.money || treatmentsNeeded > availableTreatments || selectedHives.length === 0;
            }
        };

        const GameLoopManager = {
            isPaused: false,
            gameLoopInterval: null,
            TICKS_PER_DAY: 1, 
            currentTick: 0,

            startGameLoop() {
                this.gameLoopInterval = setInterval(() => {
                    if (!this.isPaused && !gameState.isGameOver) {
                        this.currentTick++;
                        if (this.currentTick >= this.TICKS_PER_DAY) {
                            this.advanceDay();
                            this.currentTick = 0;
                        }
                    }
                }, 1000); 
            },

            togglePause() {
                this.isPaused = !this.isPaused;
                DOM.pauseButtonIcon.className = this.isPaused ? 'bi bi-play-fill' : 'bi bi-pause-fill';
                DOM.pauseButton.setAttribute('data-bs-original-title', this.isPaused ? 'Resume Game' : 'Pause Game');
                DOM.nextDayButton.disabled = this.isPaused;
                UIManager.showToast("Game " + (this.isPaused ? "Paused" : "Resumed"), "", this.isPaused ? "warning" : "info");
            },

            advanceDay() {
                if (gameState.isGameOver) return;

                gameState.dayInSeason++;
                gameState.dayTotal++;

                let daysInSeason = 30; 
                if (gameState.currentSeason === SEASONS.SPRING || gameState.currentSeason === SEASONS.SUMMER) daysInSeason = 30;
                else if (gameState.currentSeason === SEASONS.AUTUMN) daysInSeason = 30;
                else if (gameState.currentSeason === SEASONS.WINTER) daysInSeason = 30; 

                if (gameState.dayInSeason > daysInSeason) {
                    gameState.dayInSeason = 1;
                    if (gameState.currentSeason === SEASONS.SPRING) gameState.currentSeason = SEASONS.SUMMER;
                    else if (gameState.currentSeason === SEASONS.SUMMER) gameState.currentSeason = SEASONS.AUTUMN;
                    else if (gameState.currentSeason === SEASONS.AUTUMN) gameState.currentSeason = SEASONS.WINTER;
                    else if (gameState.currentSeason === SEASONS.WINTER) {
                        gameState.currentSeason = SEASONS.SPRING;
                        gameState.year++;
                        JournalManager.addEntry(`A new year begins! It is now Year ${gameState.year}.`);
                    }
                    JournalManager.addEntry(`The season has changed to ${gameState.currentSeason}.`);
                }

                gameState.currentWeather = WEATHER_TYPES[Math.floor(Math.random() * WEATHER_TYPES.length)];
                
                gameState.hives.forEach(hive => {
                    if (hive && !hive.isEmptyHiveBody) {
                        hive.dailyUpdate(gameState.currentSeason, gameState.currentWeather);
                    }
                });

                MarketManager.updateMarketFluctuations();
                EventManager.checkAndTriggerEvents();
                PersistenceManager.saveGame();
                UIManager.render();

                if (gameState.hives.every(h => h.isEmptyHiveBody || h.population.total <= 0) && gameState.money < GameData.marketItems.find(i=>i.id==='bee_package').buyPrice && gameState.money < GameData.marketItems.find(i=>i.id==='nuc_colony').buyPrice) {
                    this.handleGameOver("All hives lost and no money to buy more bees.");
                }
            },

            addHive(isEmpty = false, name = null) {
                const newHiveId = gameState.nextHiveId++;
                const hiveName = name || `Hive ${newHiveId}`;
                const newHive = new Hive(newHiveId, hiveName, isEmpty);
                gameState.hives.push(newHive);
                UIManager.updateHiveNavList();
                return newHive;
            },

            placeEmptyHiveFromInventory() {
                if (gameState.inventory.emptyHiveBodies > 0) {
                    this.addHive(true);
                    gameState.inventory.emptyHiveBodies--;
                    JournalManager.addEntry(`Placed a new empty hive body.`);
                    UIManager.showToast("Hive Placed", "A new empty hive body has been added to your apiary.", "success");
                    UIManager.render();
                } else {
                    UIManager.showToast("No Hive Bodies", "You don't have any empty hive bodies in your inventory. Buy one from the market.", "warning");
                }
            },
            
            removeHive(hiveId) {
                const hiveToRemove = gameState.hives.find(h => h.id === hiveId);
                if (hiveToRemove) {
                    JournalManager.addEntry(`Removed ${hiveToRemove.name} from the apiary.`);
                    gameState.hives = gameState.hives.filter(h => h.id !== hiveId);
                    if (UIManager.activeHiveId === hiveId) {
                        UIManager.activeHiveId = null;
                        UIManager.currentView = 'apiary-overview';
                    }
                    UIManager.render();
                    UIManager.showToast("Hive Removed", `${hiveToRemove.name} has been removed.`, "info");
                }
            },
            
            handleHiveCollapse(hiveId) {
                const hive = gameState.hives.find(h => h.id === hiveId);
                if (hive && !hive.isEmptyHiveBody) {
                    hive.isEmptyHiveBody = true; 
                    hive.queen = null;
                    hive.population = { workers: 0, drones: 0, foragers: 0, total: 0 };
                    hive.frames.forEach(f => { 
                        f.content = null; f.coveragePercent = 0; f.isCapped = false; f.broodAge = 0; f.queenCellPresent = false;
                        if (f.type !== 'drawn_comb') f.type = 'foundation'; 
                    });
                    
                    JournalManager.addEntry(`Hive ${hive.name} has collapsed! The hive body is now empty but frames may remain.`, "danger");
                    UIManager.showToast("Hive Collapse!", `Colony in ${hive.name} has collapsed!`, "danger");
                    EventManager.triggerSpecificEvent({
                        title: "Hive Collapse!",
                        text: `The colony in ${hive.name} has collapsed due to zero population. The hive body is now empty. You may need to clean frames or install a new colony.`,
                        choices: [{text: "Acknowledge", action: null}]
                    });
                    UIManager.render();
                }
            },
            
            handleApiaryActions(actionType) {
                if (actionType === 'bulkFeed') {
                    const foodType = DOM.bulkFeedModal.foodTypeSelect.value;
                    const amountPerHive = parseFloat(DOM.bulkFeedModal.amountInput.value) || 0;
                    const selectedHiveIds = Array.from(DOM.bulkFeedModal.hiveListContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => parseInt(cb.value));
                    
                    let itemKey, itemCostPerUnit, totalCost = 0, totalAmountNeeded = 0;
                    if (foodType === 'sugar_syrup') {
                        itemKey = 'sugar';
                        const sugarMarketItem = GameData.marketItems.find(i => i.id === 'sugar');
                        itemCostPerUnit = sugarMarketItem ? sugarMarketItem.buyPrice : 0;
                    } else { 
                        itemKey = 'pollenPatty';
                        const pollenMarketItem = GameData.marketItems.find(i => i.id === 'pollen_patty');
                        itemCostPerUnit = pollenMarketItem ? pollenMarketItem.buyPrice : 0;
                    }
                    
                    totalAmountNeeded = selectedHiveIds.length * amountPerHive;
                    totalCost = totalAmountNeeded * itemCostPerUnit;

                    if (totalCost > gameState.money) { UIManager.showToast("Not Enough Money", "Insufficient funds for this bulk action.", "danger"); return; }
                    if (totalAmountNeeded > gameState.inventory[itemKey]) { UIManager.showToast("Not Enough Stock", `Insufficient ${itemKey} in inventory.`, "danger"); return; }
                    
                    let fedCount = 0;
                    selectedHiveIds.forEach(hiveId => {
                        const hive = gameState.hives.find(h => h.id === hiveId);
                        if (hive && !hive.isEmptyHiveBody) {
                            if (hive.feed(foodType, amountPerHive)) fedCount++;
                        }
                    });
                    gameState.money -= totalCost;
                    gameState.inventory[itemKey] -= totalAmountNeeded;
                    JournalManager.addEntry(`Bulk fed ${fedCount} hives with ${foodType}.`);
                    UIManager.showToast("Bulk Feed Complete", `Successfully fed ${fedCount} hives.`, "success");
                    if(bulkFeedModalInstance) bulkFeedModalInstance.hide();
                    UIManager.render();

                } else if (actionType === 'bulkTreat') {
                    const treatmentId = DOM.bulkTreatModal.treatmentTypeSelect.value;
                    const selectedHiveIds = Array.from(DOM.bulkTreatModal.hiveListContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => parseInt(cb.value));
                    const treatmentItem = GameData.marketItems.find(item => item.id === treatmentId);

                    if (!treatmentItem) { UIManager.showToast("Invalid Treatment", "Selected treatment not found.", "danger"); return; }

                    const treatmentsNeeded = selectedHiveIds.length;
                    const totalCost = treatmentsNeeded * treatmentItem.buyPrice;
                    
                    if (totalCost > gameState.money) { UIManager.showToast("Not Enough Money", "Insufficient funds for this bulk action.", "danger"); return; }
                    if (treatmentsNeeded > (gameState.inventory[treatmentId] || 0)) { UIManager.showToast("Not Enough Stock", `Insufficient ${treatmentItem.name} in inventory.`, "danger"); return; }

                    let treatedCount = 0;
                    selectedHiveIds.forEach(hiveId => {
                        const hive = gameState.hives.find(h => h.id === hiveId);
                        if (hive && !hive.isEmptyHiveBody) {
                             if (hive.applyTreatment(treatmentId)) treatedCount++;
                        }
                    });
                    gameState.money -= totalCost;
                    gameState.inventory[treatmentId] = (gameState.inventory[treatmentId] || 0) - treatmentsNeeded;
                    JournalManager.addEntry(`Bulk treated ${treatedCount} hives with ${treatmentItem.name}.`);
                    UIManager.showToast("Bulk Treat Complete", `Successfully treated ${treatedCount} hives.`, "success");
                    if(bulkTreatModalInstance) bulkTreatModalInstance.hide();
                    UIManager.render();
                }
            },

            handleGameOver(reason) {
                gameState.isGameOver = true;
                this.isPaused = true;
                DOM.pauseButton.disabled = true;
                DOM.nextDayButton.disabled = true;
                JournalManager.addEntry(`Game Over: ${reason}`, "danger");
                EventManager.triggerSpecificEvent({
                    title: "Game Over",
                    text: `Unfortunately, your beekeeping operation has come to an end. ${reason} You can reset the game from the settings menu to start anew.`,
                    choices: [{ text: "View Apiary", action: null }]
                });
                UIManager.showToast("Game Over", reason, "danger");
                UIManager.render();
            }
        };

        const MarketManager = {
            priceFluctuations: {}, 

            updateMarketFluctuations() {
                GameData.marketItems.filter(item => item.sellPriceBase !== null).forEach(item => {
                    this.priceFluctuations[item.id] = (Math.random() * 0.4) - 0.2; 
                });
            },

            getCurrentSellPrice(itemId) {
                const item = GameData.marketItems.find(i => i.id === itemId);
                if (!item || item.sellPriceBase === null) return 0;
                const fluctuation = this.priceFluctuations[itemId] || 0;
                return Math.max(0.1, item.sellPriceBase * (1 + fluctuation));
            },

            buyItem(itemId) {
                const item = GameData.marketItems.find(i => i.id === itemId);
                if (!item || item.buyPrice === null) return;

                if (gameState.money >= item.buyPrice) {
                    gameState.money -= item.buyPrice;
                    if (item.type === "equipment" && item.id === "hive_body") {
                        gameState.inventory.emptyHiveBodies = (gameState.inventory.emptyHiveBodies || 0) + 1;
                    } else if (item.type === "livestock") {
                         gameState.inventory[item.id] = (gameState.inventory[item.id] || 0) + 1;
                    } else if (item.type === "treatment") {
                        gameState.inventory[item.id] = (gameState.inventory[item.id] || 0) + 1;
                    } else { 
                        gameState.inventory[item.id] = (gameState.inventory[item.id] || 0) + (item.id === 'sugar' ? 1 : 1); 
                    }
                    JournalManager.addEntry(`Purchased ${item.name} for $${item.buyPrice.toFixed(2)}.`);
                    UIManager.showToast("Purchase Successful", `Bought 1 ${item.name}.`, "success");
                    UIManager.render();
                } else {
                    UIManager.showToast("Not Enough Money", `You need $${item.buyPrice.toFixed(2)} to buy ${item.name}.`, "warning");
                }
            },

            sellItem(itemId, quantity) {
                const item = GameData.marketItems.find(i => i.id === itemId);
                if (!item || item.sellPriceBase === null) return;
                
                let inventoryKey = item.id;
                if (item.id === 'rawHoney') inventoryKey = 'rawHoney';
                else if (item.id === 'beeswax') inventoryKey = 'beeswax';

                const amountInInventory = gameState.inventory[inventoryKey] || 0;

                if (amountInInventory >= quantity) {
                    const sellPrice = this.getCurrentSellPrice(itemId);
                    gameState.money += sellPrice * quantity;
                    gameState.inventory[inventoryKey] -= quantity;
                    JournalManager.addEntry(`Sold ${quantity} ${item.name} for $${(sellPrice * quantity).toFixed(2)}.`);
                    UIManager.showToast("Sale Successful", `Sold ${quantity} ${item.name}.`, "success");
                    UIManager.render();
                } else {
                    UIManager.showToast("Not Enough Stock", `You don't have ${quantity} ${item.name} to sell.`, "warning");
                }
            }
        };

        const ResearchManager = {
            unlockNode(nodeId) {
                const node = GameData.researchNodes.find(n => n.id === nodeId);
                if (!node || gameState.unlockedResearch.includes(nodeId)) return;

                const prereqMet = node.prereq ? gameState.unlockedResearch.includes(node.prereq) : true;
                if (!prereqMet) {
                    UIManager.showToast("Prerequisite Not Met", "You need to research previous technologies first.", "warning");
                    return;
                }
                if (gameState.money >= node.cost) {
                    gameState.money -= node.cost;
                    gameState.unlockedResearch.push(nodeId);
                    Object.assign(gameState.researchEffects, node.effects);
                    JournalManager.addEntry(`Researched ${node.name}.`);
                    UIManager.showToast("Research Complete!", `You have unlocked ${node.name}.`, "success");
                    UIManager.render();
                } else {
                    UIManager.showToast("Not Enough Money", `You need $${node.cost} to research ${node.name}.`, "warning");
                }
            }
        };
        
        const EventManager = {
            checkAndTriggerEvents() {
                GameData.eventDefinitions.forEach(eventDef => {
                    if (eventDef.condition(gameState)) {
                        this.triggerSpecificEvent(eventDef);
                    }
                });
            },
            triggerSpecificEvent(eventDetails) {
                if (!eventModalInstance) { console.warn("eventModalInstance not initialized. Event not shown."); return; }
                DOM.eventModal.title.textContent = eventDetails.title;
                DOM.eventModal.body.innerHTML = `<p>${eventDetails.text}</p>`;
                let footerHtml = '';
                eventDetails.choices.forEach((choice, index) => {
                    footerHtml += `<button type="button" class="btn btn-${choice.style || 'primary'} event-choice-btn" data-index="${index}">${choice.text}</button>`;
                });
                DOM.eventModal.footer.innerHTML = footerHtml;
                
                document.querySelectorAll('.event-choice-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const choiceIndex = parseInt(e.currentTarget.dataset.index);
                        const chosenAction = eventDetails.choices[choiceIndex].action;
                        if (chosenAction) chosenAction(gameState);
                        eventModalInstance.hide();
                        UIManager.render(); 
                    });
                });

                if (eventDetails.effect) {
                    eventDetails.effect(gameState);
                }
                JournalManager.addEntry(`Event: ${eventDetails.title}`);
                eventModalInstance.show();
            }
        };
        
        const JournalManager = {
            addEntry(message, type = "info") {
                gameState.journal.push({
                    message: message,
                    type: type,
                    dayTotal: gameState.dayTotal,
                    dayInSeason: gameState.dayInSeason,
                    season: gameState.currentSeason,
                    year: gameState.year
                });
                if (gameState.journal.length > 100) { 
                    gameState.journal.shift();
                }
            }
        };

        function initializeGame() {
            UIManager.initializeBootstrapComponents();
            UIManager.init();

            if (!PersistenceManager.loadGame()) {
                initializeNewGameState();
                PersistenceManager.saveGame(); 
            }
            
            DOM.settingsModal.beekeeperNameInput.value = gameState.beekeeperName;
            
            document.getElementById('nav-apiary-overview').addEventListener('click', (e) => { e.preventDefault(); UIManager.currentView = 'apiary-overview'; UIManager.activeHiveId = null; UIManager.render(); });
            document.getElementById('nav-market').addEventListener('click', (e) => { e.preventDefault(); UIManager.currentView = 'market'; UIManager.activeHiveId = null; UIManager.render(); });
            document.getElementById('nav-research').addEventListener('click', (e) => { e.preventDefault(); UIManager.currentView = 'research'; UIManager.activeHiveId = null; UIManager.render(); });
            document.getElementById('nav-guide').addEventListener('click', (e) => { e.preventDefault(); UIManager.currentView = 'guide'; UIManager.activeHiveId = null; UIManager.render(); });
            document.getElementById('nav-journal').addEventListener('click', (e) => { e.preventDefault(); UIManager.currentView = 'journal'; UIManager.activeHiveId = null; UIManager.render(); });

            DOM.nextDayButton.addEventListener('click', () => GameLoopManager.advanceDay());
            DOM.pauseButton.addEventListener('click', () => GameLoopManager.togglePause());
            
            DOM.settingsModal.saveButton.addEventListener('click', () => {
                const newName = DOM.settingsModal.beekeeperNameInput.value.trim();
                if (newName && newName.length <= MAX_HIVE_NAME_LENGTH) {
                    gameState.beekeeperName = newName;
                    UIManager.updateHeader();
                    PersistenceManager.saveGame();
                    UIManager.showToast("Settings Saved", "Your settings have been updated.", "success");
                } else {
                     UIManager.showToast("Invalid Name", `Beekeeper name cannot be empty and must be ${MAX_HIVE_NAME_LENGTH} characters or less.`, "warning");
                }
                if(settingsModalInstance) settingsModalInstance.hide();
            });
            DOM.settingsModal.resetButton.addEventListener('click', () => PersistenceManager.resetGameConfirm());

            UIManager.render();
            GameLoopManager.startGameLoop();
        }

        document.addEventListener('DOMContentLoaded', initializeGame);
    })();
    </script>

<!-- Injectable Console Log Copier Snippet -->
<div id="appgen2025ConsoleCopyUtil" style="position: fixed; top: 5px; right: 5px; z-index: 9999; padding: 5px; background-color: rgba(0,0,0,0.7); border-radius: 5px; cursor: default;" title="Copy Console Logs for this Tab">
    <button type="button" style="background: none; border: 1px solid #fff; color: #fff; padding: 3px 8px; font-size: 10px; border-radius: 3px; cursor: pointer;">Copy Logs</button>
</div>
<script>
    (function() {
        const utilContainer = document.getElementById('appgen2025ConsoleCopyUtil');
        if (utilContainer) {
            const originalConsoleLog = console.log; const originalConsoleError = console.error; const originalConsoleWarn = console.warn; const originalConsoleInfo = console.info; const originalConsoleDebug = console.debug;
            const logs = [];
            function formatLog(type, args) {
                const timestamp = new Date().toISOString();
                const message = Array.from(args).map(arg => { try { if (arg instanceof Error) return arg.stack || arg.toString(); if (typeof arg === 'object' && arg !== null) { const getCircularReplacer = () => { const seen = new WeakSet(); return (key, value) => { if (typeof value === "object" && value !== null) { if (seen.has(value)) { return "[Circular]"; } seen.add(value); } return value; }; }; return JSON.stringify(arg, getCircularReplacer(), 2); } return String(arg); } catch (e) { return '[Unserializable Object]'; } }).join(' ');
                return `[${timestamp}] [${type.toUpperCase()}] ${message}`;
            }
            console.log = function(...args) { const formatted = formatLog('log', args); logs.push(formatted); originalConsoleLog.apply(console, args); };
            console.error = function(...args) { const formatted = formatLog('error', args); logs.push(formatted); originalConsoleError.apply(console, args); };
            console.warn = function(...args) { const formatted = formatLog('warn', args); logs.push(formatted); originalConsoleWarn.apply(console, args); };
            console.info = function(...args) { const formatted = formatLog('info', args); logs.push(formatted); originalConsoleInfo.apply(console, args); };
            console.debug = function(...args) { const formatted = formatLog('debug', args); logs.push(formatted); originalConsoleDebug.apply(console, args); };
            window.onerror = function(message, source, lineno, colno, error) { const errorObj = error || {}; const formatted = formatLog('uncaught_error', [message, `at ${source}:${lineno}:${colno}`, errorObj.stack || '(no stack)']); logs.push(formatted); originalConsoleError.call(console, 'Uncaught Error:', message, 'at', source + ':' + lineno + ':' + colno, error); return false; };
            window.onunhandledrejection = function(event) { const reason = event.reason || {}; const formatted = formatLog('unhandled_rejection', [reason.message || reason, reason.stack || '(no stack)']); logs.push(formatted); originalConsoleError.call(console, 'Unhandled Rejection:', event.reason); };
            const copyButton = utilContainer.querySelector('button');
            if (copyButton) {
                copyButton.addEventListener('click', function(e) {
                    e.stopPropagation(); if (logs.length === 0) { alert('No console logs captured yet to copy.'); return; }
                    const logText = logs.join('\n');
                    navigator.clipboard.writeText(logText).then(function() {
                        const originalText = copyButton.textContent; copyButton.textContent = 'Copied!'; copyButton.style.background = '#28a745'; copyButton.style.borderColor = '#28a745';
                        setTimeout(function() { copyButton.textContent = originalText; copyButton.style.background = 'none'; copyButton.style.borderColor = '#fff'; }, 2000);
                        originalConsoleInfo.call(console, 'AppGen2025 Util: Console logs copied to clipboard.');
                    }).catch(function(err) {
                        originalConsoleError.call(console, 'AppGen2025 Util: Failed to copy console logs - ', err.name, err.message);
                        alert('Failed to copy logs. See browser console for details. Logs may be too large or permissions denied.');
                        const originalText = copyButton.textContent; copyButton.textContent = 'Failed!'; copyButton.style.background = '#dc3545'; copyButton.style.borderColor = '#dc3545';
                        setTimeout(function() { copyButton.textContent = originalText; copyButton.style.background = 'none'; copyButton.style.borderColor = '#fff'; }, 3000);
                    });
                });
            }
        } else { console.error('AppGen2025 Util: Container element "appgen2025ConsoleCopyUtil" not found.'); }
    })();
</script>
<!-- End of Injectable Snippet -->

</body>
</html>